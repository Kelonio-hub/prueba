// Configuraci√≥n de la API de Google Gemini (AI Studio)
const API_KEY = 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg';
const BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
const MODELOS_A_PROBAR = [
    'gemini-2.5-flash',         // Prioridad, funcion√≥ antes
    'gemini-2.5-pro',
    'gemini-2.0-flash',
    'gemini-1.5-flash-latest',
    'gemini-1.5-pro-latest'
];
let MODELO_FUNCIONAL = localStorage.getItem('gemini_modelo_funcional') || 'gemini-2.5-flash';
let historialMensajes = [];  // Almacena mensajes para contexto
const cacheRespuestas = JSON.parse(localStorage.getItem('hipatia_cache')) || {};  // Cach√© para sinopsis/rese√±as

// Obtener elementos del DOM
const chatMensajes = document.getElementById('chatMensajes');
const chatInput = document.getElementById('chatInput');

// Funci√≥n para agregar un mensaje al chat
function agregarMensaje(texto, esUsuario = false, esTemporal = false) {
    if (chatMensajes.children.length > 50) {
        chatMensajes.removeChild(chatMensajes.firstChild);
    }
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = `mensaje ${esUsuario ? 'user' : 'bot'}${esTemporal ? ' temporal' : ''}`;
    mensajeDiv.textContent = texto;
    chatMensajes.appendChild(mensajeDiv);
    chatMensajes.scrollTop = chatMensajes.scrollHeight;

    if (!esTemporal) {
        if (esUsuario) {
            historialMensajes.push({ role: 'user', content: texto });
        } else {
            historialMensajes.push({ role: 'assistant', content: texto });
        }
        if (historialMensajes.length > 6) {  // M√°ximo 3 turnos
            historialMensajes = historialMensajes.slice(-6);
        }
    }
    return mensajeDiv;
}

// Funci√≥n para sanitizar entrada del usuario
function sanitizeInput(str) {
    return str ? (DOMPurify ? DOMPurify.sanitize(str) : str.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')) : 'Recomi√©ndame un libro';
}

// Funci√≥n para detectar intenci√≥n
function detectarIntencion(query) {
    const lowerQuery = query.toLowerCase().trim();
    if (lowerQuery.includes('sinopsis') || lowerQuery.includes('resumen')) return 'sinopsis';
    if (lowerQuery.includes('rese√±a') || lowerQuery.includes('cr√≠tica') || lowerQuery.includes('opini√≥n')) return 'rese√±a';
    if (lowerQuery.includes('√©pico') || lowerQuery.includes('fantas√≠a') || lowerQuery.includes('aventura')) return 'recomendacion_fantasia';
    if (lowerQuery.includes('corto') || lowerQuery.includes('breve')) return 'recomendacion_corta';
    if (lowerQuery.includes('poes√≠a') || lowerQuery.includes('poema')) return 'recomendacion_poesia';
    if (lowerQuery.includes('narrativa') || lowerQuery.includes('novela')) return 'recomendacion_narrativa';
    return 'general';
}

// Funci√≥n para buscar en el cat√°logo
function buscarEnCatalogo(query) {
    if (!catalogo || catalogo.length === 0) {
        return [];
    }
    const lowerQuery = query.toLowerCase().trim();
    return catalogo.filter(libro =>
        libro.titulo.toLowerCase().includes(lowerQuery) ||
        libro.autor.toLowerCase().includes(lowerQuery) ||
        libro.categoria.toLowerCase().includes(lowerQuery) ||
        libro.signatura.toLowerCase().includes(lowerQuery) ||
        libro.isbn.toLowerCase().includes(lowerQuery)
    ).slice(0, 3);
}

// Funci√≥n para formatear resultados del cat√°logo
function formatearResultados(resultados) {
    if (!resultados.length) {
        return 'No encontr√© ese libro en el cat√°logo, pero puedo darte una sinopsis o recomendar algo similar. üìñ';
    }
    return resultados.map(libro => `
        - **T√≠tulo**: ${libro.titulo}
          **Autor**: ${libro.autor}
          **Categor√≠a**: ${libro.categoria}
          **Tejuelo**: ${libro.signatura}
          **Disponibles**: ${libro.copiasDisponibles}
    `).join('\n');
}

// Funci√≥n para probar un modelo espec√≠fico
async function probarModelo(modelo, contents) {
    const url = `${BASE_URL}/${modelo}:generateContent?key=${API_KEY}`;
    const requestBody = {
        contents,
        generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 120  // Respuestas m√°s cortas y din√°micas
        }
    };

    console.log(`Enviando solicitud a ${modelo}:`, JSON.stringify(requestBody, null, 2));

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`Error HTTP: ${response.status} - ${errorData.error?.message || 'Solicitud inv√°lida'}`);
        }

        const data = await response.json();
        const respuesta = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text ? 
            data.candidates[0].content.parts[0].text.trim() : null;

        if (respuesta) {
            localStorage.setItem('gemini_modelo_funcional', modelo);
            MODELO_FUNCIONAL = modelo;
            return respuesta;
        }
        return null;
    } catch (error) {
        console.warn(`Modelo ${modelo} fall√≥: ${error.message}`);
        return null;
    }
}

// Funci√≥n para enviar mensaje a la API de Gemini
async function enviarMensaje() {
    const mensaje = sanitizeInput(chatInput.value.trim());
    // Agregar mensaje del usuario al chat
    agregarMensaje(mensaje, true);
    chatInput.value = '';

    // Indicador de escribiendo
    const escribiendoDiv = agregarMensaje('Hipat-IA est√° buscando en la estanter√≠a... üìö', false, true);

    // Detectar intenci√≥n
    const intencion = detectarIntencion(mensaje);
    const esSinopsis = intencion === 'sinopsis';
    const esRese√±a = intencion === 'rese√±a';
    const esRecomendacion = intencion.includes('recomendacion');

    // Verificar cach√© para sinopsis/rese√±as
    const cacheKey = `${intencion}_${mensaje.toLowerCase().replace(/\s+/g, '_')}`;
    if (cacheRespuestas[cacheKey]) {
        escribiendoDiv.remove();
        agregarMensaje(cacheRespuestas[cacheKey]);
        return;
    }

    // Buscar en el cat√°logo
    const resultadosCatalogo = buscarEnCatalogo(mensaje);
    let contexto = '';
    if (resultadosCatalogo.length > 0) {
        contexto = `Resultados del cat√°logo de la Biblioteca Hipatia:\n${formatearResultados(resultadosCatalogo)}\n\n`;
    } else if (!catalogo.length) {
        contexto = 'El cat√°logo no est√° disponible, pero puedo ofrecer sinopsis o recomendaciones generales. ‚ú®\n\n';
    }

    // Resumen del historial si es largo
    const historialResumido = historialMensajes.length > 4 ? 
        `Resumen del historial: El usuario pregunt√≥ sobre ${historialMensajes.filter(m => m.role === 'user').map(m => m.content).join(', ')}. Contin√∫a la conversaci√≥n de forma natural.\n` : 
        historialMensajes.map(msg => `${msg.role === 'user' ? 'Usuario' : 'Hipat-IA'}: ${msg.content}`).join('\n');

    // Preparar el prompt del sistema
    const systemPrompt = `Eres Hipat-IA, una bibliotecaria virtual entusiasta del IES Carpe Diem. 
Responde en espa√±ol con un tono c√°lido, din√°mico y profesional, como una amiga conocedora de libros. Nunca repitas "Hola, soy Hipat-IA". Usa el cat√°logo y el historial para respuestas relevantes y naturales.

**Contexto del cat√°logo**:
${contexto}

**Historial de la conversaci√≥n**:
${historialResumido}

**Instrucciones**:
- **Sinopsis** (e.g., "sinopsis celestina"): Da un resumen breve (80-120 palabras) del libro, usando el cat√°logo si est√° disponible o conocimiento general.
- **Rese√±a** (e.g., "rese√±a don quijote"): Ofrece una opini√≥n cr√≠tica breve (80-120 palabras), destacando importancia y caracter√≠sticas.
- **Recomendaciones**:
  - Para g√©neros (e.g., "narrativa", "poes√≠a", "√©pico"): Sugiere un libro del cat√°logo o un cl√°sico (e.g., "Cien a√±os de soledad" para narrativa, "Veinte poemas de amor" para poes√≠a).
  - Para "corto": Recomienda libros <200 p√°ginas (e.g., "El principito").
  - Para consultas vagas (e.g., "un libro"): Elige un libro popular al azar (rota entre narrativa, poes√≠a, juvenil).
- Responde en 80-120 palabras, con listas o p√°rrafos variados. Usa emojis (üìñ, ‚ú®) para un toque amigable.
- Termina con una pregunta breve, como "¬øOtro libro?" o "¬øM√°s detalles?".
`;

    // Preparar el contents con historial y nuevo mensaje
    const contents = [
        {
            parts: [{ text: systemPrompt }],
            role: 'model'
        },
        ...historialMensajes.map(msg => ({
            parts: [{ text: msg.content }],
            role: msg.role === 'user' ? 'user' : 'model'
        })),
        {
            parts: [{ text: mensaje }],
            role: 'user'
        }
    ];

    let respuesta = null;
    if (!MODELO_FUNCIONAL || MODELO_FUNCIONAL === 'null') {
        showToast('Buscando un modelo de Gemini funcional...', 'warning');
        for (const modelo of MODELOS_A_PROBAR) {
            console.log(`Probando modelo: ${modelo}`);
            respuesta = await probarModelo(modelo, contents);
            if (respuesta) {
                showToast(`¬°Modelo ${modelo} funciona! Us√°ndolo de ahora en adelante.`, 'success');
                break;
            }
        }
        if (!respuesta) {
            escribiendoDiv.remove();
            respuesta = esSinopsis ? 'No pude conectar, pero "La Celestina" de Rojas es un drama tr√°gico sobre amor y enga√±o. ¬øOtro libro? üìñ' :
                     esRese√±a ? 'Sin conexi√≥n, pero "Don Quijote" es una s√°tira genial de Cervantes. ¬øM√°s detalles? ‚ú®' :
                     'No pude conectar. Te recomiendo "El principito", una joya breve y profunda. ¬øOtro g√©nero? üìñ';
        }
    } else {
        console.log(`Usando modelo guardado: ${MODELO_FUNCIONAL}`);
        respuesta = await probarModelo(MODELO_FUNCIONAL, contents);
        if (!respuesta) {
            console.warn(`Modelo guardado ${MODELO_FUNCIONAL} fall√≥, buscando nuevo modelo...`);
            localStorage.removeItem('gemini_modelo_funcional');
            MODELO_FUNCIONAL = null;
            escribiendoDiv.remove();
            return enviarMensaje();
        }
    }

    // Guardar en cach√© si es sinopsis o rese√±a
    if (esSinopsis || esRese√±a) {
        cacheRespuestas[cacheKey] = respuesta;
        localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
    }

    // Remover indicador de escribiendo y agregar respuesta
    escribiendoDiv.remove();
    agregarMensaje(respuesta);
}

// Manejar el evento de enviar mensaje (Enter)
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        enviarMensaje();
    }
});

// Inicializar el chat con un mensaje de bienvenida
document.addEventListener('DOMContentLoaded', () => {
    agregarMensaje('¬°Hola! Soy Hipat-IA, tu bibliotecaria virtual. ¬øBuscas un libro, una sinopsis o algo √©pico? üìñ');
});

// Estilo para el indicador de escribiendo
const style = document.createElement('style');
style.textContent = `
    .mensaje.temporal {
        font-style: italic;
        color: #888;
        opacity: 0.7;
    }
`;
document.head.appendChild(style);