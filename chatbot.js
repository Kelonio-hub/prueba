let catalogo = [];
let estadoChat = 'inicio';
let historialConsultas = [];
let preguntaActual = null;
let puntuacionTotal = 0;
let aciertosConsecutivos = 0;
let categoriaSeleccionada = '';
let autorSeleccionado = '';

const frasesBienvenida = [
    '¬°Qu√© alegr√≠a verte! üòä ¬øQu√© quieres explorar en nuestra biblioteca?',
    '¬°Bienvenid@ a la Biblioteca Hipatia! üìö ¬øC√≥mo te ayudo hoy?',
    '¬°Listo para sumergirte en el mundo de los libros? üòÑ ¬øQu√© buscas?'
];

const frasesProcesando = [
    'Un momento, estoy buscando en los estantes... üìñ',
    'D√©jame consultar el cat√°logo... üïµÔ∏è‚Äç‚ôÄÔ∏è',
    'Buscando la mejor respuesta para ti... üîç'
];

async function cargarCatalogo() {
    try {
        const response = await fetch('./Ejemplares.xml');
        if (!response.ok) throw new Error('No se pudo cargar Ejemplares.xml');
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
        if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
            throw new Error('Error al parsear XML.');
        }
        const libros = {};
        Array.from(xmlDoc.getElementsByTagName('Libro')).forEach(libro => {
            const idDocumento = libro.getAttribute('id_documento');
            const rawCategoria = libro.getElementsByTagName('Descriptor')[0]?.textContent || 'No disponible';
            const categoriaMap = {
                'narrativa': 'Narrativa',
                'poesia': 'Poes√≠a',
                'poes√≠a': 'Poes√≠a',
                'teatro': 'Teatro',
                'literatura inglesa': 'Literatura inglesa',
                'otras materias': 'Otras Materias',
                'comic': 'C√≥mic',
                'c√≥mic': 'C√≥mic'
            };
            const categoria = categoriaMap[rawCategoria.toLowerCase()] || rawCategoria;
            libros[idDocumento] = {
                titulo: libro.getElementsByTagName('Titulo')[0]?.textContent || 'Sin t√≠tulo',
                autor: libro.getElementsByTagName('Autor')[0]?.textContent || 'Desconocido',
                categoria: categoria,
                fechaEdicion: libro.getElementsByTagName('FechaEdicion')[0]?.textContent || 'No disponible'
            };
        });
        const librosAgrupados = {};
        Array.from(xmlDoc.getElementsByTagName('Ejemplar')).forEach(ejemplar => {
            const idRegistro = ejemplar.getAttribute('IdRegistro') || '';
            const libro = libros[idRegistro] || {};
            let signatura1 = ejemplar.getAttribute('Signatura1') || '';
            const signaturaMap = {
                'Narrativa': 'N',
                'Poes√≠a': 'P',
                'Teatro': 'T',
                'Literatura inglesa': 'LI',
                'Otras Materias': 'OM',
                'C√≥mic': 'C'
            };
            signatura1 = signaturaMap[libro.categoria] || signatura1 || '';
            const signatura = `${signatura1}-${ejemplar.getAttribute('Signatura2') || ''}-${ejemplar.getAttribute('Signatura3') || ''}`.trim();
            if (!librosAgrupados[idRegistro]) {
                librosAgrupados[idRegistro] = {
                    titulo: libro.titulo || 'Sin t√≠tulo',
                    autor: libro.autor || 'Desconocido',
                    categoria: libro.categoria || 'No disponible',
                    fechaEdicion: libro.fechaEdicion || 'No disponible',
                    signatura: signatura || 'No disponible',
                    isbn: ejemplar.getAttribute('ISBN') || 'No disponible',
                    fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                    copiasDisponibles: 0,
                    idRegistro: idRegistro
                };
            }
            if (ejemplar.getAttribute('Estado') === '0') {
                librosAgrupados[idRegistro].copiasDisponibles += 1;
            }
        });
        catalogo = Object.values(librosAgrupados);
        if (catalogo.length === 0) throw new Error('El cat√°logo est√° vac√≠o');
    } catch (error) {
        console.error('Error al cargar Ejemplares.xml:', error);
        window.showToast('No se pudo cargar el cat√°logo. Intenta de nuevo m√°s tarde.', 'error');
    }
}

function agregarMensaje(texto, clase, opciones = []) {
    const chatMensajes = document.getElementById('chatMensajes');
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = `mensaje ${clase}`;
    let opcionesHTML = '';
    if (opciones.length > 0) {
        opcionesHTML = opciones.map(op => `
            <button class="chat-option-btn ${op.clase}" onclick="procesarOpcion('${op.accion}')" aria-label="${op.texto}">
                ${op.texto}
            </button>
        `).join('');
    }
    mensajeDiv.innerHTML = `${texto}${opcionesHTML ? '<br>' + opcionesHTML : ''}`;
    chatMensajes.appendChild(mensajeDiv);
    chatMensajes.scrollTop = chatMensajes.scrollHeight;
}

function enviarMensaje() {
    const chatInput = document.getElementById('chatInput');
    const mensaje = chatInput.value.trim();
    if (!mensaje) return;
    agregarMensaje(mensaje, 'user');
    historialConsultas.push({ tipo: 'texto', valor: mensaje });
    chatInput.value = '';
    procesarMensaje(mensaje);
}

function procesarMensaje(mensaje) {
    const mensajeLower = mensaje.toLowerCase().trim();
    if (estadoChat === 'inicio') {
        const opciones = [
            { texto: '1. Recomendaciones üìö', accion: 'recomendaciones', clase: 'recomendaciones' },
            { texto: '2. Buscar un libro üîç', accion: 'buscar', clase: 'buscar' },
            { texto: '3. Juguemos al trivial literario ‚ùì', accion: 'trivial', clase: 'trivial' },
            { texto: '4. Explorar categor√≠as literarias üìñ', accion: 'categorias', clase: 'categorias' },
            { texto: '5. Reservar un libro ‚úÖ', accion: 'reserva', clase: 'reserva' },
            { texto: '6. Solicitar un libro üìù', accion: 'solicitud', clase: 'solicitud' },
            { texto: '7. Ver historial de consultas üïí', accion: 'historial', clase: 'historial' },
            { texto: '8. Ver puntaje total üåü', accion: 'ver_puntaje', clase: 'ver_puntaje' }
        ];
        if (['1', 'recomendaciones'].includes(mensajeLower)) {
            procesarOpcion('recomendaciones');
        } else if (['2', 'buscar'].includes(mensajeLower)) {
            procesarOpcion('buscar');
        } else if (['3', 'trivial'].includes(mensajeLower)) {
            procesarOpcion('trivial');
        } else if (['4', 'categorias'].includes(mensajeLower)) {
            procesarOpcion('categorias');
        } else if (['5', 'reservar'].includes(mensajeLower)) {
            procesarOpcion('reserva');
        } else if (['6', 'solicitar'].includes(mensajeLower)) {
            procesarOpcion('solicitud');
        } else if (['7', 'historial'].includes(mensajeLower)) {
            procesarOpcion('historial');
        } else if (['8', 'puntaje'].includes(mensajeLower)) {
            procesarOpcion('ver_puntaje');
        } else {
            const frase = frasesProcesando[Math.floor(Math.random() * frasesProcesando.length)];
            setTimeout(() => {
                agregarMensaje(`${frase} No entend√≠, por favor selecciona una opci√≥n:`, 'bot', opciones);
            }, 1000);
        }
    } else if (estadoChat === 'recomendaciones') {
        if (['1', 'generales'].includes(mensajeLower)) {
            procesarOpcion('recomendaciones_generales');
        } else if (['2', 'personalizadas'].includes(mensajeLower)) {
            procesarOpcion('recomendaciones_personalizadas');
        } else {
            agregarMensaje('Por favor, selecciona 1 para Generales o 2 para Personalizadas.', 'bot', [
                { texto: '1. Generales', accion: 'recomendaciones_generales', clase: 'recomendaciones_generales' },
                { texto: '2. Personalizadas', accion: 'recomendaciones_personalizadas', clase: 'recomendaciones_personalizadas' }
            ]);
        }
    } else if (estadoChat === 'recomendaciones_personalizadas') {
        if (['1', 'narrativa'].includes(mensajeLower)) {
            categoriaSeleccionada = 'Narrativa';
            procesarOpcion('recomendaciones_categoria');
        } else if (['2', 'poes√≠a'].includes(mensajeLower)) {
            categoriaSeleccionada = 'Poes√≠a';
            procesarOpcion('recomendaciones_categoria');
        } else if (['3', 'teatro'].includes(mensajeLower)) {
            categoriaSeleccionada = 'Teatro';
            procesarOpcion('recomendaciones_categoria');
        } else if (['4', 'c√≥mic'].includes(mensajeLower)) {
            categoriaSeleccionada = 'C√≥mic';
            procesarOpcion('recomendaciones_categoria');
        } else if (['5', 'recientes'].includes(mensajeLower)) {
            procesarOpcion('recomendaciones_recientes');
        } else if (['6', 'autor'].includes(mensajeLower)) {
            procesarOpcion('recomendaciones_por_autor');
        } else {
            agregarMensaje('Por favor, selecciona una categor√≠a v√°lida (1-6).', 'bot', [
                { texto: '1. Narrativa', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '2. Poes√≠a', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '3. Teatro', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '4. C√≥mic', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '5. Libros recientes', accion: 'recomendaciones_recientes', clase: 'recomendaciones_personalizadas' },
                { texto: '6. Por autor', accion: 'recomendaciones_por_autor', clase: 'recomendaciones_personalizadas' }
            ]);
        }
    } else if (estadoChat === 'recomendaciones_por_autor') {
        autorSeleccionado = mensaje;
        procesarOpcion('recomendaciones_autor');
    } else if (estadoChat === 'buscar') {
        procesarOpcion('buscar_confirmar', mensaje);
    } else if (estadoChat === 'reserva') {
        procesarOpcion('reserva_confirmar', mensaje);
    } else if (estadoChat === 'solicitud') {
        procesarOpcion('solicitud_confirmar', mensaje);
    } else if (estadoChat === 'trivial') {
        if (preguntaActual) {
            procesarRespuestaTrivial(mensaje);
        }
    }
}

function procesarOpcion(opcion, parametro = '') {
    const opcionesInicio = [
        { texto: '1. Recomendaciones üìö', accion: 'recomendaciones', clase: 'recomendaciones' },
        { texto: '2. Buscar un libro üîç', accion: 'buscar', clase: 'buscar' },
        { texto: '3. Juguemos al trivial literario ‚ùì', accion: 'trivial', clase: 'trivial' },
        { texto: '4. Explorar categor√≠as literarias üìñ', accion: 'categorias', clase: 'categorias' },
        { texto: '5. Reservar un libro ‚úÖ', accion: 'reserva', clase: 'reserva' },
        { texto: '6. Solicitar un libro üìù', accion: 'solicitud', clase: 'solicitud' },
        { texto: '7. Ver historial de consultas üïí', accion: 'historial', clase: 'historial' },
        { texto: '8. Ver puntaje total üåü', accion: 'ver_puntaje', clase: 'ver_puntaje' }
    ];
    if (opcion === 'recomendaciones') {
        estadoChat = 'recomendaciones';
        setTimeout(() => {
            agregarMensaje('¬øQu√© tipo de recomendaciones quieres? üìö', 'bot', [
                { texto: '1. Generales', accion: 'recomendaciones_generales', clase: 'recomendaciones_generales' },
                { texto: '2. Personalizadas', accion: 'recomendaciones_personalizadas', clase: 'recomendaciones_personalizadas' }
            ]);
        }, 1000);
    } else if (opcion === 'recomendaciones_generales') {
        setTimeout(() => {
            const librosDisponibles = catalogo.filter(libro => libro.copiasDisponibles > 0);
            if (librosDisponibles.length === 0) {
                agregarMensaje('Lo siento, no hay libros disponibles en este momento. üòî', 'bot', opcionesInicio);
            } else {
                const librosAleatorios = librosDisponibles.sort(() => 0.5 - Math.random()).slice(0, 3);
                const mensaje = 'Aqu√≠ tienes algunas recomendaciones generales: üìö<br>' +
                    librosAleatorios.map(libro => `- <strong>${libro.titulo}</strong> por ${libro.autor}, Tejuelo: ${libro.signatura}, Disponibles: ${libro.copiasDisponibles}`).join('<br>');
                agregarMensaje(mensaje, 'bot', opcionesInicio);
            }
            estadoChat = 'inicio';
        }, 1000);
    } else if (opcion === 'recomendaciones_personalizadas') {
        estadoChat = 'recomendaciones_personalizadas';
        setTimeout(() => {
            agregarMensaje('¬øQu√© tipo de libro te interesa? üìñ', 'bot', [
                { texto: '1. Narrativa', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '2. Poes√≠a', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '3. Teatro', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '4. C√≥mic', accion: 'recomendaciones_categoria', clase: 'recomendaciones_personalizadas' },
                { texto: '5. Libros recientes', accion: 'recomendaciones_recientes', clase: 'recomendaciones_personalizadas' },
                { texto: '6. Por autor', accion: 'recomendaciones_por_autor', clase: 'recomendaciones_personalizadas' }
            ]);
        }, 1000);
    } else if (opcion === 'recomendaciones_categoria') {
        setTimeout(() => {
            const librosCategoria = catalogo.filter(libro => libro.categoria === categoriaSeleccionada && libro.copiasDisponibles > 0);
            if (librosCategoria.length === 0) {
                agregarMensaje(`No hay libros disponibles en ${categoriaSeleccionada}. üòî`, 'bot', opcionesInicio);
            } else {
                const librosAleatorios = librosCategoria.sort(() => 0.5 - Math.random()).slice(0, 3);
                const mensaje = `¬°Perfecto para los fans de ${categoriaSeleccionada}! üìñ<br>` +
                    librosAleatorios.map(libro => `- <strong>${libro.titulo}</strong> por ${libro.autor}, Tejuelo: ${libro.signatura}, Disponibles: ${libro.copiasDisponibles}`).join('<br>');
                agregarMensaje(mensaje, 'bot', opcionesInicio);
            }
            estadoChat = 'inicio';
            categoriaSeleccionada = '';
        }, 1000);
    } else if (opcion === 'recomendaciones_recientes') {
        setTimeout(() => {
            const librosRecientes = catalogo.filter(libro => {
                const a√±o = parseInt(libro.fechaEdicion) || 0;
                return a√±o >= new Date().getFullYear() - 5 && libro.copiasDisponibles > 0;
            });
            if (librosRecientes.length === 0) {
                agregarMensaje('No hay libros recientes disponibles. üòî', 'bot', opcionesInicio);
            } else {
                const librosAleatorios = librosRecientes.sort(() => 0.5 - Math.random()).slice(0, 3);
                const mensaje = '¬°Lo m√°s reciente en la biblioteca! üÜï<br>' +
                    librosAleatorios.map(libro => `- <strong>${libro.titulo}</strong> por ${libro.autor}, Tejuelo: ${libro.signatura}, Disponibles: ${libro.copiasDisponibles}`).join('<br>');
                agregarMensaje(mensaje, 'bot', opcionesInicio);
            }
            estadoChat = 'inicio';
        }, 1000);
    } else if (opcion === 'recomendaciones_por_autor') {
        estadoChat = 'recomendaciones_por_autor';
        setTimeout(() => {
            agregarMensaje('Escribe el nombre del autor que te interesa: ‚úçÔ∏è', 'bot');
        }, 1000);
    } else if (opcion === 'recomendaciones_autor') {
        setTimeout(() => {
            const librosAutor = catalogo.filter(libro => libro.autor.toLowerCase().includes(autorSeleccionado.toLowerCase()) && libro.copiasDisponibles > 0);
            if (librosAutor.length === 0) {
                agregarMensaje(`No hay libros disponibles de ${autorSeleccionado}. üòî`, 'bot', opcionesInicio);
            } else {
                const librosAleatorios = librosAutor.sort(() => 0.5 - Math.random()).slice(0, 3);
                const mensaje = `¬°Libros de ${autorSeleccionado}! ‚úçÔ∏è<br>` +
                    librosAleatorios.map(libro => `- <strong>${libro.titulo}</strong>, Tejuelo: ${libro.signatura}, Disponibles: ${libro.copiasDisponibles}`).join('<br>');
                agregarMensaje(mensaje, 'bot', opcionesInicio);
            }
            estadoChat = 'inicio';
            autorSeleccionado = '';
        }, 1000);
    } else if (opcion === 'buscar') {
        estadoChat = 'buscar';
        setTimeout(() => {
            agregarMensaje('Escribe el t√≠tulo, autor, categor√≠a, tejuelo o ISBN del libro que buscas: üîç', 'bot');
        }, 1000);
    } else if (opcion === 'buscar_confirmar') {
        setTimeout(() => {
            const busqueda = parametro.toLowerCase();
            const resultados = catalogo.filter(libro =>
                libro.titulo.toLowerCase().includes(busqueda) ||
                libro.autor.toLowerCase().includes(busqueda) ||
                libro.categoria.toLowerCase().includes(busqueda) ||
                libro.signatura.toLowerCase().includes(busqueda) ||
                libro.isbn.toLowerCase().includes(busqueda)
            );
            if (resultados.length === 0) {
                agregarMensaje('No se encontraron libros con ese criterio. üòî Intenta con otro t√©rmino.', 'bot', opcionesInicio);
            } else {
                const mensaje = '¬°Aqu√≠ est√°n los resultados! üîç<br>' +
                    resultados.map(libro => `- <strong>${libro.titulo}</strong> por ${libro.autor}, Categor√≠a: ${libro.categoria}, Tejuelo: ${libro.signatura}, Disponibles: ${libro.copiasDisponibles}`).join('<br>');
                agregarMensaje(mensaje, 'bot', opcionesInicio);
            }
            historialConsultas.push({ tipo: 'busqueda', valor: busqueda, resultados: resultados.length });
            estadoChat = 'inicio';
        }, 1000);
    } else if (opcion === 'reserva') {
        estadoChat = 'reserva';
        setTimeout(() => {
            agregarMensaje('Escribe el tejuelo del libro que deseas reservar: ‚úÖ', 'bot');
        }, 1000);
    } else if (opcion === 'reserva_confirmar') {
        setTimeout(() => {
            const tejuelo = parametro.trim();
            const libro = catalogo.find(l => l.signatura.toLowerCase() === tejuelo.toLowerCase());
            if (libro && libro.copiasDisponibles > 0) {
                agregarMensaje(`Abriendo el formulario de reserva para <strong>${libro.titulo}</strong>... ¬°Prep√°rate para tu pr√≥xima lectura! ‚úÖ`, 'bot');
                window.open('// Reemplazar url', '_blank');
            } else {
                agregarMensaje('Lo siento, el tejuelo no es v√°lido o no hay copias disponibles. üòî', 'bot', opcionesInicio);
            }
            historialConsultas.push({ tipo: 'reserva', valor: tejuelo });
            estadoChat = 'inicio';
        }, 1000);
    } else if (opcion === 'solicitud') {
        estadoChat = 'solicitud';
        setTimeout(() => {
            agregarMensaje('Escribe el t√≠tulo del libro que deseas solicitar: üìù', 'bot');
        }, 1000);
    } else if (opcion === 'solicitud_confirmar') {
        setTimeout(() => {
            agregarMensaje(`Abriendo el formulario de solicitud para <strong>${parametro}</strong>... ¬°Gracias por tu sugerencia! üìù`, 'bot');
            window.open('// Reemplazar url', '_blank');
            historialConsultas.push({ tipo: 'solicitud', valor: parametro });
            estadoChat = 'inicio';
        }, 1000);
    } else if (opcion === 'categorias') {
        setTimeout(() => {
            const categorias = [...new Set(catalogo.map(libro => libro.categoria))].filter(cat => cat !== 'No disponible');
            if (categorias.length === 0) {
                agregarMensaje('No hay categor√≠as disponibles en este momento. üòî', 'bot', opcionesInicio);
            } else {
                const mensaje = 'Explora estas categor√≠as literarias: üìñ<br>' + categorias.join(', ');
                agregarMensaje(mensaje, 'bot', opcionesInicio);
            }
            historialConsultas.push({ tipo: 'categorias', valor: categorias });
            estadoChat = 'inicio';
        }, 1000);
    } else if (opcion === 'historial') {
        setTimeout(() => {
            if (historialConsultas.length === 0) {
                agregarMensaje('No hay consultas previas. ¬°Empieza explorando! üòä', 'bot', opcionesInicio);
            } else {
                const mensaje = 'Historial de consultas: üïí<br>' +
                    historialConsultas.map((consulta, index) => {
                        if (consulta.tipo === 'busqueda') {
                            return `${index + 1}. B√∫squeda: "${consulta.valor}" (${consulta.resultados} resultados)`;
                        } else if (consulta.tipo === 'reserva') {
                            return `${index + 1}. Reserva: Tejuelo "${consulta.valor}"`;
                        } else if (consulta.tipo === 'solicitud') {
                            return `${index + 1}. Solicitud: "${consulta.valor}"`;
                        } else if (consulta.tipo === 'categorias') {
                            return `${index + 1}. Categor√≠as exploradas: ${consulta.valor.join(', ')}`;
                        } else {
                            return `${index + 1}. Mensaje: "${consulta.valor}"`;
                        }
                    }).join('<br>');
                agregarMensaje(mensaje, 'bot', opcionesInicio);
            }
            estadoChat = 'inicio';
        }, 1000);
    } else if (opcion === 'trivial') {
        estadoChat = 'trivial';
        setTimeout(() => {
            const librosDisponibles = catalogo.filter(libro => libro.copiasDisponibles > 0);
            if (librosDisponibles.length === 0) {
                agregarMensaje('No hay libros disponibles para el trivial. üòî', 'bot', opcionesInicio);
                estadoChat = 'inicio';
                return;
            }
            const libroAleatorio = librosDisponibles[Math.floor(Math.random() * librosDisponibles.length)];
            preguntaActual = {
                pregunta: `Pregunta f√°cil: ¬øQui√©n escribi√≥ <strong>${libroAleatorio.titulo}</strong>? Escribe el nombre del autor.`,
                respuesta: libroAleatorio.autor
            };
            agregarMensaje(preguntaActual.pregunta, 'bot', [
                { texto: '1. S√≠', accion: 'continuar_trivial', clase: 'trivial' },
                { texto: '2. No, mostrar puntuaci√≥n', accion: 'ver_puntaje', clase: 'ver_puntaje' }
            ]);
        }, 1000);
    } else if (opcion === 'continuar_trivial') {
        estadoChat = 'trivial';
        setTimeout(() => {
            const librosDisponibles = catalogo.filter(libro => libro.copiasDisponibles > 0);
            const libroAleatorio = librosDisponibles[Math.floor(Math.random() * librosDisponibles.length)];
            preguntaActual = {
                pregunta: `Pregunta f√°cil: ¬øQui√©n escribi√≥ <strong>${libroAleatorio.titulo}</strong>? Escribe el nombre del autor.`,
                respuesta: libroAleatorio.autor
            };
            agregarMensaje(preguntaActual.pregunta, 'bot', [
                { texto: '1. S√≠', accion: 'continuar_trivial', clase: 'trivial' },
                { texto: '2. No, mostrar puntuaci√≥n', accion: 'ver_puntaje', clase: 'ver_puntaje' }
            ]);
        }, 1000);
    } else if (opcion === 'ver_puntaje') {
        setTimeout(() => {
            agregarMensaje(`¬°Eres un genio literario! üåü Tu puntaje total es: ${puntuacionTotal}.`, 'bot', opcionesInicio);
            estadoChat = 'inicio';
            preguntaActual = null;
        }, 1000);
    }
}

function procesarRespuestaTrivial(respuesta) {
    const respuestaCorrecta = preguntaActual.respuesta.toLowerCase();
    const respuestaUsuario = respuesta.toLowerCase().trim();
    const opcionesInicio = [
        { texto: '1. Recomendaciones üìö', accion: 'recomendaciones', clase: 'recomendaciones' },
        { texto: '2. Buscar un libro üîç', accion: 'buscar', clase: 'buscar' },
        { texto: '3. Juguemos al trivial literario ‚ùì', accion: 'trivial', clase: 'trivial' },
        { texto: '4. Explorar categor√≠as literarias üìñ', accion: 'categorias', clase: 'categorias' },
        { texto: '5. Reservar un libro ‚úÖ', accion: 'reserva', clase: 'reserva' },
        { texto: '6. Solicitar un libro üìù', accion: 'solicitud', clase: 'solicitud' },
        { texto: '7. Ver historial de consultas üïí', accion: 'historial', clase: 'historial' },
        { texto: '8. Ver puntaje total üåü', accion: 'ver_puntaje', clase: 'ver_puntaje' }
    ];
    setTimeout(() => {
        if (respuestaUsuario === respuestaCorrecta) {
            aciertosConsecutivos++;
            puntuacionTotal += 5;
            let mensaje = `¬°Genial, +5 puntos! üìñ Puntuaci√≥n: ${puntuacionTotal}. ¬øSab√≠as que ${preguntaActual.respuesta} es conocido por su estilo √∫nico?`;
            if (aciertosConsecutivos >= 3) {
                puntuacionTotal += 30;
                aciertosConsecutivos = 0;
                mensaje += `<br>¬°Incre√≠ble, tres aciertos seguidos! üéâ +30 puntos extra. Puntuaci√≥n: ${puntuacionTotal}.`;
            }
            mensaje += '<br>¬øOtra pregunta?';
            agregarMensaje(mensaje, 'bot', [
                { texto: '1. S√≠', accion: 'continuar_trivial', clase: 'trivial' },
                { texto: '2. No, mostrar puntuaci√≥n', accion: 'ver_puntaje', clase: 'ver_puntaje' }
            ]);
        } else {
            aciertosConsecutivos = 0;
            const mensaje = `¬°Vaya, no es correcto! üòî La respuesta era <strong>${preguntaActual.respuesta}</strong>. Puntuaci√≥n: ${puntuacionTotal}.<br>¬øQuieres intentarlo de nuevo?`;
            agregarMensaje(mensaje, 'bot', [
                { texto: '1. S√≠', accion: 'continuar_trivial', clase: 'trivial' },
                { texto: '2. No, volver al inicio', accion: 'ver_puntaje', clase: 'ver_puntaje' }
            ]);
        }
        historialConsultas.push({ tipo: 'trivial', valor: `Pregunta: ${preguntaActual.pregunta}, Respuesta dada: ${respuesta}` });
    }, 1000);
}

window.onload = async () => {
    await cargarCatalogo();
    const frase = frasesBienvenida[Math.floor(Math.random() * frasesBienvenida.length)];
    setTimeout(() => {
        agregarMensaje(frase, 'bot', [
            { texto: '1. Recomendaciones üìö', accion: 'recomendaciones', clase: 'recomendaciones' },
            { texto: '2. Buscar un libro üîç', accion: 'buscar', clase: 'buscar' },
            { texto: '3. Juguemos al trivial literario ‚ùì', accion: 'trivial', clase: 'trivial' },
            { texto: '4. Explorar categor√≠as literarias üìñ', accion: 'categorias', clase: 'categorias' },
            { texto: '5. Reservar un libro ‚úÖ', accion: 'reserva', clase: 'reserva' },
            { texto: '6. Solicitar un libro üìù', accion: 'solicitud', clase: 'solicitud' },
            { texto: '7. Ver historial de consultas üïí', accion: 'historial', clase: 'historial' },
            { texto: '8. Ver puntaje total üåü', accion: 'ver_puntaje', clase: 'ver_puntaje' }
        ]);
    }, 1000);
};