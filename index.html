<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Hipatia - IES CARPE DIEM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        (function(){
            emailjs.init("YOUR_USER_ID");
        })();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #loginSection {
            text-align: center;
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #app {
            display: none;
        }
        header {
            text-align: center;
            background-image: url('https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2024/03/carpediem-foto-inicio1920x1200c.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .admin-badge {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9em;
            margin-left: 10px;
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        .admin-badge:hover {
            background-color: #0056b3;
        }
        .notification-count {
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            font-size: 0.7em;
            padding: 2px 5px;
            min-width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -8px;
            right: -8px;
            font-weight: bold;
        }
        .email-section {
            margin-top: 10px;
            font-size: 0.9em;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            align-items: center;
        }
        .logout-btn, .web-ies-btn {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            color: white;
        }
        .logout-btn {
            background-color: #dc3545;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .web-ies-btn {
            background-color: #28a745;
        }
        .web-ies-btn:hover {
            background-color: #218838;
        }
        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .btn-reserva, .btn-recoger, .btn-devolver, .btn-anular, .btn-export {
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            border: none;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .btn-reserva {
            background-color: #28a745;
        }
        .btn-reserva:hover {
            background-color: #218838;
        }
        .btn-recoger {
            background-color: #ffc107;
            color: black;
        }
        .btn-recoger:hover {
            background-color: #e0a800;
        }
        .btn-devolver {
            background-color: #17a2b8;
        }
        .btn-devolver:hover {
            background-color: #138496;
        }
        .btn-anular {
            background-color: #dc3545;
        }
        .btn-anular:hover {
            background-color: #c82333;
        }
        .btn-export {
            background-color: #6f42c1;
        }
        .btn-export:hover {
            background-color: #5a2d91;
        }
        .libro {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        #perfil {
            background: #f8f9fa;
        }
        .lista-libros {
            margin: 10px 0;
        }
        .libro-perfil {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: white;
        }
        .fecha {
            font-size: 0.8em;
            color: #666;
        }
        .retrasado {
            color: red;
            font-weight: bold;
            background: #ffebee;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .estadisticas {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .estadisticas input {
            width: 50px;
            text-align: center;
        }
        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .mensaje {
            margin: 5px 0;
            padding: 5px;
        }
        .mensaje.user {
            background-color: #e3f2fd;
            text-align: right;
        }
        .mensaje.bot {
            background-color: #f1f8e9;
        }
        .estado-reservado {
            color: orange;
            font-weight: bold;
        }
        .estado-no-disponible {
            color: red;
            font-weight: bold;
        }
        .tejuelo {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 2px;
        }
        #conteoResultados {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #e9f5ff;
            border-radius: 4px;
        }
        #adminHistorial table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        #adminHistorial th, #adminHistorial td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #adminHistorial th {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        #adminHistorial th:hover {
            background-color: #0056b3;
        }
        #adminHistorial tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #adminHistorial tr:hover {
            background-color: #f1f1f1;
        }
        .sort-arrow::after {
            content: '';
            display: inline-block;
            margin-left: 5px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        .sort-arrow.asc::after {
            border-bottom: 5px solid white;
        }
        .sort-arrow.desc::after {
            border-top: 5px solid white;
        }
        #adminTabs {
            margin-bottom: 20px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .tab-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .tab-btn.active {
            background-color: #007bff;
            color: white;
            border-bottom: none;
        }
        .tab-btn.volver {
            background-color: #f0f0f0;
            color: black;
        }
        .tab-btn.volver:hover {
            background-color: #e0e0e0;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #adminApprovedEmails {
            margin-top: 20px;
        }
        #approvedEmailList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
        .email-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        .email-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .email-item button {
            margin-left: auto;
            padding: 2px 5px;
            font-size: 0.8em;
        }
        #emailSearch {
            width: 200px;
        }
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff25c8ff 0%, #1eff6d 50%, #f0ff22 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: rgb(0, 0, 0);
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
        }
        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-container {
            animation: fadeInContainer 1.5s ease-out;
        }
        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
            transition: transform 0.3s ease;
        }
        #splash img:hover {
            transform: scale(1.05);
        }
        #splash h2 {
            font-size: 2.8em;
            margin: 15px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.8s ease-out 1s both;
            letter-spacing: 1px;
        }
        #splash p {
            font-size: 1.3em;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }
        @keyframes fadeInContainer {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 768px) {
            #splash h2 { font-size: 2em; }
            #splash p { font-size: 1.1em; }
            #splash img { max-width: 180px; }
            #adminHistorial table { font-size: 0.9em; }
            #emailSearch { width: 100%; }
            .email-item { flex-direction: column; align-items: flex-start; }
            .email-item button { margin-left: 0; margin-top: 5px; }
            #adminTabs { flex-direction: column; gap: 2px; }
            .tab-btn { width: 100%; text-align: center; }
            .email-section { flex-direction: column; align-items: flex-end; gap: 5px; }
        }
        @media (prefers-reduced-motion: reduce) {
            #splash img, #splash h2, #splash p, .loader {
                animation: none !important;
                transition: none !important;
            }
        }
        .pagination {
            text-align: center;
            margin: 10px 0;
        }
        .pagination button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        .pagination span {
            font-weight: bold;
        }
        #solicitudTextarea {
            width: 100%;
            height: 150px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        #tendenciasTable {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        #tendenciasTable th, #tendenciasTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #tendenciasTable th {
            background-color: #28a745;
            color: white;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="splash">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png" 
                 alt="Logo de la Biblioteca Hipatia" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvZ28gTm8gQ2FycmVnYWRvPC90ZXh0Pjwvc3ZnPg=='">
            <h2>¡Bienvenidos a la Biblioteca Hipatia!</h2>
            <p>Cargando el catálogo de libros y aventuras...</p>
            <div class="loader"></div>
        </div>
    </div>
    <div id="loginSection">
        <h2>Acceso a la Biblioteca</h2>
        <p>Solo usuarios @educa.madrid.org aprobados</p>
        <input type="email" id="loginEmail" placeholder="Introduce tu email @educa.madrid.org">
        <br>
        <button onclick="login()">Acceder</button>
        <p id="loginError" style="color: red; display: none;">Email inválido o no aprobado.</p>
    </div>
    <div id="app">
        <header>
            <h1>Catálogo de la Biblioteca Hipatia</h1>
            <p>IES Carpe Diem, Fuenlabrada</p>
            <div class="email-section">
                <span id="adminBadge" class="admin-badge" style="display: none;" onclick="mostrarHistorialAdmin()">
                    ADMIN
                    <span id="notificationCount" class="notification-count" style="display: none;"></span>
                </span>
                <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
                <button class="web-ies-btn" onclick="window.open('https://site.educa.madrid.org/ies.carpediem.fuenlabrada/', '_blank')">Web del IES</button>
            </div>
        </header>
        <main>
            <section id="perfil">
                <h2>Mi Perfil</h2>
                <div id="misReservas"></div>
                <div id="misPrestamos"></div>
                <div id="solicitudesLibros">
                    <h3>Solicitudes de Libros</h3>
                    <p>Indica qué libros te gustaría que se compraran para la biblioteca (máximo 500 palabras).</p>
                    <textarea id="solicitudTextarea" maxlength="500"></textarea>
                    <button onclick="enviarSolicitud()">Enviar Solicitud</button>
                </div>
            </section>
            <section id="busqueda">
                <h2>Buscar Libros</h2>
                <input type="text" id="buscarInput" placeholder="Busca por título, autor, tejuelo, categoría" onkeypress="if(event.key === 'Enter') buscarLibros()">
                <button onclick="buscarLibros()">Buscar</button>
                <div id="conteoResultados" style="display: none;"></div>
                <div id="resultados"></div>
            </section>
            <section id="chatbot">
                <h2>Hipat-IA: Tu Asistente Bibliotecario</h2>
                <p>Pregúntame por libros, recomendaciones, tu perfil o trivia. ¡Estoy aquí para ayudarte! 📖</p>
                <div id="chatMensajes"></div>
                <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." onkeypress="if(event.key === 'Enter') enviarMensaje()">
                <button onclick="enviarMensaje()">Enviar</button>
            </section>
            <section id="adminHistorial" style="display: none;">
                <h2>Administración</h2>
                <div id="adminTabs">
                    <button class="tab-btn active" onclick="showAdminTab('tareas')">Tareas Pendientes</button>
                    <button class="tab-btn" onclick="showAdminTab('historial')">Historial Completo</button>
                    <button class="tab-btn" onclick="showAdminTab('correos')">Gestión de Correos</button>
                    <button class="tab-btn" onclick="showAdminTab('solicitudes')">Solicitudes de Libros</button>
                    <button class="tab-btn" onclick="showAdminTab('alertas')">Alertas de Búsqueda</button>
                    <button class="tab-btn" onclick="showAdminTab('tendencias')">Tendencias de Búsqueda</button>
                    <button class="tab-btn volver" onclick="volverCatalogo()">Volver al Catálogo</button>
                </div>
                <div id="adminTabContent"></div>
            </section>
        </main>
    </div>
    <script type="text/javascript">
        var gk_isXlsx = true;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error('Error al procesar archivo:', e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
    <script>
        let catalogo = [];
        let reservas = {};
        let prestamos = {};
        let solicitudes = [];
        let approvedEmails = [];
        let alertasBusqueda = [];
        let infracciones = {};
        let consultasChat = [];
        let emailSesion = null;
        const EMAIL_ADMIN = 'rafael.casais@educa.madrid.org';
        const ANNO_ACTUAL = '2025';
        let sortColumn = 'fechaReserva';
        let sortDirection = 'desc';
        let sortColumnEmails = 'email';
        let sortDirectionEmails = 'asc';
        let sortColumnAlertas = 'fecha';
        let sortDirectionAlertas = 'desc';
        let currentPageHistorial = 1;
        let currentPageEmails = 1;
        let currentPageSolicitudes = 1;
        let currentPageAlertas = 1;
        let chatIniciado = false;

        // Configuración para Gemini API (Free Tier)
        const GEMINI_API_KEY = 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg';
        const LIMITE_IA_DIARIO = 10;

        // Lista de palabras clave prohibidas (expandida para cortafuegos educativo)
        const palabrasProhibidas = [
            'porno', 'pornografía', 'adulto', 'sexo', 'erótico', 'xxx', 
            'actriz porno', 'contenido para adultos', 'desnudo', 'explícito',
            'mierda', 'joder', 'puta', 'coño', 'polla', 'cabrón', 'hostia', 'follar', 'cagar',
            'maricón', 'lesbiana', 'trans', 'viado', 'puto', 'zorra', 'imbécil', 'idiota',
            'gilipollas', 'cabrón', 'hijo de puta', 'me cago en', 'vete a la mierda'
        ];

        // Función auxiliar para verificar si el mensaje es inapropiado (cortafuegos)
        function esMensajeInapropiado(mensaje) {
            const mensajeLower = mensaje.toLowerCase();
            return palabrasProhibidas.some(palabra => mensajeLower.includes(palabra));
        }

        // Función para loggear consultas útiles (para admin)
        function logConsulta(query) {
            const hoy = new Date().toISOString().split('T')[0];
            const consulta = { query, email: emailSesion, fecha: new Date().toISOString(), dia: hoy };
            consultasChat.push(consulta);
            localStorage.setItem('consultasChat', JSON.stringify(consultasChat));
        }

        // Función para registrar alertas de búsqueda
        function registrarAlertaBusqueda(mensaje) {
            const palabraBloqueada = palabrasProhibidas.find(palabra => mensaje.toLowerCase().includes(palabra)) || 'No relacionada';
            const alerta = {
                email: emailSesion,
                mensaje,
                palabraBloqueada,
                fecha: new Date().toISOString()
            };
            alertasBusqueda.push(alerta);
            localStorage.setItem('alertasBusqueda', JSON.stringify(alertasBusqueda));

            // Contar infracciones
            if (!infracciones[emailSesion]) infracciones[emailSesion] = 0;
            infracciones[emailSesion]++;
            localStorage.setItem('infracciones', JSON.stringify(infracciones));

            // Expulsar al usuario tras 3 infracciones
            if (infracciones[emailSesion] >= 3) {
                approvedEmails = approvedEmails.filter(e => e !== emailSesion);
                localStorage.setItem('approvedEmails', JSON.stringify(approvedEmails));
                emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                    to_email: emailSesion,
                    subject: 'Expulsión del Sistema de Biblioteca',
                    message: 'Has sido expulsado del sistema de la Biblioteca Hipatia por realizar consultas inapropiadas. Contacta al administrador para ser readmitido.'
                }).catch(() => {
                    const subject = encodeURIComponent('Expulsión del Sistema de Biblioteca');
                    const body = encodeURIComponent('Has sido expulsado del sistema de la Biblioteca Hipatia por realizar consultas inapropiadas. Contacta al administrador para ser readmitido.');
                    window.location.href = `mailto:${emailSesion}?subject=${subject}&body=${body}`;
                });
                logout();
            }

            // Notificar al administrador
            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                to_email: EMAIL_ADMIN,
                subject: 'Alerta: Consulta Inapropiada Detectada',
                message: `Usuario ${emailSesion} intentó: "${mensaje}" (Palabra bloqueada: ${palabraBloqueada})`
            }).catch(() => {
                console.error('Error al enviar alerta al administrador');
            });

            updateNotificationBadge();
        }

        // Función para obtener curso de email
        function obtenerCursoDeEmail(email) {
            const partes = email.split('@')[0].split('.');
            return partes.length > 1 ? partes[partes.length - 1].toUpperCase() : 'DESCONOCIDO';
        }

        // Función para obtener libros populares
        function obtenerLibrosPopulares(topN = 3) {
            let historial = [];
            Object.keys(prestamos).forEach(email => {
                (prestamos[email] || []).forEach(p => {
                    if (p.fechaPrestamo) historial.push(p.titulo);
                });
            });
            const conteo = {};
            historial.forEach(titulo => conteo[titulo] = (conteo[titulo] || 0) + 1);
            return Object.entries(conteo)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([titulo]) => titulo);
        }

        // Función para buscar en catálogo (devuelve JSON para Gemini)
        function buscarEnCatalogoJSON(query) {
            const resultados = catalogo.filter(libro => 
                libro.titulo.toLowerCase().includes(query.toLowerCase()) ||
                libro.autor.toLowerCase().includes(query.toLowerCase()) ||
                libro.categoria.toLowerCase().includes(query.toLowerCase()) ||
                libro.signatura.toLowerCase().includes(query.toLowerCase()) ||
                libro.isbn.toLowerCase().includes(query.toLowerCase())
            );
            return resultados.slice(0, 5).map(l => ({
                titulo: l.titulo,
                autor: l.autor,
                categoria: l.categoria,
                tejuelo: l.signatura.replace(/\s+/g, '-'),
                isbn: l.isbn,
                disponible: l.disponible ? 'Sí' : 'No'
            }));
        }

        // Búsqueda semántica - Encuentra similares en catálogo
        function buscarSimilaresEnCatalogo(libroBase, num = 5) {
            const baseCat = libroBase.categoria.toLowerCase();
            const baseTitulo = libroBase.titulo.toLowerCase();
            return catalogo
                .filter(l => l.categoria.toLowerCase().includes(baseCat) && l.titulo.toLowerCase() !== baseTitulo)
                .slice(0, num)
                .map(l => ({
                    titulo: l.titulo,
                    autor: l.autor,
                    categoria: l.categoria,
                    tejuelo: l.signatura.replace(/\s+/g, '-'),
                    disponible: l.disponible ? 'Sí' : 'No'
                }));
        }

        // Función principal para generar respuestas con Gemini como Hipat-IA
        async function generarRespuestaHipatia(mensaje) {
            const hoy = new Date().toDateString();
            const key = `geminiRequests_${emailSesion}_${hoy}`;
            let requests = parseInt(localStorage.getItem(key) || '0');
            if (requests >= LIMITE_IA_DIARIO) {
                return '¡Ups! Has alcanzado el límite diario de consultas a Hipat-IA. ¡Vuelve mañana para más aventuras literarias! 📚';
            }
            localStorage.setItem(key, (requests + 1).toString());

            // Resumir catálogo para no exceder tokens (top 10 libros + populares)
            const catalogoResumido = catalogo.slice(0, 10).map(l => ({
                titulo: l.titulo,
                autor: l.autor,
                categoria: l.categoria,
                tejuelo: l.signatura,
                disponible: l.disponible ? 'Sí' : 'No'
            }));
            const populares = obtenerLibrosPopulares(3);
            const eventoActual = chequearEventoActual();

            // Perfil del usuario resumido
            const perfilResumido = {
                email: emailSesion,
                curso: obtenerCursoDeEmail(emailSesion),
                reservasActivas: (reservas[emailSesion] || []).filter(r => !r.recogido && !r.anulado).length,
                prestamosActivos: (prestamos[emailSesion] || []).filter(p => !p.devuelto).length,
                librosReservados: (reservas[emailSesion] || []).map(r => r.titulo).join(', ')
            };

            // Prompt completo para Hipat-IA
            const prompt = `Eres Hipat-IA, un asistente bibliotecario amigable, entusiasta y educativo de la Biblioteca Hipatia del IES Carpe Diem (Fuenlabrada). Siempre respondes en español, de forma natural, divertida y útil, como si fueras una bibliotecaria sabia inspirada en Hipatia de Alejandría. Usa emojis relevantes (📖, 🔍, ✨, etc.) y mantén respuestas cortas (máx. 150 palabras).

Reglas estrictas:
- Ayuda con búsquedas de libros (título, autor, categoría, tejuelo, ISBN), reservas, préstamos y perfil del usuario.
- Recomienda libros basados en intereses, populares o similares (usa categoría y temas).
- Genera trivia literaria, resúmenes sin spoilers (máx. 100 palabras + cita), o sugerencias de compra.
- Si preguntan por perfil, resume reservas/préstamos activos.
- Si es saludo o ayuda, da bienvenida y ejemplos: "¡Hola! ¿Buscas 'El Quijote'? ¿O recomendaciones de fantasía?".
- Ignora temas no relacionados con libros/biblioteca; redirige amablemente.
- Si no hay coincidencias, sugiere solicitar compra o buscar alternativas.
- Incluye evento actual si aplica: ${eventoActual}.

Datos del usuario: ${JSON.stringify(perfilResumido, null, 2)}
Catálogo resumido (top 10): ${JSON.stringify(catalogoResumido, null, 2)}
Libros populares: ${populares.join(', ')}

Responde a esta consulta: "${mensaje}"`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('Error en API');
                const data = await response.json();
                let respuesta = data.candidates[0].content.parts[0].text;
                // Limpiar respuesta si es muy larga
                if (respuesta.length > 300) {
                    respuesta = respuesta.substring(0, 300) + '... (Respuesta abreviada)';
                }
                return respuesta;
            } catch (e) {
                console.error('Error en Gemini:', e);
                return '¡Ay! Hipat-IA está tomándose un respiro. Prueba de nuevo o usa la búsqueda manual. Ej: "Busca aventuras". 📚';
            }
        }

        // Función para chequear eventos
        function chequearEventoActual() {
            const hoy = new Date();
            if (hoy.getMonth() === 3 && hoy.getDate() === 23) {
                return '¡Hoy es el Día del Libro! Te recomiendo clásicos como "Don Quijote" de Cervantes o algo de tu catálogo favorito.';
            }
            return '';
        }

        // Función simplificada para enviarMensaje (todo via Gemini)
        async function enviarMensaje() {
            const input = document.getElementById('chatInput');
            const mensaje = input.value.trim();
            if (!mensaje) return;

            // Agregar mensaje del usuario
            agregarMensaje(mensaje, 'user');
            input.value = '';

            // Cortafuegos primero
            if (esMensajeInapropiado(mensaje)) {
                const respuesta = '¡Cuidado! Ese tema no es apto para nuestra biblioteca. Mantengámonos en libros y aventuras. 😊 Si persiste, podría limitar el acceso.';
                setTimeout(() => agregarMensaje(respuesta, 'bot'), 500);
                registrarAlertaBusqueda(mensaje);
                return;
            }

            // Loggear si es consulta útil (búsquedas, recomendaciones, etc.)
            const esConsultaUtil = mensaje.toLowerCase().match(/(busc|recomienda|trivia|resumen|perfil|similar|como)/);
            if (esConsultaUtil) {
                logConsulta(mensaje);
            }

            // Generar respuesta con Gemini como Hipat-IA
            const respuesta = await generarRespuestaHipatia(mensaje);
            setTimeout(() => agregarMensaje(respuesta, 'bot'), 800);
        }

        // Función para agregar mensaje al chat
        function agregarMensaje(texto, tipo) {
            const chatMensajes = document.getElementById('chatMensajes');
            const div = document.createElement('div');
            div.className = `mensaje ${tipo}`;
            div.textContent = texto;
            chatMensajes.appendChild(div);
            chatMensajes.scrollTop = chatMensajes.scrollHeight;
        }

        // Login function
        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email.endsWith('@educa.madrid.org')) {
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            if (approvedEmails.includes(email)) {
                emailSesion = email;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                cargarPerfil();
                if (email === EMAIL_ADMIN) {
                    document.getElementById('adminBadge').style.display = 'inline-block';
                }
                updateNotificationBadge();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Logout function
        function logout() {
            emailSesion = null;
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('adminBadge').style.display = 'none';
            document.getElementById('chatMensajes').innerHTML = '';
        }

        // Cargar perfil
        function cargarPerfil() {
            const misReservasDiv = document.getElementById('misReservas');
            const misPrestamosDiv = document.getElementById('misPrestamos');
            misReservasDiv.innerHTML = '<h3>Mis Reservas</h3>' + ((reservas[emailSesion] || []).map(r => `<div class="libro-perfil">${r.titulo} - ${r.fechaReserva} <span class="fecha">${r.recogido ? 'Recogido' : 'Pendiente'}</span></div>`).join('') || 'No hay reservas.');
            misPrestamosDiv.innerHTML = '<h3>Mis Préstamos</h3>' + ((prestamos[emailSesion] || []).map(p => `<div class="libro-perfil">${p.titulo} - ${p.fechaPrestamo} <span class="fecha">${p.devuelto ? 'Devuelto' : 'Activo'}</span></div>`).join('') || 'No hay préstamos.');
        }

        // Buscar libros
        function buscarLibros() {
            const query = document.getElementById('buscarInput').value.toLowerCase();
            const resultados = catalogo.filter(libro => 
                libro.titulo.toLowerCase().includes(query) ||
                libro.autor.toLowerCase().includes(query) ||
                libro.signatura.toLowerCase().includes(query) ||
                libro.categoria.toLowerCase().includes(query)
            );
            document.getElementById('conteoResultados').innerHTML = `Encontrados ${resultados.length} resultados.`;
            document.getElementById('conteoResultados').style.display = resultados.length > 0 ? 'block' : 'none';
            document.getElementById('resultados').innerHTML = resultados.map(libro => `
                <div class="libro">
                    <h4>${libro.titulo}</h4>
                    <p><strong>Autor:</strong> ${libro.autor}</p>
                    <p><strong>Categoría:</strong> ${libro.categoria}</p>
                    <p><strong>Tejuelo:</strong> <span class="tejuelo">${libro.signatura}</span></p>
                    <p><strong>Disponible:</strong> ${libro.disponible ? 'Sí' : '<span class="estado-no-disponible">No</span>'}</p>
                    ${libro.disponible ? `<button class="btn-reserva" onclick="reservarLibro('${libro.signatura}')">Reservar</button>` : ''}
                </div>
            `).join('') || '<p>No se encontraron resultados.</p>';
        }

        // Reservar libro (placeholder)
        function reservarLibro(tejuelo) {
            if (!reservas[emailSesion]) reservas[emailSesion] = [];
            reservas[emailSesion].push({ tejuelo, titulo: catalogo.find(l => l.signatura === tejuelo).titulo, fechaReserva: new Date().toISOString().split('T')[0], recogido: false, anulado: false });
            guardarDatos();
            cargarPerfil();
            alert('¡Libro reservado! Recógelo pronto.');
        }

        // Enviar solicitud
        function enviarSolicitud() {
            const texto = document.getElementById('solicitudTextarea').value.trim();
            if (texto) {
                solicitudes.push({ email: emailSesion, texto, fecha: new Date().toISOString() });
                guardarDatos();
                alert('¡Solicitud enviada! El admin la revisará.');
                document.getElementById('solicitudTextarea').value = '';
            }
        }

        // Update notification badge
        function updateNotificationBadge() {
            const count = alertasBusqueda.length;
            const badge = document.getElementById('notificationCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Mostrar historial admin
        function mostrarHistorialAdmin() {
            document.getElementById('adminHistorial').style.display = 'block';
            showAdminTab('tareas');
        }

        // Volver al catálogo
        function volverCatalogo() {
            document.getElementById('adminHistorial').style.display = 'none';
        }

        // Show admin tab
        function showAdminTab(tabId) {
            const buttons = document.querySelectorAll('#adminTabs .tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            const contentDiv = document.getElementById('adminTabContent');
            if (tabId === 'tareas') {
                contentDiv.innerHTML = '<h3>Tareas Pendientes</h3><p>Implementar lista de tareas...</p>';
            } else if (tabId === 'historial') {
                contentDiv.innerHTML = '<h3>Historial Completo</h3><p>Implementar tabla de historial...</p>';
            } else if (tabId === 'correos') {
                contentDiv.innerHTML = '<h3>Gestión de Correos</h3><input type="text" id="emailSearch" placeholder="Buscar email" onkeyup="filtrarEmails()"><div id="approvedEmailList"></div>';
                renderApprovedEmails();
            } else if (tabId === 'solicitudes') {
                contentDiv.innerHTML = '<h3>Solicitudes de Libros</h3>' + solicitudes.map(s => `<p>${s.email}: ${s.texto} (${s.fecha})</p>`).join('') || '<p>No hay solicitudes.</p>';
            } else if (tabId === 'alertas') {
                contentDiv.innerHTML = '<h3>Alertas de Búsqueda</h3>' + alertasBusqueda.map(a => `<p>${a.email}: ${a.mensaje} (${a.palabraBloqueada}) - ${a.fecha}</p>`).join('') || '<p>No hay alertas.</p>';
            } else if (tabId === 'tendencias') {
                contentDiv.innerHTML = getTendenciasBusqueda();
            }
        }

        // Render approved emails (placeholder)
        function renderApprovedEmails() {
            const list = document.getElementById('approvedEmailList');
            list.innerHTML = approvedEmails.map(e => `<div class="email-item"><input type="checkbox" value="${e}"><span>${e}</span><button onclick="aprobarEmail('${e}')">Aprobar</button></div>`).join('');
        }

        // Filtrar emails (placeholder)
        function filtrarEmails() {
            // Implementar filtro
        }

        // Aprobar email (placeholder)
        function aprobarEmail(email) {
            if (!approvedEmails.includes(email)) approvedEmails.push(email);
            guardarDatos();
            renderApprovedEmails();
        }

        // Get tendencias (como antes)
        function getTendenciasBusqueda() {
            let html = '<h3>Tendencias de Búsqueda en Chat</h3>';
            const hoy = new Date().toISOString().split('T')[0];
            const consultasHoy = consultasChat.filter(c => c.dia === hoy);
            const conteo = {};
            consultasHoy.forEach(c => conteo[c.query] = (conteo[c.query] || 0) + 1);
            const sorted = Object.entries(conteo).sort((a, b) => b[1] - a[1]).slice(0, 10);

            html += `<table id="tendenciasTable">
                <thead><tr><th>Query</th><th>Veces</th><th>Usuarios</th></tr></thead>
                <tbody>${sorted.map(([query, count]) => {
                    const usuariosUnicos = [...new Set(consultasHoy.filter(c => c.query === query).map(c => c.email))].length;
                    return `<tr><td>${query}</td><td>${count}</td><td>${usuariosUnicos}</td></tr>`;
                }).join('') || '<tr><td colspan="3">No hay tendencias hoy.</td></tr>'}
                </tbody>
            </table>`;
            html += `<button class="btn-export" onclick="exportTendenciasCSV()">Exportar a CSV</button>`;
            return html;
        }

        function exportTendenciasCSV() {
            const hoy = new Date().toISOString().split('T')[0];
            const consultasHoy = consultasChat.filter(c => c.dia === hoy);
            const csv = 'Query,Veces,Usuarios\n' + Object.entries(consultasHoy.reduce((acc, c) => { acc[c.query] = (acc[c.query] || 0) + 1; return acc; }, {})).map(([q, v]) => `${q},${v},${[...new Set(consultasHoy.filter(c => c.query === q).map(c => c.email))].length}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tendencias_${hoy}.csv`;
            a.click();
        }

        // Cargar datos
        function cargarDatos() {
            const reservasGuardadas = localStorage.getItem('reservas');
            if (reservasGuardadas) reservas = JSON.parse(reservasGuardadas);
            const prestamosGuardados = localStorage.getItem('prestamos');
            if (prestamosGuardados) prestamos = JSON.parse(prestamosGuardados);
            const solicitudesGuardadas = localStorage.getItem('solicitudes');
            if (solicitudesGuardadas) solicitudes = JSON.parse(solicitudesGuardadas);
            const approvedEmailsGuardados = localStorage.getItem('approvedEmails');
            if (approvedEmailsGuardados) approvedEmails = JSON.parse(approvedEmailsGuardados);
            const alertasGuardadas = localStorage.getItem('alertasBusqueda');
            if (alertasGuardadas) alertasBusqueda = JSON.parse(alertasGuardadas);
            const infraccionesGuardadas = localStorage.getItem('infracciones');
            if (infraccionesGuardadas) infracciones = JSON.parse(infraccionesGuardadas);
            const consultasGuardadas = localStorage.getItem('consultasChat');
            if (consultasGuardadas) consultasChat = JSON.parse(consultasGuardadas);

            // Cargar catálogo de ejemplo (reemplaza con loadFileData si tienes XLSX)
            catalogo = [
                { titulo: 'El Quijote', autor: 'Cervantes', categoria: 'Clásicos', signatura: '82-1', isbn: '978-84-9769', disponible: true },
                { titulo: '1984', autor: 'Orwell', categoria: 'Distopía', signatura: '82-2', isbn: '978-84-9790', disponible: false },
                { titulo: 'El Principito', autor: 'Saint-Exupéry', categoria: 'Infantil', signatura: '82-3', isbn: '978-84-9791', disponible: true }
            ];
        }

        // Guardar datos
        function guardarDatos() {
            localStorage.setItem('reservas', JSON.stringify(reservas));
            localStorage.setItem('prestamos', JSON.stringify(prestamos));
            localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
            localStorage.setItem('approvedEmails', JSON.stringify(approvedEmails));
            localStorage.setItem('alertasBusqueda', JSON.stringify(alertasBusqueda));
            localStorage.setItem('infracciones', JSON.stringify(infracciones));
            localStorage.setItem('consultasChat', JSON.stringify(consultasChat));
        }

        // Inicialización
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('splash').classList.add('hidden');
                setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
            }, 3000);
            cargarDatos();
        };
    </script>
</body>
</html>