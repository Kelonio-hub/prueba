<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Biblioteca Escolar - Chatbot IA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        header {
            text-align: center;
            background-color: #007bff;
            color: white;
            padding: 20px;
            border-radius: 8px;
        }

        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        .libro {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .libro .signatura {
            font-weight: bold;
            color: #007bff;
        }

        .libro .estado-disponible {
            color: green;
        }

        .libro .estado-no-disponible {
            color: red;
        }

        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }

        .mensaje {
            margin: 5px 0;
            padding: 5px;
        }

        .mensaje.user {
            background-color: #e3f2fd;
            text-align: right;
        }

        .mensaje.bot {
            background-color: #f1f8e9;
        }
        
        /* Estilos para splash */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff25c8ff 0%, #1eff6d 50%, #f0ff22 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: rgb(0, 0, 0);
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
        }
        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .splash-container {
            animation: fadeInContainer 1.5s ease-out;
        }
        
        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
            transition: transform 0.3s ease;
        }
        
        #splash h2 {
            font-size: 2.8em;
            margin: 15px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.8s ease-out 1s both;
            letter-spacing: 1px;
        }
        
        #splash p {
            font-size: 1.3em;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }
        
        /* CÓDIGO .loader MODIFICADO CON DEGRADADO */
        .loader {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff25c8ff 0%, #1eff6d 50%, #f0ff22 100%); 
            border: none;
            border-radius: 50%;
            animation: spin 1s linear infinite; 
            margin-top: 15px;
            display: block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* (otras keyframes omitidas por brevedad) */
    </style>
</head>
<body>
    <div id="splash">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png" 
                 alt="Logo de la Biblioteca Hipatia">
            
            <h2>¡Bienvenidos a la Biblioteca Hipatia!</h2>
            <p>Cargando el catálogo de libros y aventuras...</p>
            
            <div class="loader"></div>
        </div>
    </div>

    <header>
        <h1>Catálogo de la Biblioteca Escolar Carpe Diem, Fuenlabrada</h1>
        <p>Busca libros por signatura o categoría, o pregunta al chatbot IA.</p>
    </header>

    <main>
        <section id="busqueda">
            <h2>Buscar Libros</h2>
            <input type="text" id="buscarInput" placeholder="Busca por signatura, título, autor o categoría..." onkeypress="if(event.key === 'Enter') buscarLibros()">
            <button onclick="buscarLibros()">Buscar</button>
            <div id="resultados"></div>
        </section>

        <section id="chatbot">
            <h2>Chatbot IA</h2>
            <p>Pregunta sobre libros, recomendaciones o la biblioteca.</p>
            <div id="chatMensajes"></div>
            <input type="text" id="chatInput" placeholder="Escribe tu mensaje...">
            <button onclick="enviarMensaje()">Enviar</button>
        </section>
    </main>

    <script>
        let catalogo = [];

        async function cargarCatalogo() {
            try {
                // 1. PETICIÓN: Asegúrate de usar un servidor local (Live Server) para que esto funcione.
                const response = await fetch('Ejemplares.xml'); 
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: Archivo no encontrado. ¿Estás usando un servidor local (Live Server)?`);
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('Error al parsear el XML. Verifica el formato del archivo.');
                }

                // 2. PARSEO: Extrae todos los elementos con la etiqueta 'Ejemplar'
                const ejemplares = xmlDoc.getElementsByTagName('Ejemplar');
                
                // Mensaje de depuración: Comprueba la consola (F12) para ver cuántos elementos se encontraron.
                console.log(`[DEBUG] Elementos <Ejemplar> encontrados: ${ejemplares.length}`); 

                catalogo = Array.from(ejemplares).map(ejemplar => ({
                    // Lógica de signatura robusta
                    signatura: `${ejemplar.getAttribute('Signatura1') || ''} ${ejemplar.getAttribute('Signatura2') || ''} ${ejemplar.getAttribute('Signatura3') || ''}`.trim(),
                    // ISBN ELIMINADO
                    fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                    estado: ejemplar.getAttribute('Estado') === '0', // 0 = disponible
                    idRegistro: ejemplar.getAttribute('IdRegistro') || 'No disponible'
                }));
                
                if (!catalogo.length) {
                    document.getElementById('resultados').innerHTML = '<p>No se encontraron ejemplares en el catálogo. Revisa F12 para debug.</p>';
                }
            } catch (error) {
                console.error('Error al cargar catálogo:', error);
                document.getElementById('resultados').innerHTML = `<p>Error al cargar el catálogo: ${error.message}</p>`;
            }
        }

        // Búsqueda de ejemplares (solo por signatura, sin ISBN)
        function buscarLibros() {
            if (!catalogo.length) {
                document.getElementById('resultados').innerHTML = '<p>El catálogo aún no se ha cargado.</p>';
                return;
            }
            const query = document.getElementById('buscarInput').value.toLowerCase();
            const resultados = catalogo.filter(ejemplar => 
                ejemplar.signatura.toLowerCase().includes(query)
            );
            mostrarResultados(resultados);
        }

        function mostrarResultados(ejemplares) {
            const div = document.getElementById('resultados');
            if (ejemplares.length === 0) {
                div.innerHTML = '<p>No se encontraron ejemplares.</p>';
                return;
            }
            div.innerHTML = ejemplares.map(ejemplar => `
                <div class="libro">
                    <h3 class="signatura">${ejemplar.signatura || 'Sin signatura'}</h3>
                    <p><strong>Fecha de ingreso:</strong> ${ejemplar.fecha}</p>
                    <p><strong>Disponible:</strong> <span class="${ejemplar.estado ? 'estado-disponible' : 'estado-no-disponible'}">${ejemplar.estado ? 'Sí' : 'No'}</span></p>
                    <p><strong>ID Registro:</strong> ${ejemplar.idRegistro}</p>
                </div>
            `).join('');
        }

        // Chatbot SIMULADO (Respuestas sin ISBN)
        async function enviarMensaje() {
            const input = document.getElementById('chatInput');
            const mensaje = input.value.trim();
            if (!mensaje) return;

            agregarMensaje(mensaje, 'user');
            input.value = '';

            let respuesta = '';
            const mensajeLower = mensaje.toLowerCase();

            if (mensajeLower.includes('buscar') || mensajeLower.includes('libro') || mensajeLower.includes('ejemplar')) {
                respuesta = '¡Claro! Usa el buscador de arriba para encontrar ejemplares por signatura (ej. "P ALE his"). Si no sabes la signatura, dime un tema como "historia" o "ficción" y te ayudo.';
            } else if (mensajeLower.includes('disponible') || mensajeLower.includes('prestado')) {
                respuesta = 'En el catálogo, los ejemplares con estado "Sí" están disponibles. Si dice "No", están prestados. Prueba buscar por signatura para verificar un ejemplar específico.';
            } else if (mensajeLower.includes('recomendación') || mensajeLower.includes('recomendar')) {
                respuesta = 'Te recomendaría un libro de aventuras o historia, pero necesito el catálogo completo para sugerir algo específico. Prueba buscar por signatura como "P ALE" o dime qué género prefieres.';
            } else if (mensajeLower.includes('biblioteca')) {
                respuesta = '¡Bienvenido a la biblioteca escolar! Usa el buscador para encontrar ejemplares por signatura. Si necesitas ayuda con préstamos o quieres contactar al bibliotecario, dime más.';
            } else {
                respuesta = `Hola, soy el asistente de la biblioteca. Tu pregunta: "${mensaje}". Prueba con palabras como "buscar", "recomendación" o "disponible" para obtener ayuda con el catálogo. ¿Qué necesitas?`;
            }

            setTimeout(() => {
                agregarMensaje(respuesta, 'bot');
            }, 1000); 
        }

        function agregarMensaje(texto, tipo) {
            const div = document.getElementById('chatMensajes');
            const p = document.createElement('p');
            p.className = `mensaje ${tipo}`;
            p.textContent = texto;
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        }

        // Inicializar al cargar la página
        cargarCatalogo();
    </script>

    <script>
        setTimeout(function() {
            const splash = document.getElementById('splash');
            splash.classList.add('hidden');
            setTimeout(function() {
                splash.remove();
            }, 500);
        }, 3000);
    </script>
</body>
</html>