<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Biblioteca Escolar - Chatbot IA</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        header {
            text-align: center;
            background-color: #007bff;
            color: white;
            padding: 20px;
            border-radius: 8px;
        }

        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        .libro {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }

        .mensaje {
            margin: 5px 0;
            padding: 5px;
        }

        .mensaje.user {
            background-color: #e3f2fd;
            text-align: right;
        }

        .mensaje.bot {
            background-color: #f1f8e9;
        }
        
        /* Estilos para estado de disponibilidad */
        .estado-disponible {
            color: green;
            font-weight: bold;
        }
        .estado-no-disponible {
            color: red;
            font-weight: bold;
        }
    </style>
    <style>
        /* Estilos para splash inspirados en el splash atractivo */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff25c8ff 0%, #1eff6d 50%, #f0ff22 100%); /* Fondo azul celeste temático */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: rgb(0, 0, 0);
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
        }
        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Contenedor principal para animaciones */
        .splash-container {
            animation: fadeInContainer 1.5s ease-out;
        }
        
        /* Logo con animación de acercamiento (bounceIn) */
        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
            transition: transform 0.3s ease;
        }
        #splash img:hover {
            transform: scale(1.05);
        }
        
        /* Título principal con fadeInUp */
        #splash h2 {
            font-size: 2.8em;
            margin: 15px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.8s ease-out 1s both;
            letter-spacing: 1px;
        }
        
        /* Texto descriptivo con fadeInUp */
        #splash p {
            font-size: 1.3em;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }
        
        /* Spinner de carga */
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid rgb(235, 237, 241);
            border-top: 4px solid rgb(57, 192, 255);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 15px;
            display: block;
        }
        
        /* Keyframes para animaciones */
        @keyframes fadeInContainer {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive para móviles */
        @media (max-width: 768px) {
            #splash h2 { font-size: 2em; }
            #splash p { font-size: 1.1em; }
            #splash img { max-width: 180px; }
        }
        
        /* Accesibilidad: reducir motion si preferido */
        @media (prefers-reduced-motion: reduce) {
            #splash img, #splash h2, #splash p, .loader {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="splash">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png" 
                alt="Logo de la Biblioteca Hipatia" 
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvZ28gTm8gQ2FycmVnYWRvPC90ZXh0Pjwvc3ZnPg=='">
            
            <h2>¡Bienvenidos a la Biblioteca Hipatia!</h2>
            <p>Cargando el catálogo de libros y aventuras...</p>
            
            <div class="loader"></div>
        </div>
    </div>

    <header>
        <h1>Catálogo de la Biblioteca Escolar Carpe Diem, Fuenlabrada</h1>
        <p>Busca libros por **título, autor**, ISBN o **signatura**, o pregunta al chatbot IA.</p>
    </header>

    <main>
        <section id="busqueda">
            <h2>Buscar Libros</h2>
            <input type="text" id="buscarInput" placeholder="Busca por título, autor, ISBN o signatura..." onkeypress="if(event.key === 'Enter') buscarLibros()">
            <button onclick="buscarLibros()">Buscar</button>
            <div id="resultados"></div>
        </section>

        <section id="chatbot">
            <h2>Chatbot IA</h2>
            <p>Pregunta sobre libros, recomendaciones o la biblioteca.</p>
            <div id="chatMensajes"></div>
            <input type="text" id="chatInput" placeholder="Escribe tu mensaje...">
            <button onclick="enviarMensaje()">Enviar</button>
        </section>
    </main>

    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                    row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                    headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    
    <script>
        // Cargar datos del catálogo
        let catalogo = [];

        async function cargarCatalogo() {
            try {
                const response = await fetch('Ejemplares.xml'); // Ajusta el nombre del archivo XML
                if (!response.ok) {
                    // Manejar errores HTTP (como 404 o 500)
                    throw new Error(`Error HTTP: ${response.status} - No se pudo cargar Ejemplares.xml`);
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Verificar si hay errores de parseo
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('Error al parsear el XML. Verifica el formato del archivo.');
                }

                // Extraer ejemplares
                const ejemplares = xmlDoc.getElementsByTagName('Ejemplar');
                catalogo = Array.from(ejemplares).map(ejemplar => ({
                    // La Signatura combina 3 atributos
                    signatura: `${ejemplar.getAttribute('Signatura1') || ''} ${ejemplar.getAttribute('Signatura2') || ''} ${ejemplar.getAttribute('Signatura3') || ''}`.trim(),
                    
                    // >>>>> CAMPOS TÍTULO Y AUTOR AÑADIDOS <<<<<
                    titulo: ejemplar.getAttribute('Titulo') || 'Título no disponible',
                    autor: ejemplar.getAttribute('Autor') || 'Autor no disponible',
                    // >>>>> FIN CAMPOS AÑADIDOS <<<<<

                    isbn: ejemplar.getAttribute('ISBN') || 'No disponible',
                    fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                    estado: ejemplar.getAttribute('Estado') === '0', // 0 = disponible, ajusta si es diferente
                    idRegistro: ejemplar.getAttribute('IdRegistro') || 'No disponible'
                }));
                
                console.log('Catálogo cargado:', catalogo); // Para debug
                if (!catalogo.length) {
                    document.getElementById('resultados').innerHTML = '<p>No se encontraron ejemplares en el catálogo.</p>';
                }
            } catch (error) {
                console.error('Error al cargar catálogo:', error);
                // LÍNEA MODIFICADA PARA UN MENSAJE AMIGABLE AL USUARIO
                document.getElementById('resultados').innerHTML = '<p>⚠️ **Error al leer el catálogo**. El archivo de datos puede estar inaccesible o en mantenimiento. Por favor, **pruebe de nuevo más tarde**.</p>';
                catalogo = []; // Aseguramos que el catálogo esté vacío si hay un error
            }
        }

        // Búsqueda de ejemplares
        function buscarLibros() {
            if (!catalogo.length) {
                document.getElementById('resultados').innerHTML = '<p>El catálogo aún no se ha cargado. Intenta de nuevo en unos segundos.</p>';
                return;
            }
            const query = document.getElementById('buscarInput').value.toLowerCase();
            
            // LÓGICA DE BÚSQUEDA MODIFICADA PARA INCLUIR TÍTULO Y AUTOR
            const resultados = catalogo.filter(ejemplar => 
                ejemplar.signatura.toLowerCase().includes(query) ||
                ejemplar.isbn.toLowerCase().includes(query) ||
                ejemplar.titulo.toLowerCase().includes(query) || // Búsqueda por Título
                ejemplar.autor.toLowerCase().includes(query)    // Búsqueda por Autor
            );
            
            mostrarResultados(resultados);
        }

        function mostrarResultados(ejemplares) {
            const div = document.getElementById('resultados');
            if (ejemplares.length === 0) {
                div.innerHTML = '<p>No se encontraron ejemplares.</p>';
                return;
            }
            div.innerHTML = ejemplares.map(ejemplar => `
                <div class="libro">
                    <h3 class="titulo">${ejemplar.titulo || 'Sin Título'}</h3>
                    <p><strong>Autor:</strong> ${ejemplar.autor}</p>
                    <p><strong>Signatura:</strong> ${ejemplar.signatura || 'Sin signatura'}</p>
                    <p><strong>ISBN:</strong> ${ejemplar.isbn}</p>
                    <p><strong>Fecha de ingreso:</strong> ${ejemplar.fecha}</p>
                    <p><strong>Disponible:</strong> <span class="${ejemplar.estado ? 'estado-disponible' : 'estado-no-disponible'}">${ejemplar.estado ? 'Sí' : 'No'}</span></p>
                    <p><strong>ID Registro:</strong> ${ejemplar.idRegistro}</p>
                </div>
            `).join('');
        }

        // Chatbot SIMULADO (sin API real)
        async function enviarMensaje() {
            const input = document.getElementById('chatInput');
            const mensaje = input.value.trim();
            if (!mensaje) return;

            // Mostrar mensaje del usuario
            agregarMensaje(mensaje, 'user');
            input.value = '';

            // Simulación de respuesta
            let respuesta = '';
            const mensajeLower = mensaje.toLowerCase();

            if (mensajeLower.includes('buscar') || mensajeLower.includes('libro') || mensajeLower.includes('ejemplar') || mensajeLower.includes('título')) {
                respuesta = '¡Claro! Usa el buscador de arriba para encontrar ejemplares por signatura (ej. "P ALE his"), ISBN, **título** o **autor**. Si no sabes la signatura, dime un tema como "historia" o "ficción" y te ayudo.';
            } else if (mensajeLower.includes('disponible') || mensajeLower.includes('prestado') || mensajeLower.includes('estado')) {
                respuesta = 'En el catálogo, los ejemplares con estado "Sí" están disponibles. Si dice "No", están prestados. Prueba buscar por signatura o ISBN para verificar un ejemplar específico.';
            } else if (mensajeLower.includes('recomendación') || mensajeLower.includes('recomendar') || mensajeLower.includes('sugerencia')) {
                respuesta = 'Te recomendaría un libro de aventuras o historia, pero necesito el catálogo completo para sugerir algo específico. Prueba buscar por signatura como "P ALE" o dime qué género prefieres.';
            } else if (mensajeLower.includes('biblioteca') || mensajeLower.includes('horario')) {
                respuesta = '¡Bienvenido a la biblioteca escolar! Usa el buscador para encontrar ejemplares por signatura, título o autor. Si necesitas ayuda con préstamos o quieres contactar al bibliotecario, dime más.';
            } else {
                respuesta = `Hola, soy el asistente de la biblioteca. Tu pregunta: "${mensaje}". Prueba con palabras como "buscar", "recomendación" o "disponible" para obtener ayuda con el catálogo. ¿Qué necesitas?`;
            }

            // Añadir un pequeño delay para simular procesamiento
            setTimeout(() => {
                agregarMensaje(respuesta, 'bot');
            }, 1000); // 1 segundo de espera
        }

        function agregarMensaje(texto, tipo) {
            const div = document.getElementById('chatMensajes');
            const p = document.createElement('p');
            p.className = `mensaje ${tipo}`;
            p.textContent = texto;
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        }

        // Inicializar al cargar la página
        cargarCatalogo();
    </script>
    <script>
        // Ocultar splash después de 3 segundos (ajustado para fluidez, como en el splash original)
        setTimeout(function() {
            const splash = document.getElementById('splash');
            splash.classList.add('hidden');
            // Remover del DOM después de la transición para optimizar
            setTimeout(function() {
                splash.remove();
            }, 500);
        }, 3000);
    </script>
</body>
</html>