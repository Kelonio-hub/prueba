<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES CARPE DIEM - Biblioteca Hipatia 🦉</title>
    <!-- Favicon y recursos pre-cargados -->
    <link rel="icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada/wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-100x100.png" sizes="32x32" />
    <link rel="icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada/wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada/wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" />
    <meta name="msapplication-TileImage" content="https://site.educa.madrid.org/ies.carpediem.fuenlabrada/wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" />
    <link rel="preload" href="./Ejemplares.xml" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png" as="image">
    <!-- Dependencias externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.18/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/natural@5.2.4/lib/natural.min.js"></script>
    <style>
        /* Variables CSS para temas claro/oscuro */
        :root {
            --bg-primary: #f4f4f4;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --btn-primary: #3399ff;
            --btn-hover: #1a73e8;
            --btn-reserva: #2a2a2a;
            --btn-reserva-hover: #1c1c1c;
            --btn-solicitud: #2a2a2a;
            --btn-solicitud-hover: #1c1c1c;
            --btn-donaciones: #2a2a2a;
            --btn-donaciones-hover: #1c1c1c;
            --btn-reseña: #2a2a2a;
            --btn-reseña-hover: #1c1c1c;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --chat-bg: #f9f9f9;
            --user-msg-bg: #c9c9c9;
            --bot-msg-bg: #e0e0e0;
            --bot-msg-color: #000;
            --splash-bg: linear-gradient(135deg, #fff 0%, #c8c8c8 50%, #fff 100%);
            --splash-text: #000;
            --splash-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            --btn-proseguir: #17a2b8;
            --btn-proseguir-hover: #138496;
            --btn-buscar-libro: #3399ff;
            --btn-buscar-libro-hover: #1a73e8;
            --btn-sinopsis: #28a745;
            --btn-sinopsis-hover: #218838;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #fff;
            --text-secondary: #ccc;
            --border-color: #444;
            --btn-primary: #3399ff;
            --btn-hover: #1a73e8;
            --btn-reserva: #2a2a2a;
            --btn-reserva-hover: #1c1c1c;
            --btn-solicitud: #2a2a2a;
            --btn-solicitud-hover: #1c1c1c;
            --btn-donaciones: #2a2a2a;
            --btn-donaciones-hover: #1c1c1c;
            --btn-reseña: #2a2a2a;
            --btn-reseña-hover: #1c1c1c;
            --shadow: 0 2px 5px rgba(0,0,0,0.3);
            --chat-bg: #374151;
            --user-msg-bg: #3a3a3a;
            --bot-msg-bg: #4a5568;
            --bot-msg-color: #e0e0e0;
            --splash-bg: linear-gradient(135deg, #374151 0%, #374151 50%, #374151 100%);
            --splash-text: #fff;
            --splash-shadow: 2px 2px 4px rgba(255, 255, 255, 0.2);
        }

        /* Estilos generales */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Pantalla de carga */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--splash-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: var(--splash-text);
            text-align: center;
            text-shadow: var(--splash-shadow);
        }

        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
        }

        #splash h2 {
            font-size: 2.8rem;
            margin: 15px 0;
            animation: fadeInUp 0.8s ease-out 1s both;
        }

        #splash p {
            font-size: 1.3rem;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #app {
            display: none;
        }

        /* Encabezado */
        header {
            text-align: center;
            background-image: url('https://site.educa.madrid.org/ies.carpediem.fuenlabrada/wp-content/uploads/ies.carpediem.fuenlabrada/2024/03/carpediem-foto-inicio1920x1200c.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
        }

        .theme-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        [data-theme="dark"] .theme-toggle {
            background: rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: rgba(0,0,0,0.3);
        }

        .header-search {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .search-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 600px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
        }

        .header-search input {
            padding: 8px;
            border: none;
            border-radius: 4px;
            width: 250px;
            max-width: 100%;
            background: rgba(255,255,255,0.9);
        }

        .header-search button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .header-search .buscar-btn {
            background-color: var(--btn-primary);
        }

        .header-search .buscar-btn:hover {
            background-color: var(--btn-hover);
        }

        .header-search .reserva-btn {
            background-color: var(--btn-reserva);
        }

        .header-search .reserva-btn:hover {
            background-color: var(--btn-reserva-hover);
        }

        .header-search .reseña-btn {
            background-color: var(--btn-reseña);
        }

        .header-search .reseña-btn:hover {
            background-color: var(--btn-reseña-hover);
        }

        .header-search .solicitud-btn {
            background-color: var(--btn-solicitud);
        }

        .header-search .solicitud-btn:hover {
            background-color: var(--btn-solicitud-hover);
        }

        .header-search .donaciones-btn {
            background-color: var(--btn-donaciones);
        }

        .header-search .donaciones-btn:hover {
            background-color: var(--btn-donaciones-hover);
        }

        /* Sección principal */
        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        section {
            flex: 1;
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        #seccionDerecha {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Chatbot */
        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid var(--border-color);
            padding: 10px;
            margin: 10px 0;
            background-color: var(--chat-bg);
            color: var(--text-primary);
        }

        .mensaje {
            margin: 5px 0;
            padding: 5px;
            color: var(--text-primary);
            border-radius: 4px;
        }

        .mensaje.user {
            background-color: var(--user-msg-bg);
            text-align: right;
        }

        .mensaje.bot {
            background-color: var(--bot-msg-bg);
            color: var(--bot-msg-color);
        }

        .mensaje.temporal {
            font-style: italic;
            color: #888;
            opacity: 0.7;
        }

        .proseguir-btn, .buscar-libro-btn, .reserva-libro-btn, .solicitud-libro-btn, .sinopsis-btn {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            margin-right: 5px;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .proseguir-btn {
            background-color: var(--btn-proseguir);
            color: white;
        }

        .proseguir-btn:hover {
            background-color: var(--btn-proseguir-hover);
        }

        .buscar-libro-btn {
            background-color: var(--btn-buscar-libro);
            color: white;
        }

        .buscar-libro-btn:hover {
            background-color: var(--btn-buscar-libro-hover);
        }

        .reserva-libro-btn {
            background-color: var(--btn-reserva);
            color: white;
        }

        .reserva-libro-btn:hover {
            background-color: var(--btn-reserva-hover);
        }

        .solicitud-libro-btn {
            background-color: var(--btn-solicitud);
            color: white;
        }

        .solicitud-libro-btn:hover {
            background-color: var(--btn-solicitud-hover);
        }

        .sinopsis-btn {
            background-color: var(--btn-sinopsis);
            color: white;
        }

        .sinopsis-btn:hover {
            background-color: var(--btn-sinopsis-hover);
        }

        .chat-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-controls input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-controls button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--btn-primary);
            color: white;
            cursor: pointer;
        }

        .chat-controls button:hover {
            background-color: var(--btn-hover);
        }

        /* Modal de búsqueda */
        #searchModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        #searchModalContent {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            color: var(--text-primary);
        }

        .modal-close {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-search input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-search button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--btn-primary);
            color: white;
            cursor: pointer;
        }

        .modal-search button:hover {
            background-color: var(--btn-hover);
        }

        .libro-modal {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: var(--bg-secondary);
        }

        .libro-modal img {
            max-width: 100px;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .tejuelo {
            font-family: monospace;
            padding: 2px 4px;
            border-radius: 2px;
            color: black;
        }

        .tejuelo[data-categoria="narrativa"] { background-color: #1bd47a; }
        .tejuelo[data-categoria="poesía"] { background-color: #ff48a9; }
        .tejuelo[data-categoria="teatro"] { background-color: #e350de; }
        .tejuelo[data-categoria="literatura inglesa"] { background-color: #d4d700; }
        .tejuelo[data-categoria="enciclopedias"] { background-color: #ffaa00; }
        .tejuelo[data-categoria="cómic"] { background-color: #33c5ff; }
        .tejuelo[data-categoria="deportes"] { background-color: #ff0000; }
        .tejuelo:not([data-categoria]), .tejuelo[data-categoria="no disponible"] { background-color: #ccc; }

        .pagination {
            text-align: center;
            margin: 10px 0;
        }

        .pagination button {
            background-color: var(--btn-primary);
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: var(--shadow);
            z-index: 10000;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: black; }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        @media (max-width: 768px) {
            main { flex-direction: column; }
            #seccionDerecha { max-width: none; }
            #splash h2 { font-size: 2rem; }
            #splash p { font-size: 1.1rem; }
            #splash img { max-width: 180px; }
            .search-container, .action-buttons { flex-direction: column; }
            .header-search input, .header-search button { width: 100%; max-width: 300px; }
            #searchModalContent { width: 95%; margin: 10% auto; padding: 15px; }
            .toast { bottom: 10px; right: 10px; left: 10px; min-width: auto; }
            .theme-controls { flex-direction: column; gap: 2px; }
            .chat-controls { flex-direction: column; }
            .libro-modal img { max-width: 80px; }
        }
    </style>
</head>
<body>
    <!-- Pantalla de carga -->
    <div id="splash" tabindex="0">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png"
                 alt="Logo de la Biblioteca Hipatia"
                 loading="lazy"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvZ28gTm8gQ2FycmVnYWRvPC90ZXh0Pjwvc3ZnPg=='">
            <h2>¡Bienvenidos a la Biblioteca Hipatia!</h2>
            <p id="splash-message">Cargando el catálogo de libros y aventuras...</p> <!-- CAMBIO: Agregado ID para actualizar mensaje -->
        </div>
    </div>

    <!-- Contenido principal -->
    <div id="app">
        <header>
            <div class="theme-controls">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Cambiar tema">🌙</button>
            </div>
            <h1>🦉 Biblioteca Hipatia - <a href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada/" target="_blank" style="color:#fff;">IES CARPE DIEM</a></h1>
            <div class="header-search">
                <div class="search-container">
                    <input type="text" id="buscarInput" placeholder="Busca por título, autor, tejuelo, categoría"
                           aria-label="Buscar libros"
                           onkeypress="if(event.key === 'Enter') mostrarResultadosBusqueda()"
                           list="sugerenciasBusqueda">
                    <datalist id="sugerenciasBusqueda"></datalist>
                    <button class="buscar-btn" onclick="mostrarResultadosBusqueda()" aria-label="Buscar libros">Buscar 🔍</button>
                </div>
                <div class="action-buttons">
                    <button class="reserva-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSeTUAdMIEZz0lP2qflcZgfIP2zhsU4sYJoQZYoJcmvUZRAQnw/viewform?usp=header', '_blank')"
                            aria-label="Formulario de reserva">Reserva de Libros 📚</button>
                    <button class="reseña-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLScbwLhvODSn6s5oP_GOdVhtUtojdiDUOBe5O2pJexUW5VT-Fw/viewform?usp=header', '_blank')"
                            aria-label="Formulario de reseñas">Reseña de Libros ✍️</button>
                    <button class="solicitud-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSf_VH-Wmf7SC7geWNwoLhX1aqc_xy1LQ-fp-SFYdlOYIbTE-g/viewform?usp=header', '_blank')"
                            aria-label="Formulario de solicitud">Solicitud de Libros 🗳️</button>
                    <button class="donaciones-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLScwmrvlgtCIXpCQcvU76kdAOjB5p0oNi8mpB__p2_0TBWthrg/viewform?usp=header', '_blank')"
                            aria-label="Formulario de donaciones">Donación de Libros 📦</button>
                </div>
            </div>
        </header>

        <main>
            <section id="seccionDerecha">
                <h2>Hipat-IA</h2>
                <p>¡Tu Bibliotecaria Virtual! 👩‍💼</p>
                <div id="chatMensajes" role="log" aria-live="polite" aria-atomic="true"></div>
                <div class="chat-controls">
                    <input type="text" id="chatInput" placeholder="Libros, sinopsis, recomendaciones..."
                           aria-label="Mensaje al chatbot"
                           onkeypress="if(event.key === 'Enter') enviarMensaje()">
                    <button onclick="enviarMensaje()" aria-label="Enviar mensaje">Enviar 💬</button>
                </div>
            </section>
        </main>

        <!-- Modal de búsqueda -->
        <div id="searchModal" tabindex="0">
            <div id="searchModalContent">
                <span class="modal-close" role="button" aria-label="Cerrar modal" onclick="cerrarModal()">&times;</span>
                <h3>Resultados de Búsqueda</h3>
                <div class="modal-search">
                    <input type="text" id="modalSearchInput" placeholder="Busca por título, autor, tejuelo, categoría"
                           aria-label="Buscar en modal"
                           onkeypress="if(event.key === 'Enter') buscarEnModal()">
                    <button onclick="buscarEnModal()" aria-label="Buscar en modal">Buscar 🔍</button>
                </div>
                <div id="conteoResultadosModal"></div>
                <div id="resultadosModal"></div>
                <div id="searchPagination" class="pagination"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let catalogo = [];
        let searchResults = [];
        let searchQuery = '';
        let currentPageSearch = 1;
        let toastCount = 0;
        let respuestasPendientes = {};
        let mensajeActualId = 0;
        let historialMensajes = [];
        let cacheRespuestas = JSON.parse(localStorage.getItem('hipatia_cache')) || {};

        // Configuración de la API de Gemini
        const API_KEY = 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg';
        const BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODELOS_A_PROBAR = [
            'gemini-1.5-flash-latest',
            'gemini-1.5-pro-latest',
            'gemini-2.5-flash',
            'gemini-2.5-pro'
        ];
        let MODELO_FUNCIONAL = localStorage.getItem('gemini_modelo_funcional') || null;

        // CAMBIO: Función para mostrar la aplicación
        function mostrarApp() {
            const splash = document.getElementById('splash');
            const app = document.getElementById('app');
            splash.classList.add('hidden');
            app.style.display = 'block';
            app.focus(); // Mejorar accesibilidad
        }

        // CAMBIO: Timeout para la carga
        function withTimeout(promise, ms) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error('Tiempo de espera agotado')), ms))
            ]);
        }

        // Sanitizar HTML
        function sanitizeHTML(str) {
            return DOMPurify.sanitize(str);
        }

        // Mostrar notificaciones toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.bottom = `${20 + (toastCount * 60)}px`;
            toast.textContent = message;
            document.body.appendChild(toast);
            toastCount++;
            setTimeout(() => {
                toast.remove();
                toastCount--;
            }, 3000);
        }

        // Cambiar tema claro/oscuro
        function toggleTheme() {
            const body = document.body;
            const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Cargar tema
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Cerrar modal
        function cerrarModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('buscarInput').focus();
            document.getElementById('modalSearchInput').value = '';
        }

        // Verificar existencia de imágenes
        async function imageExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch {
                return false;
            }
        }

        // Inicializar clasificador NLP
        let classifier = new natural.BayesClassifier();
        function inicializarClasificador() {
            try {
                const savedClassifier = localStorage.getItem('intencionesClasificador');
                if (savedClassifier) {
                    classifier = natural.BayesClassifier.restore(JSON.parse(savedClassifier));
                } else {
                    classifier.addDocument('cuántos ejemplares hay de', 'ejemplares');
                    classifier.addDocument('cuantas copias disponibles', 'ejemplares');
                    classifier.addDocument('dame la sinopsis de', 'sinopsis');
                    classifier.addDocument('resumen del libro', 'resumen');
                    classifier.addDocument('reseña de', 'reseña');
                    classifier.addDocument('recomiéndame un libro', 'recomendaciones');
                    classifier.addDocument('sugerencias de lectura', 'recomendaciones');
                    classifier.addDocument('libro de fantasía', 'recomendacion_fantasia');
                    classifier.addDocument('poesía para leer', 'recomendacion_poesia');
                    classifier.addDocument('novela narrativa', 'recomendacion_narrativa');
                    classifier.addDocument('obra de teatro', 'recomendacion_teatro');
                    classifier.addDocument('cómic para leer', 'recomendacion_comic');
                    classifier.addDocument('libro en inglés', 'recomendacion_literatura_inglesa');
                    classifier.addDocument('libros de deportes', 'recomendacion_deportes');
                    classifier.addDocument('quiero reservar un libro', 'reservas');
                    classifier.addDocument('proponer un libro nuevo', 'solicitar');
                    classifier.train();
                    localStorage.setItem('intencionesClasificador', JSON.stringify(classifier));
                }
            } catch (error) {
                console.error('Error al inicializar clasificador:', error);
                showToast('Error al inicializar el chatbot. Algunas funciones pueden no estar disponibles.', 'warning');
            }
        }

        // Cargar catálogo desde XML
        async function cargarCatalogo() {
            try {
                const cacheVersion = 'catalog-v1';
                const cachedCatalogo = localStorage.getItem('catalogo');
                const cachedVersion = localStorage.getItem('catalogoVersion');
                const cacheTimestamp = localStorage.getItem('catalogoTimestamp');
                const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas
                const now = Date.now();

                if (cachedCatalogo && cachedVersion === cacheVersion && cacheTimestamp && (now - parseInt(cacheTimestamp) < CACHE_DURATION)) {
                    catalogo = JSON.parse(cachedCatalogo);
                    actualizarSugerenciasBusqueda();
                    return;
                }

                // CAMBIO: Agregar mensaje en el splash
                document.getElementById('splash-message').textContent = 'Cargando catálogo de libros...';

                const response = await withTimeout(fetch('./Ejemplares.xml', { signal: new AbortController().signal }), 5000); // CAMBIO: Timeout de 5 segundos
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) throw new Error('Error al parsear XML.');

                const libros = {};
                Array.from(xmlDoc.getElementsByTagName('Libro')).forEach(libro => {
                    const idDocumento = libro.getAttribute('id_documento') || `unknown_${Math.random().toString(36).slice(2)}`;
                    const descriptor = libro.getElementsByTagName('Descriptor')[0];
                    const rawCategoria = descriptor ? descriptor.textContent : 'No disponible';
                    const categoriaMap = {
                        'narrativa': 'Narrativa',
                        'poesia': 'Poesía',
                        'poesía': 'Poesía',
                        'teatro': 'Teatro',
                        'literatura inglesa': 'Literatura inglesa',
                        'enciclopedias': 'Enciclopedias',
                        'comic': 'Cómic',
                        'cómic': 'Cómic',
                        'deportes': 'Deportes'
                    };
                    libros[idDocumento] = {
                        titulo: libro.getElementsByTagName('Titulo')[0]?.textContent || 'Título desconocido',
                        autor: libro.getElementsByTagName('Autor')[0]?.textContent || 'Autor desconocido',
                        categoria: categoriaMap[rawCategoria.toLowerCase()] || rawCategoria,
                        fechaEdicion: libro.getElementsByTagName('FechaEdicion')[0]?.textContent || 'No disponible'
                    };
                });

                const librosAgrupados = {};
                for (const ejemplar of Array.from(xmlDoc.getElementsByTagName('Ejemplar'))) {
                    const idRegistro = ejemplar.getAttribute('IdRegistro') || '';
                    if (!idRegistro) continue;
                    const libro = libros[idRegistro] || {};
                    const signaturaMap = {
                        'Narrativa': 'N',
                        'Poesía': 'P',
                        'Teatro': 'T',
                        'Literatura inglesa': 'LI',
                        'Enciclopedias': 'E',
                        'Cómic': 'C',
                        'Deportes': 'D'
                    };
                    const signatura1 = signaturaMap[libro.categoria] || ejemplar.getAttribute('Signatura1') || '';
                    const signatura = `${signatura1}-${ejemplar.getAttribute('Signatura2') || ''}-${ejemplar.getAttribute('Signatura3') || ''}`.trim();
                    const tituloNormalizado = normalizarTexto(libro.titulo || 'Sin título').replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');

                    if (!librosAgrupados[idRegistro]) {
                        librosAgrupados[idRegistro] = {
                            titulo: libro.titulo || 'Título desconocido',
                            autor: libro.autor || 'Autor desconocido',
                            categoria: libro.categoria || 'No disponible',
                            fechaEdicion: libro.fechaEdicion || 'No disponible',
                            signatura: signatura || 'No disponible',
                            isbn: ejemplar.getAttribute('ISBN') || 'No disponible',
                            fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                            copiasTotales: 0,
                            copiasDisponibles: 0,
                            idRegistro: idRegistro,
                            portada: './img/portadas/default.jpg'
                        };
                        const posiblesPortadas = [
                            `./img/portadas/${tituloNormalizado}.png`,
                            `./img/portadas/${tituloNormalizado}.jpg`,
                            `./img/portadas/${idRegistro}.png`,
                            `./img/portadas/${idRegistro}.jpg`
                        ];
                        for (const url of posiblesPortadas) {
                            if (await imageExists(url)) {
                                librosAgrupados[idRegistro].portada = url;
                                break;
                            }
                        }
                    }
                    librosAgrupados[idRegistro].copiasTotales += 1;
                    if (ejemplar.getAttribute('Estado') === '0') librosAgrupados[idRegistro].copiasDisponibles += 1;
                }
                catalogo = Object.values(librosAgrupados);
                localStorage.setItem('catalogo', JSON.stringify(catalogo));
                localStorage.setItem('catalogoVersion', cacheVersion);
                localStorage.setItem('catalogoTimestamp', now.toString());
                actualizarSugerenciasBusqueda();
            } catch (error) {
                console.error('Error al cargar catálogo:', error);
                catalogo = [];
                showToast('Catálogo en mantenimiento. Algunas funciones estarán limitadas.', 'warning');
                // CAMBIO: No bloquear la transición
                document.getElementById('splash-message').textContent = 'Error al cargar el catálogo. Continuando...';
            }
        }

        // Actualizar sugerencias de búsqueda
        function actualizarSugerenciasBusqueda() {
            const datalist = document.getElementById('sugerenciasBusqueda');
            datalist.innerHTML = catalogo.map(libro => `
                <option value="${libro.titulo}">${libro.autor} - ${libro.categoria} (${libro.copiasDisponibles} disponibles)</option>
            `).join('');
        }

        // Normalizar texto
        function normalizarTexto(texto) {
            if (!texto) return '';
            const acentos = { 'á': 'a', 'é': 'e', 'í': 'i', 'ó': 'o', 'ú': 'u', 'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U' };
            return texto.replace(/[áéíóúÁÉÍÓÚ]/g, match => acentos[match] || match).toLowerCase().replace(/\s+/g, ' ').trim();
        }

        // Buscar libros
        function buscarLibros(query, exactMatch = false) {
            if (!catalogo.length || !query) return [];
            const lowerQuery = normalizarTexto(query);
            if (exactMatch) return catalogo.filter(libro => normalizarTexto(libro.titulo) === lowerQuery);
            return catalogo.filter(libro =>
                normalizarTexto(libro.titulo).includes(lowerQuery) ||
                normalizarTexto(libro.autor).includes(lowerQuery) ||
                normalizarTexto(libro.categoria).includes(lowerQuery) ||
                normalizarTexto(libro.signatura).includes(lowerQuery) ||
                normalizarTexto(libro.isbn).includes(lowerQuery)
            ).sort((a, b) => b.copiasDisponibles - a.copiasDisponibles);
        }

        // Mostrar resultados de búsqueda
        function mostrarResultadosBusqueda() {
            if (!catalogo.length) {
                showToast('Catálogo en mantenimiento.', 'warning');
                return;
            }
            const query = document.getElementById('buscarInput').value.trim();
            if (!query) {
                showToast('Introduce un término de búsqueda.', 'warning');
                return;
            }
            searchQuery = query;
            searchResults = buscarLibros(query);
            currentPageSearch = 1;
            abrirModal();
            mostrarResultadosModal();
        }

        // Buscar desde modal
        function buscarEnModal() {
            const query = document.getElementById('modalSearchInput').value.trim();
            if (!query) {
                showToast('Introduce un término de búsqueda.', 'warning');
                return;
            }
            searchQuery = query;
            searchResults = buscarLibros(query);
            currentPageSearch = 1;
            mostrarResultadosModal();
        }

        // Abrir modal
        function abrirModal() {
            const modal = document.getElementById('searchModal');
            const modalSearchInput = document.getElementById('modalSearchInput');
            modalSearchInput.value = searchQuery;
            modal.style.display = 'block';
            modalSearchInput.focus();
        }

        // Mostrar resultados en modal
        function mostrarResultadosModal() {
            const pageSize = 5;
            const totalPages = Math.ceil(searchResults.length / pageSize);
            const start = (currentPageSearch - 1) * pageSize;
            const end = start + pageSize;
            const paginatedResults = searchResults.slice(start, end);
            const conteoDiv = document.getElementById('conteoResultadosModal');
            const resultadosDiv = document.getElementById('resultadosModal');
            const paginationDiv = document.getElementById('searchPagination');
            conteoDiv.innerHTML = searchResults.length > 0
                ? `<p>${searchResults.length} resultados para "${sanitizeHTML(searchQuery)}".</p>`
                : `<p>No se encontraron resultados para "${sanitizeHTML(searchQuery)}".</p>`;
            resultadosDiv.innerHTML = paginatedResults.map(libro => `
                <div class="libro-modal" role="region" aria-label="Resultado para ${libro.titulo}">
                    <img src="${libro.portada}" alt="Portada de ${libro.titulo}"
                         onerror="this.src='./img/portadas/default.jpg'" loading="lazy">
                    <p><strong>Título:</strong> ${libro.titulo}</p>
                    <p><strong>Autor:</strong> ${libro.autor}</p>
                    <p><strong>Categoría:</strong> ${libro.categoria}</p>
                    <p><strong>Tejuelo:</strong> <span class="tejuelo" data-categoria="${libro.categoria.toLowerCase()}">${libro.signatura}</span></p>
                    <p><strong>Ejemplares Disponibles:</strong> ${libro.copiasDisponibles}</p>
                    <button class="sinopsis-btn" onclick="mostrarSinopsis('${libro.idRegistro}', '${sanitizeHTML(libro.titulo)}', '${sanitizeHTML(libro.autor)}')"
                            aria-label="Generar sinopsis para ${libro.titulo}">Generar Sinopsis 📖</button>
                    <div id="sinopsis-${libro.idRegistro}" style="display: none; margin-top: 10px;"></div>
                </div>
            `).join('') || '<p>No se encontraron libros.</p>';
            paginationDiv.innerHTML = `
                <button ${currentPageSearch === 1 ? 'disabled' : ''} onclick="changePageSearch(${currentPageSearch - 1})" aria-label="Página anterior">Anterior</button>
                ${Array.from({ length: totalPages }, (_, i) => `
                    <button ${currentPageSearch === i + 1 ? 'disabled' : ''} onclick="changePageSearch(${i + 1})" aria-label="Página ${i + 1}">${i + 1}</button>
                `).join('')}
                <button ${currentPageSearch === totalPages ? 'disabled' : ''} onclick="changePageSearch(${currentPageSearch + 1})" aria-label="Página siguiente">Siguiente</button>
            `;
        }

        // Cambiar página
        function changePageSearch(newPage) {
            currentPageSearch = newPage;
            mostrarResultadosModal();
        }

        // Probar modelos de Gemini
        async function probarModelo(modelo, contents) {
            try {
                const response = await fetch(`${BASE_URL}${modelo}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                if (data.candidates && data.candidates.length > 0) {
                    const contenido = data.candidates[0].content;
                    if (contenido && contenido.parts && contenido.parts.length > 0) {
                        localStorage.setItem('gemini_modelo_funcional', modelo);
                        MODELO_FUNCIONAL = modelo;
                        return contenido.parts.map(part => part.text).join(' ');
                    }
                }
                return null;
            } catch (error) {
                console.error(`Error con el modelo ${modelo}:`, error);
                return null;
            }
        }

        // Generar sinopsis
        async function generarSinopsis(titulo, autor, idRegistro) {
            const cacheKey = `sinopsis_${normalizarTexto(titulo)}_${normalizarTexto(autor)}`;
            if (cacheRespuestas[cacheKey]) {
                return { texto: cacheRespuestas[cacheKey], mostrarReservaBtn: false, mostrarSolicitudBtn: false };
            }
            const systemPrompt = `Eres Hipat-IA, bibliotecaria virtual del IES Carpe Diem. Proporciona una sinopsis breve (100-200 palabras) del libro "${titulo}" de ${autor}. Si no conoces el libro, genera una sinopsis creativa basada en el título y contexto. Termina con una oración completa con punto. Usa un tono cálido y emojis 📖.`;
            const contents = [
                { parts: [{ text: systemPrompt }], role: 'model' },
                { parts: [{ text: `Dame la sinopsis de "${titulo}" de ${autor}.` }], role: 'user' }
            ];
            let respuesta = null;
            if (!MODELO_FUNCIONAL || MODELO_FUNCIONAL === 'null') {
                showToast('Buscando modelo de Gemini...', 'warning');
                for (const modelo of MODELOS_A_PROBAR) {
                    respuesta = await probarModelo(modelo, contents);
                    if (respuesta) {
                        showToast(`¡Modelo ${modelo} funciona!`, 'success');
                        break;
                    }
                }
                if (!respuesta) respuesta = 'No pude conectar con la API de Gemini. 📖';
            } else {
                respuesta = await probarModelo(MODELO_FUNCIONAL, contents);
                if (!respuesta) {
                    localStorage.removeItem('gemini_modelo_funcional');
                    MODELO_FUNCIONAL = null;
                    return generarSinopsis(titulo, autor, idRegistro);
                }
            }
            cacheRespuestas[cacheKey] = respuesta;
            localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
            return { texto: respuesta, mostrarReservaBtn: false, mostrarSolicitudBtn: false };
        }

        // Mostrar sinopsis
        async function mostrarSinopsis(idRegistro, titulo, autor) {
            const sinopsisDiv = document.getElementById(`sinopsis-${idRegistro}`);
            sinopsisDiv.innerHTML = '<p style="font-style: italic; color: var(--text-secondary);">Generando sinopsis... 📖</p>';
            sinopsisDiv.style.display = 'block';
            const { texto } = await generarSinopsis(titulo, autor, idRegistro);
            const mensajeId = mensajeActualId++;
            const partes = dividirTexto(texto, 'sinopsis');
            respuestasPendientes[mensajeId] = partes;
            sinopsisDiv.innerHTML = marked.parse(sanitizeHTML(`**Sinopsis (Parte 1/${partes.length})**:\n${partes[0].texto}`));
            if (partes.length > 1) {
                const proseguirBtn = document.createElement('button');
                proseguirBtn.className = 'proseguir-btn';
                proseguirBtn.textContent = 'Proseguir sinopsis';
                proseguirBtn.setAttribute('aria-label', `Mostrar parte 2 de ${partes.length} de la sinopsis`);
                proseguirBtn.onclick = () => mostrarSiguienteParteSinopsis(idRegistro, mensajeId, 2, partes);
                sinopsisDiv.appendChild(proseguirBtn);
            }
        }

        // Mostrar siguiente parte de sinopsis
        function mostrarSiguienteParteSinopsis(idRegistro, mensajeId, parteActual, partes) {
            const sinopsisDiv = document.getElementById(`sinopsis-${idRegistro}`);
            if (parteActual <= partes.length) {
                sinopsisDiv.innerHTML = marked.parse(sanitizeHTML(`**Sinopsis (Parte ${parteActual}/${partes.length})**:\n${partes[parteActual - 1].texto}`));
                if (parteActual < partes.length) {
                    const proseguirBtn = document.createElement('button');
                    proseguirBtn.className = 'proseguir-btn';
                    proseguirBtn.textContent = 'Proseguir sinopsis';
                    proseguirBtn.setAttribute('aria-label', `Mostrar parte ${parteActual + 1} de ${partes.length}`);
                    proseguirBtn.onclick = () => mostrarSiguienteParteSinopsis(idRegistro, mensajeId, parteActual + 1, partes);
                    sinopsisDiv.appendChild(proseguirBtn);
                }
            }
        }

        // Extraer título de libro
        function extraerLibroDeConsulta(query) {
            const lowerQuery = normalizarTexto(query);
            const match = lowerQuery.match(/(?:de|sobre)\s+(.+)$/i);
            return match && match[1] ? match[1].trim() : lowerQuery.replace(/(cuantos|ejemplares|copias|disponibles|libros)/gi, '').trim();
        }

        // Abrir buscador
        function abrirBuscadorLibro(libro) {
            searchQuery = libro;
            searchResults = buscarLibros(libro);
            currentPageSearch = 1;
            abrirModal();
            mostrarResultadosModal();
        }

        // Dividir texto largo
        function dividirTexto(texto, tipo) {
            const maxLength = 500;
            const partes = [];
            let parteActual = '';
            let contadorPalabras = 0;
            const palabras = texto.split(' ');
            for (const palabra of palabras) {
                if (contadorPalabras + palabra.length > maxLength) {
                    partes.push({ tipo, texto: parteActual.trim() });
                    parteActual = palabra + ' ';
                    contadorPalabras = palabra.length + 1;
                } else {
                    parteActual += palabra + ' ';
                    contadorPalabras += palabra.length + 1;
                }
            }
            if (parteActual.trim()) partes.push({ tipo, texto: parteActual.trim() });
            return partes.length > 0 ? partes : [{ tipo, texto }];
        }

        // Mostrar siguiente parte del chatbot
        function mostrarSiguienteParte(mensajeId, parteActual) {
            const partes = respuestasPendientes[mensajeId];
            if (partes && parteActual <= partes.length) {
                const libroBuscado = partes[0].libroBuscado || null;
                const mostrarReservaBtn = partes[0].texto.includes('[RESERVA]');
                const mostrarSolicitudBtn = partes[0].texto.includes('[SOLICITUD]');
                agregarMensaje('', false, false, partes, mensajeId, parteActual, partes.length, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn);
            }
        }

        // Agregar mensaje al chatbot
        function agregarMensaje(texto, esUsuario = false, esTemporal = false, partes = null, mensajeId = null, parteActual = 1, totalPartes = 1, libroBuscado = null, mostrarReservaBtn = false, mostrarSolicitudBtn = false) {
            const chatMensajes = document.getElementById('chatMensajes');
            const mensajes = Array.from(chatMensajes.getElementsByClassName('mensaje'));
            while (mensajes.length >= 20) mensajes[0].remove();
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = `mensaje ${esUsuario ? 'user' : 'bot'}${esTemporal ? ' temporal' : ''}`;
            let mensajeTexto = esUsuario ? texto : texto;
            if (!esUsuario && !esTemporal && partes) {
                mensajeTexto = `**${partes[parteActual - 1].tipo.charAt(0).toUpperCase() + partes[parteActual - 1].tipo.slice(1)} (Parte ${parteActual}/${totalPartes})**:\n${partes[parteActual - 1].texto}`;
            }
            mensajeDiv.innerHTML = esUsuario ? sanitizeHTML(mensajeTexto) : marked.parse(sanitizeHTML(mensajeTexto));
            if (!esUsuario && !esTemporal) {
                if (partes && parteActual < totalPartes) {
                    const proseguirBtn = document.createElement('button');
                    proseguirBtn.className = 'proseguir-btn';
                    proseguirBtn.textContent = 'Proseguir';
                    proseguirBtn.setAttribute('aria-label', `Mostrar parte ${parteActual + 1} de ${totalPartes}`);
                    proseguirBtn.onclick = () => mostrarSiguienteParte(mensajeId, parteActual + 1);
                    mensajeDiv.appendChild(proseguirBtn);
                }
                if (libroBuscado) {
                    const buscarBtn = document.createElement('button');
                    buscarBtn.className = 'buscar-libro-btn';
                    buscarBtn.textContent = 'Abrir Catálogo 🔍';
                    buscarBtn.setAttribute('aria-label', `Buscar ${libroBuscado}`);
                    buscarBtn.onclick = () => abrirBuscadorLibro(libroBuscado);
                    mensajeDiv.appendChild(buscarBtn);
                }
                if (mostrarReservaBtn) {
                    const reservaBtn = document.createElement('button');
                    reservaBtn.className = 'reserva-libro-btn';
                    reservaBtn.textContent = 'Reserva 📚';
                    reservaBtn.setAttribute('aria-label', `Formulario de reserva`);
                    reservaBtn.onclick = () => window.open('https://docs.google.com/forms/d/e/1FAIpQLSeTUAdMIEZz0lP2qflcZgfIP2zhsU4sYJoQZYoJcmvUZRAQnw/viewform?usp=header', '_blank');
                    mensajeDiv.appendChild(reservaBtn);
                }
                if (mostrarSolicitudBtn) {
                    const solicitudBtn = document.createElement('button');
                    solicitudBtn.className = 'solicitud-libro-btn';
                    solicitudBtn.textContent = 'Solicitud 🗳️';
                    solicitudBtn.setAttribute('aria-label', `Formulario de solicitud`);
                    solicitudBtn.onclick = () => window.open('https://docs.google.com/forms/d/e/1FAIpQLSf_VH-Wmf7SC7geWNwoLhX1aqc_xy1LQ-fp-SFYdlOYIbTE-g/viewform?usp=header', '_blank');
                    mensajeDiv.appendChild(solicitudBtn);
                }
            }
            chatMensajes.appendChild(mensajeDiv);
            chatMensajes.scrollTop = chatMensajes.scrollHeight;
            if (!esTemporal) {
                historialMensajes.push({ role: esUsuario ? 'user' : 'assistant', content: texto });
                if (historialMensajes.length > 6) historialMensajes = historialMensajes.slice(-6);
            }
        }

        // Formatear resultados
        function formatearResultados(resultados, libroBuscado) {
            if (!resultados.length) {
                return {
                    texto: `No encontré "${libroBuscado}" en el catálogo. Usa **Solicitud de Libros Nuevos** para proponerlo. 📖 ¿Otro libro?`,
                    mostrarSolicitudBtn: true,
                    libroBuscado
                };
            }
            const libro = resultados[0];
            return {
                texto: `Hay ${libro.copiasTotales} ejemplares de "${libro.titulo}", ${libro.copiasDisponibles} disponibles. Usa **Reserva de Libros** para reservarlo. ¿Ver más detalles? 📖`,
                mostrarReservaBtn: true,
                libroBuscado
            };
        }

        // Generar recomendaciones
        function generarRecomendacion(intencion) {
            if (!catalogo.length) {
                return {
                    texto: 'Catálogo no disponible. Usa **Solicitud de Libros Nuevos** para proponer un libro. 📖 ¿Otro género?',
                    libroBuscado: null,
                    mostrarSolicitudBtn: true
                };
            }
            let librosFiltrados = catalogo;
            let descripcion = '';
            if (intencion === 'recomendacion_fantasia') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'narrativa');
                descripcion = 'una obra de narrativa para amantes de la fantasía.';
            } else if (intencion === 'recomendacion_poesia') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'poesia');
                descripcion = 'un poemario que captura emociones.';
            } else if (intencion === 'recomendacion_narrativa') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'narrativa');
                descripcion = 'una novela cautivadora.';
            } else if (intencion === 'recomendacion_teatro') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'teatro');
                descripcion = 'una obra teatral fascinante.';
            } else if (intencion === 'recomendacion_comic') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'cómic');
                descripcion = 'un cómic vibrante.';
            } else if (intencion === 'recomendacion_literatura_inglesa') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'literatura inglesa');
                descripcion = 'una obra en inglés rica en literatura.';
            } else if (intencion === 'recomendacion_deportes') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'deportes');
                descripcion = 'un libro apasionante sobre deportes.';
            } else {
                const categorias = ['Narrativa', 'Poesía', 'Teatro', 'Literatura inglesa', 'Enciclopedias', 'Cómic', 'Deportes'];
                const categoriaAleatoria = categorias[Math.floor(Math.random() * categorias.length)];
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === normalizarTexto(categoriaAleatoria));
                descripcion = `una obra de ${categoriaAleatoria.toLowerCase()}.`;
            }
            if (librosFiltrados.length === 0) {
                return {
                    texto: `No hay libros en esa categoría. Usa **Solicitud de Libros Nuevos** para proponer uno. 📖 ¿Otro tipo?`,
                    libroBuscado: null,
                    mostrarSolicitudBtn: true
                };
            }
            const libro = librosFiltrados[Math.floor(Math.random() * librosFiltrados.length)];
            const texto = `Te recomiendo *${libro.titulo}* de ${libro.autor} (${libro.categoria}). Es ${descripcion} ${libro.copiasDisponibles} disponibles. Usa **Reserva de Libros**. ¿Ver detalles? 📖`;
            return { texto, libroBuscado: libro.titulo, mostrarReservaBtn: true };
        }

        // Detectar intención
        function detectarIntencion(query) {
            return classifier.classify(normalizarTexto(query)) || 'general';
        }

        // Consultar API
        async function consultarAPI(mensaje, intencion, contexto) {
            const historialResumido = historialMensajes.length > 4 ?
                `Resumen: El usuario preguntó sobre ${historialMensajes.filter(m => m.role === 'user').map(m => m.content).join(', ')}.` :
                historialMensajes.map(msg => `${msg.role === 'user' ? 'Usuario' : 'Hipat-IA'}: ${msg.content}`).join('\n');
            const systemPrompt = `Eres Hipat-IA, bibliotecaria virtual del IES Carpe Diem. Responde en español con tono cálido y profesional. Usa el catálogo y el historial para respuestas relevantes.

**Contexto**:
${contexto}

**Historial**:
${historialResumido}

**Instrucciones**:
- **Sinopsis/Resumen/Reseña**: 100-200 palabras, usa catálogo o conocimiento general, termina con punto.
- **General**: Responde en 100-200 palabras, claro y completo.
- **Reservas**: Indica usar **Reserva de Libros** con [RESERVA].
- **Solicitar**: Indica usar **Solicitud de Libros Nuevos** con [SOLICITUD].
- Usa emojis 📖, termina con pregunta breve.

Pregunta: ${mensaje}`;
            const contents = [
                { parts: [{ text: systemPrompt }], role: 'model' },
                ...historialMensajes.map(msg => ({ parts: [{ text: msg.content }], role: msg.role === 'user' ? 'user' : 'model' })),
                { parts: [{ text: mensaje }], role: 'user' }
            ];
            let respuesta = null;
            if (!MODELO_FUNCIONAL || MODELO_FUNCIONAL === 'null') {
                showToast('Buscando modelo de Gemini...', 'warning');
                for (const modelo of MODELOS_A_PROBAR) {
                    respuesta = await probarModelo(modelo, contents);
                    if (respuesta) {
                        showToast(`¡Modelo ${modelo} funciona!`, 'success');
                        break;
                    }
                }
                if (!respuesta) respuesta = 'No pude conectar con la API. 📖';
            } else {
                respuesta = await probarModelo(MODELO_FUNCIONAL, contents);
                if (!respuesta) {
                    localStorage.removeItem('gemini_modelo_funcional');
                    MODELO_FUNCIONAL = null;
                    return consultarAPI(mensaje, intencion, contexto);
                }
            }
            return {
                texto: respuesta,
                mostrarReservaBtn: respuesta.includes('[RESERVA]'),
                mostrarSolicitudBtn: respuesta.includes('[SOLICITUD]')
            };
        }

        // Enviar mensaje al chatbot
        async function enviarMensaje() {
            if (!catalogo) {
                showToast('Catálogo cargando o no disponible. Intenta de nuevo.', 'warning');
                return;
            }
            const mensaje = sanitizeHTML(document.getElementById('chatInput').value.trim());
            if (!mensaje) {
                showToast('Escribe un mensaje.', 'warning');
                return;
            }
            agregarMensaje(mensaje, true);
            document.getElementById('chatInput').value = '';
            const escribiendoDiv = agregarMensaje('Hipat-IA está buscando... 📚', false, true);
            const intencion = detectarIntencion(mensaje);
            const cacheKey = `${intencion}_${normalizarTexto(mensaje)}`;
            const mensajeId = mensajeActualId++;

            if (intencion === 'ejemplares') {
                const libroBuscado = extraerLibroDeConsulta(mensaje);
                if (!libroBuscado) {
                    escribiendoDiv.remove();
                    agregarMensaje('No entendí el título. Ejemplo: "cuántos ejemplares hay de La Colmena". 📖');
                    return;
                }
                const resultados = buscarLibros(libroBuscado, true);
                escribiendoDiv.remove();
                const { texto, mostrarReservaBtn, mostrarSolicitudBtn, libroBuscado: libro } = formatearResultados(resultados, libroBuscado);
                const partes = dividirTexto(texto, 'respuesta');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, libro, mostrarReservaBtn, mostrarSolicitudBtn);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }

            if (['recomendaciones', 'recomendacion_fantasia', 'recomendacion_poesia', 'recomendacion_narrativa', 'recomendacion_teatro', 'recomendacion_comic', 'recomendacion_literatura_inglesa', 'recomendacion_deportes'].includes(intencion)) {
                escribiendoDiv.remove();
                const { texto, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn } = generarRecomendacion(intencion);
                const partes = dividirTexto(texto, 'recomendacion');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }

            if (intencion === 'reservas') {
                escribiendoDiv.remove();
                const texto = `Reserva un libro con **Reserva de Libros**. ¿Buscar un libro específico? 📖`;
                const partes = dividirTexto(texto, 'respuesta');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, true, false);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }

            if (intencion === 'solicitar') {
                escribiendoDiv.remove();
                const texto = `Propón un libro con **Solicitud de Libros Nuevos**. ¿Qué libro sugieres? 📖`;
                const partes = dividirTexto(texto, 'respuesta');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, false, true);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }

            if (cacheRespuestas[cacheKey]) {
                escribiendoDiv.remove();
                const partes = dividirTexto(cacheRespuestas[cacheKey], intencion);
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, cacheRespuestas[cacheKey].includes('[RESERVA]'), cacheRespuestas[cacheKey].includes('[SOLICITUD]'));
                return;
            }

            const resultadosCatalogo = buscarLibros(mensaje);
            const contexto = resultadosCatalogo.length > 0
                ? `Catálogo: ${resultadosCatalogo.map(l => `"${l.titulo}" de ${l.autor}, ${l.categoria}, ${l.copiasDisponibles} disponibles`).join('; ')}`
                : 'No hay resultados en el catálogo.';
            escribiendoDiv.remove();
            const { texto, mostrarReservaBtn, mostrarSolicitudBtn } = await consultarAPI(mensaje, intencion, contexto);
            const partes = dividirTexto(texto, intencion);
            respuestasPendientes[mensajeId] = partes;
            agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, mostrarReservaBtn, mostrarSolicitudBtn);
            cacheRespuestas[cacheKey] = texto;
            localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
        }

        // CAMBIO: Inicialización con manejo de errores mejorado
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                loadTheme();
                inicializarClasificador();
                // CAMBIO: Intentar cargar el catálogo con un tiempo máximo de 5 segundos
                await withTimeout(cargarCatalogo(), 5000);
                // CAMBIO: Mostrar la aplicación después de un máximo de 2 segundos, incluso si el catálogo falla
                setTimeout(() => {
                    mostrarApp();
                    if (!catalogo.length) {
                        showToast('No se pudo cargar el catálogo. Algunas funciones estarán limitadas.', 'warning');
                    }
                }, 2000);
            } catch (error) {
                console.error('Error en la inicialización:', error);
                document.getElementById('splash-message').textContent = 'Error al cargar. Continuando...';
                setTimeout(() => {
                    mostrarApp();
                    showToast('Error al inicializar la aplicación. Algunas funciones pueden no estar disponibles.', 'error');
                }, 2000);
            }
        });
    </script>
</body>
</html>