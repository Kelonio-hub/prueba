<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Prueba</title>
<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
.box{background:#fff;padding:20px;border-radius:10px;max-width:1200px;margin:auto}
.player{border:1px solid #ccc;margin-top:10px;padding:10px}
.log{background:#111;color:#0f0;padding:10px;height:200px;overflow:auto;font-size:12px}
.stat{font-size:14px;margin:5px 0}
.user{border:1px dashed #aaa;padding:10px;margin-top:10px}
.bar-container{background:#ccc;width:100%;height:10px;border-radius:5px;margin-top:5px}
.bar{background:#0f0;height:100%;width:0%;border-radius:5px}
.ip-box{background:#222;color:#0ff;padding:10px;border-radius:8px;margin-bottom:15px;font-size:14px}
</style>
</head>

<body>
<div class="box">
<h2>Prueba</h2>

<div class="ip-box">
<b>üåê IP actual:</b> <span id="ip">Cargando...</span>
</div>

<div id="sessions"></div>
<pre class="log" id="globalLog"></pre>
</div>

<script>
// ================= CONFIG =================
const PROFILES = {
  skipper: { min:180, max:300, cont:0.3 },
  casual:  { min:300, max:480, cont:0.6 },
  binger:  { min:480, max:900, cont:0.85 }
};

const NUM_INITIAL_USERS = 3;
const VIDEOS_PER_ID = 3;
const JUMP_PROB = 0.03;

// ================= UTIL =================
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=o=>Object.keys(o)[rand(0,Object.keys(o).length-1)];
const logGlobal=m=>{
  const l=document.getElementById("globalLog");
  l.textContent+=m+"\n";
  l.scrollTop=l.scrollHeight;
};

// ================= IP REAL =================
let currentIP = "Cargando...";

async function updateRealIP(){
  try {
    const res = await fetch('https://api.ipify.org?format=json');
    const data = await res.json();
    currentIP = data.ip;
    document.getElementById("ip").innerText = currentIP;
  } catch(e){
    console.error("No se pudo obtener IP:", e);
  }
}
updateRealIP();
setInterval(updateRealIP, 10000); // actualizar cada 10 s

// ================= URLS PREDEFINIDAS =================
const URLS = [
"https://www.youtube.com/watch?v=PVAJ0PNkZOY",
"https://www.youtube.com/watch?v=8GHDl5CaJak",
"https://www.youtube.com/watch?v=PO8R79_khyY",
"https://www.youtube.com/watch?v=dmis0r0zfgo",
"https://www.youtube.com/watch?v=Y9Q33T1ZQCA",
"https://www.youtube.com/watch?v=bxgEtnDPr8s",
"https://www.youtube.com/watch?v=7gWzxC1FG9s",
"https://www.youtube.com/watch?v=g0T9MUepaew",
"https://www.youtube.com/watch?v=agG4IJkg9uk",
"https://www.youtube.com/watch?v=BaB_n_6PB48",
"https://www.youtube.com/watch?v=9W0aODZAQXI",
"https://www.youtube.com/watch?v=IJBgGKUT8pk",
"https://www.youtube.com/watch?v=nxtm5D2W5uY",
"https://www.youtube.com/watch?v=KcECUBXV0dk",
"https://www.youtube.com/watch?v=jr3mB0U_eAs",
"https://www.youtube.com/watch?v=6U-Mc-nPitU",
"https://www.youtube.com/watch?v=phFxVWs7nBg",
"https://www.youtube.com/watch?v=TYymdrfkPt4",
"https://www.youtube.com/watch?v=ZzZZzdRevWY",
"https://www.youtube.com/watch?v=3bc0z8WZPnY",
"https://www.youtube.com/watch?v=K98b_GEKIQI",
"https://www.youtube.com/watch?v=B1lPa89JLnc",
"https://www.youtube.com/watch?v=puOYhpBch6w",
"https://www.youtube.com/watch?v=rSJGpBZtGfA",
"https://www.youtube.com/watch?v=ihOaZigO3Dc",
"https://www.youtube.com/watch?v=8Z0v_bcwWZ4",
"https://www.youtube.com/watch?v=sm5q-wke_ZA",
"https://www.youtube.com/watch?v=98gTZQCvxmA",
"https://www.youtube.com/watch?v=HrOw0jVuczU",
"https://www.youtube.com/watch?v=LgRAWhxUtIE",
"https://www.youtube.com/watch?v=1lOzNqlHGiQ",
"https://www.youtube.com/watch?v=Hr3MHaMypnI",
"https://www.youtube.com/watch?v=t7pVbWWkJpo",
"https://www.youtube.com/watch?v=bMnYoYa9flQ",
"https://www.youtube.com/watch?v=4OlP0CLJdGY",
"https://www.youtube.com/watch?v=ANKIGJCZDFg",
"https://www.youtube.com/watch?v=EdRX5HB0-xs",
"https://www.youtube.com/watch?v=ZnkHeuM5Pd0",
"https://www.youtube.com/watch?v=L5TgRr5Zre4",
"https://www.youtube.com/watch?v=7EuuLsNVuW0",
"https://www.youtube.com/watch?v=d0dhk_sTm8g",
"https://www.youtube.com/watch?v=1clOkDVWhoQ",
"https://www.youtube.com/watch?v=MQ6GjU_vtuA",
"https://www.youtube.com/watch?v=RgdWm2QNbsc",
"https://www.youtube.com/watch?v=RJEdSmnJ2nc",
"https://www.youtube.com/watch?v=k7SZs4wH0Gk",
"https://www.youtube.com/watch?v=yzeXL5DC5No",
"https://www.youtube.com/watch?v=V_zQJq7mF9A",
"https://www.youtube.com/watch?v=x7aZN-KMaf4",
"https://www.youtube.com/watch?v=zK_sM9L7Kl0",
"https://www.youtube.com/watch?v=Hlav-1FYOF0",
"https://www.youtube.com/watch?v=CPC93AwZsbg",
"https://www.youtube.com/watch?v=YG-rWbuoTvg",
"https://www.youtube.com/watch?v=eumgxZdighA",
"https://www.youtube.com/watch?v=wXTFPhBj1qU",
"https://www.youtube.com/watch?v=Zm9Uejl-3PE",
"https://www.youtube.com/watch?v=lo3Nyzb5vpk",
"https://www.youtube.com/watch?v=cmsAvvazgUk",
"https://www.youtube.com/watch?v=aqeLygkAWg8",
"https://www.youtube.com/watch?v=RIs5DifGYmc",
"https://www.youtube.com/watch?v=KtYmcO91Zzk",
"https://www.youtube.com/watch?v=6GROvOTf_B4",
"https://www.youtube.com/watch?v=FkPQfdWwGls",
"https://www.youtube.com/watch?v=34oQFo-rRjw",
"https://www.youtube.com/watch?v=hLOX5KFWUe8",
"https://www.youtube.com/watch?v=n6EP9rLCKD0",
"https://www.youtube.com/watch?v=kEG_Z8p-FhQ",
"https://www.youtube.com/watch?v=XODbdvhM6cw",
"https://www.youtube.com/watch?v=8bv94f2lC_E",
"https://www.youtube.com/watch?v=fqxY11qyr-E",
"https://www.youtube.com/watch?v=rsvfGzOO1kY",
"https://www.youtube.com/watch?v=4YJ-EB5i0x8",
"https://www.youtube.com/watch?v=DQYGKD9zpxM",
"https://www.youtube.com/watch?v=3kaKZRm0nAw",
"https://www.youtube.com/watch?v=o7vLmTusGo4",
"https://www.youtube.com/watch?v=GhKYWo8In6Y",
"https://www.youtube.com/watch?v=jBmMYJbEwKM",
"https://www.youtube.com/watch?v=HTojwb3kScY",
"https://www.youtube.com/watch?v=KjQJyIqa-lE",
"https://www.youtube.com/watch?v=EKVQyQ8PGfc",
"https://www.youtube.com/watch?v=CqrJ3fdQaP8",
"https://www.youtube.com/watch?v=Xe6qoIRUJao",
"https://www.youtube.com/watch?v=oJ8rqr-qrtA",
"https://www.youtube.com/watch?v=_ccxJLFLbKU",
"https://www.youtube.com/watch?v=a5MPaBoNXcA",
"https://www.youtube.com/watch?v=HWvqvpeHW0Y",
"https://www.youtube.com/watch?v=EjZKftGw8RU",
"https://www.youtube.com/watch?v=IaogHEIHAK8",
"https://www.youtube.com/watch?v=3oa7W946xg8",
"https://www.youtube.com/watch?v=14mJ61oHZdI",
"https://www.youtube.com/watch?v=XwE9WRYJXK0",
"https://www.youtube.com/watch?v=cXpDB15EICQ",
"https://www.youtube.com/watch?v=j_9V3mls1PI",
"https://www.youtube.com/watch?v=rXoBnjthPjo",
"https://www.youtube.com/watch?v=6igPel7dh3k",
"https://www.youtube.com/watch?v=dZqS63cvpsA",
"https://www.youtube.com/watch?v=Wdwl-S3zWkg",
"https://www.youtube.com/watch?v=LtvNS3uoP_8",
"https://www.youtube.com/watch?v=NEcBp5BhuJE",
"https://www.youtube.com/watch?v=a97sMylxr-8",
"https://www.youtube.com/watch?v=nuq6URbX4Vk",
"https://www.youtube.com/watch?v=F9593kcLHQE",
"https://www.youtube.com/watch?v=bSiJeI_3Q_8",
"https://www.youtube.com/watch?v=_bWT-Mv4n1k",
"https://www.youtube.com/watch?v=eh4vGEfh3SM",
"https://www.youtube.com/watch?v=x64mBqRQ7Ss",
"https://www.youtube.com/watch?v=OA74PsM7tNI",
"https://www.youtube.com/watch?v=SYF7XLVhuOc",
"https://www.youtube.com/watch?v=spedB6-Xfg4",
"https://www.youtube.com/watch?v=SwJl0UnLCSs",
"https://www.youtube.com/watch?v=fuD5KKXFkmY"
];

// ================= NORMALIZE =================
const normalize=u=>{
  const m=u.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
  return m?`https://www.youtube.com/embed/${m[1]}?autoplay=1`:u;
};

let nextUserID = 1;

// ================= USUARIO =================
class VirtualUser{
  constructor(urls){
    this.urls=urls.map(normalize);
    this.idx=rand(0,this.urls.length-1);
    this.videosWatchedThisID=0;
    this.id=nextUserID++;
    this.profile=pick(PROFILES);
    this.watched=0;
    this.interval=null;
    this.node=this.render();
  }

  render(){
    const d=document.createElement("div");
    d.className="user";
    d.innerHTML=`
      <div class="stat"><b>Usuario ${this.id}</b> ‚Äì Perfil: <span class="profile">${this.profile}</span></div>
      <div class="stat">IP usada: <span class="ip">${currentIP}</span></div>
      <div class="stat">Video: <span class="vid">-</span></div>
      <div class="stat">Tiempo visto: <span class="watched">0</span>s</div>
      <div class="player"></div>
      <div class="bar-container"><div class="bar"></div></div>
    `;
    document.getElementById("sessions").appendChild(d);
    return d;
  }

  rotateID(){
    if(this.videosWatchedThisID>=VIDEOS_PER_ID){
      const old=this.id;
      this.id=nextUserID++;
      this.videosWatchedThisID=0;
      this.node.querySelector("b").innerText=`Usuario ${this.id}`;
      logGlobal(`üîÅ Usuario ${old} ‚Üí Usuario ${this.id}`);
    }
  }

  play(){
    this.rotateID();
    this.node.querySelector(".ip").innerText=currentIP;

    const url=this.urls[this.idx];
    this.target=rand(PROFILES[this.profile].min,PROFILES[this.profile].max);
    this.watched=0;

    this.node.querySelector(".vid").innerText=`${this.idx+1}/${this.urls.length}`;
    const p=this.node.querySelector(".player");
    p.innerHTML="";
    const f=document.createElement("iframe");
    f.src=url; f.width="560"; f.height="315"; f.allow="autoplay; encrypted-media";
    p.appendChild(f);

    logGlobal(`‚ñ∂ Usuario ${this.id} reproduce video ${this.idx+1} (IP ${currentIP})`);
    this.interval=setInterval(()=>this.tick(),1000);
  }

  tick(){
    this.watched++;
    this.node.querySelector(".watched").innerText=this.watched;
    this.node.querySelector(".bar").style.width=`${(this.watched/this.target)*100}%`;

    if(this.watched>=this.target){
      clearInterval(this.interval);
      this.videosWatchedThisID++;
      this.idx=(this.idx+1)%this.urls.length;
      setTimeout(()=>this.play(),rand(500,1500));
    }
  }
}

// ================= MAIN =================
window.onload=()=>{
  for(let i=0;i<NUM_INITIAL_USERS;i++){
    const u=new VirtualUser(URLS);
    setTimeout(()=>u.play(),rand(0,3000));
  }
};
</script>
</body>
</html>
