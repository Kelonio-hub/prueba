<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Hipatia - IES CARPE DIEM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        (function(){
            emailjs.init("YOUR_USER_ID");
        })();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #loginSection {
            text-align: center;
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #app {
            display: none;
        }
        header {
            text-align: center;
            background-image: url('https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2024/03/carpediem-foto-inicio1920x1200c.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .admin-badge {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9em;
            margin-left: 10px;
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        .admin-badge:hover {
            background-color: #0056b3;
        }
        .notification-count {
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            font-size: 0.7em;
            padding: 2px 5px;
            min-width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -8px;
            right: -8px;
            font-weight: bold;
        }
        .email-section {
            margin-top: 10px;
            font-size: 0.9em;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            align-items: center;
        }
        .logout-btn, .web-ies-btn {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            color: white;
        }
        .logout-btn {
            background-color: #dc3545;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .web-ies-btn {
            background-color: #28a745;
        }
        .web-ies-btn:hover {
            background-color: #218838;
        }
        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .btn-reserva, .btn-recoger, .btn-devolver, .btn-anular, .btn-export {
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            border: none;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .btn-reserva {
            background-color: #28a745;
        }
        .btn-reserva:hover {
            background-color: #218838;
        }
        .btn-recoger {
            background-color: #ffc107;
            color: black;
        }
        .btn-recoger:hover {
            background-color: #e0a800;
        }
        .btn-devolver {
            background-color: #17a2b8;
        }
        .btn-devolver:hover {
            background-color: #138496;
        }
        .btn-anular {
            background-color: #dc3545;
        }
        .btn-anular:hover {
            background-color: #c82333;
        }
        .btn-export {
            background-color: #6f42c1;
        }
        .btn-export:hover {
            background-color: #5a2d91;
        }
        .libro {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        #perfil {
            background: #f8f9fa;
        }
        .lista-libros {
            margin: 10px 0;
        }
        .libro-perfil {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: white;
        }
        .fecha {
            font-size: 0.8em;
            color: #666;
        }
        .retrasado {
            color: red;
            font-weight: bold;
            background: #ffebee;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .estadisticas {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .estadisticas input {
            width: 50px;
            text-align: center;
        }
        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .mensaje {
            margin: 5px 0;
            padding: 5px;
        }
        .mensaje.user {
            background-color: #e3f2fd;
            text-align: right;
        }
        .mensaje.bot {
            background-color: #f1f8e9;
        }
        .estado-reservado {
            color: orange;
            font-weight: bold;
        }
        .estado-no-disponible {
            color: red;
            font-weight: bold;
        }
        .tejuelo {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 2px;
        }
        #conteoResultados {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #e9f5ff;
            border-radius: 4px;
        }
        #adminHistorial table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        #adminHistorial th, #adminHistorial td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #adminHistorial th {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        #adminHistorial th:hover {
            background-color: #0056b3;
        }
        #adminHistorial tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #adminHistorial tr:hover {
            background-color: #f1f1f1;
        }
        .sort-arrow::after {
            content: '';
            display: inline-block;
            margin-left: 5px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        .sort-arrow.asc::after {
            border-bottom: 5px solid white;
        }
        .sort-arrow.desc::after {
            border-top: 5px solid white;
        }
        #adminTabs {
            margin-bottom: 20px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .tab-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .tab-btn.active {
            background-color: #007bff;
            color: white;
            border-bottom: none;
        }
        .tab-btn.volver {
            background-color: #f0f0f0;
            color: black;
        }
        .tab-btn.volver:hover {
            background-color: #e0e0e0;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #adminApprovedEmails {
            margin-top: 20px;
        }
        #approvedEmailList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
        .email-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        .email-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .email-item button {
            margin-left: auto;
            padding: 2px 5px;
            font-size: 0.8em;
        }
        #emailSearch {
            width: 200px;
        }
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff25c8ff 0%, #1eff6d 50%, #f0ff22 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: rgb(0, 0, 0);
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
        }
        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-container {
            animation: fadeInContainer 1.5s ease-out;
        }
        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
            transition: transform 0.3s ease;
        }
        #splash img:hover {
            transform: scale(1.05);
        }
        #splash h2 {
            font-size: 2.8em;
            margin: 15px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.8s ease-out 1s both;
            letter-spacing: 1px;
        }
        #splash p {
            font-size: 1.3em;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }
        @keyframes fadeInContainer {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 768px) {
            #splash h2 { font-size: 2em; }
            #splash p { font-size: 1.1em; }
            #splash img { max-width: 180px; }
            #adminHistorial table { font-size: 0.9em; }
            #emailSearch { width: 100%; }
            .email-item { flex-direction: column; align-items: flex-start; }
            .email-item button { margin-left: 0; margin-top: 5px; }
            #adminTabs { flex-direction: column; gap: 2px; }
            .tab-btn { width: 100%; text-align: center; }
            .email-section { flex-direction: column; align-items: flex-end; gap: 5px; }
        }
        @media (prefers-reduced-motion: reduce) {
            #splash img, #splash h2, #splash p, .loader {
                animation: none !important;
                transition: none !important;
            }
        }
        .pagination {
            text-align: center;
            margin: 10px 0;
        }
        .pagination button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        .pagination span {
            font-weight: bold;
        }
        #solicitudTextarea {
            width: 100%;
            height: 150px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        #tendenciasTable {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        #tendenciasTable th, #tendenciasTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #tendenciasTable th {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div id="splash">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png" 
                 alt="Logo de la Biblioteca Hipatia" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvZ28gTm8gQ2FycmVnYWRvPC90ZXh0Pjwvc3ZnPg=='">
            <h2>¡Bienvenidos a la Biblioteca Hipatia!</h2>
            <p>Cargando el catálogo de libros y aventuras...</p>
            <div class="loader"></div>
        </div>
    </div>
    <div id="loginSection">
        <h2>Acceso a la Biblioteca</h2>
        <p>Solo usuarios @educa.madrid.org aprobados</p>
        <input type="email" id="loginEmail" placeholder="Introduce tu email @educa.madrid.org">
        <br>
        <button onclick="login()">Acceder</button>
        <p id="loginError" style="color: red; display: none;">Email inválido o no aprobado.</p>
    </div>
    <div id="app">
        <header>
            <h1>Catálogo de la Biblioteca Hipatia</h1>
            <p>IES Carpe Diem, Fuenlabrada</p>
            <div class="email-section">
                <span id="adminBadge" class="admin-badge" style="display: none;" onclick="mostrarHistorialAdmin()">
                    ADMIN
                    <span id="notificationCount" class="notification-count" style="display: none;"></span>
                </span>
                <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
                <button class="web-ies-btn" onclick="window.open('https://site.educa.madrid.org/ies.carpediem.fuenlabrada/', '_blank')">Web del IES</button>
            </div>
        </header>
        <main>
            <section id="perfil">
                <h2>Mi Perfil</h2>
                <div id="misReservas"></div>
                <div id="misPrestamos"></div>
                <div id="solicitudesLibros">
                    <h3>Solicitudes de Libros</h3>
                    <p>Indica qué libros te gustaría que se compraran para la biblioteca (máximo 500 palabras).</p>
                    <textarea id="solicitudTextarea" maxlength="500"></textarea>
                    <button onclick="enviarSolicitud()">Enviar Solicitud</button>
                </div>
            </section>
            <section id="busqueda">
                <h2>Buscar Libros</h2>
                <input type="text" id="buscarInput" placeholder="Busca por título, autor, tejuelo, categoría" onkeypress="if(event.key === 'Enter') buscarLibros()">
                <button onclick="buscarLibros()">Buscar</button>
                <div id="conteoResultados" style="display: none;"></div>
                <div id="resultados"></div>
            </section>
            <section id="chatbot">
                <h2>Hipat-IA: Tu Asistente Bibliotecario</h2>
                <p>Pregúntame por libros, recomendaciones, tu perfil o trivia. ¡Estoy aquí para ayudarte! 📖</p>
                <div id="chatMensajes"></div>
                <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." onkeypress="if(event.key === 'Enter') enviarMensaje()">
                <button onclick="enviarMensaje()">Enviar</button>
            </section>
            <section id="adminHistorial" style="display: none;">
                <h2>Administración</h2>
                <div id="adminTabs">
                    <button class="tab-btn active" onclick="showAdminTab('tareas')">Tareas Pendientes</button>
                    <button class="tab-btn" onclick="showAdminTab('historial')">Historial Completo</button>
                    <button class="tab-btn" onclick="showAdminTab('correos')">Gestión de Correos</button>
                    <button class="tab-btn" onclick="showAdminTab('solicitudes')">Solicitudes de Libros</button>
                    <button class="tab-btn" onclick="showAdminTab('alertas')">Alertas de Búsqueda</button>
                    <button class="tab-btn" onclick="showAdminTab('tendencias')">Tendencias de Búsqueda</button>
                    <button class="tab-btn volver" onclick="volverCatalogo()">Volver al Catálogo</button>
                </div>
                <div id="adminTabContent"></div>
            </section>
        </main>
    </div>
    <script type="text/javascript">
        var gk_isXlsx = true;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error('Error al procesar archivo:', e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
    <script>
        let catalogo = [];
        let reservas = {};
        let prestamos = {};
        let solicitudes = [];
        let approvedEmails = [];
        let alertasBusqueda = [];
        let infracciones = {};
        let consultasChat = [];
        let chatHistory = []; // Nuevo: History para Gemini (por sesión/user)
        let emailSesion = null;
        const EMAIL_ADMIN = 'rafael.casais@educa.madrid.org';
        const ANNO_ACTUAL = '2025';
        let sortColumn = 'fechaReserva';
        let sortDirection = 'desc';
        let sortColumnEmails = 'email';
        let sortDirectionEmails = 'asc';
        let sortColumnAlertas = 'fecha';
        let sortDirectionAlertas = 'desc';
        let currentPageHistorial = 1;
        let currentPageEmails = 1;
        let currentPageSolicitudes = 1;
        let currentPageAlertas = 1;

        // Configuración para Gemini API (Free Tier)
        const GEMINI_API_KEY = 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg';
        const LIMITE_IA_DIARIO = 10;

        // Lista de palabras clave prohibidas (cortafuegos)
        const palabrasProhibidas = [
            'porno', 'pornografía', 'adulto', 'sexo', 'erótico', 'xxx', 
            'actriz porno', 'contenido para adultos', 'desnudo', 'explícito',
            'mierda', 'joder', 'puta', 'coño', 'polla', 'cabrón', 'hostia', 'follar', 'cagar',
            'maricón', 'lesbiana', 'trans', 'viado', 'puto', 'zorra', 'imbécil', 'idiota',
            'gilipollas', 'cabrón', 'hijo de puta', 'me cago en', 'vete a la mierda'
        ];

        // System Prompt para Gemini (define Hipat-IA)
        const SYSTEM_PROMPT = `Eres Hipat-IA, el asistente bibliotecario de la Biblioteca Hipatia en el IES Carpe Diem, Fuenlabrada. Tu personalidad es amigable, entusiasta y educativa, como una bibliotecaria apasionada por la lectura. Siempre responde en español, con emojis relevantes (📚, 🎉, etc.), y mantén respuestas cortas (100-200 palabras).

Reglas estrictas:
- Enfócate SOLO en libros, lecturas, reservas, préstamos, recomendaciones, trivia literaria, resúmenes sin spoilers, metas de lectura, y temas educativos.
- Usa el CATÁLOGO proporcionado para búsquedas/recomendaciones: Incluye título, autor, categoría, tejuelo, ISBN, y disponibilidad. Sugiere "reservar" si disponible.
- Para "resumen [libro]": Resume en 100 palabras max, sin spoilers, + cita inspiradora.
- Para "trivia": Genera preguntas divertidas sobre libros del catálogo.
- Para perfil: Resume reservas/préstamos del USUARIO_PROFIL.
- Si pregunta por eventos: Menciona Día del Libro (23 abril) si aplica.
- Si no entiendes o es off-topic: Redirige gentilmente a libros ("¡Mejor hablemos de lecturas! ¿Qué buscas en el catálogo?").
- No uses info externa; basa todo en CATÁLOGO y USUARIO_PROFIL.

Ejemplos:
User: "Busca El Quijote"
You: "¡Claro! 'Don Quijote de la Mancha' de Cervantes está en Clásicos (tejuelo: CLA-001, ISBN 978-84-..., disponible). ¡Una aventura épica! ¿Lo reservas? 📖"

User: "Recomienda aventuras"
You: "¡Aventuras? Prueba 'El Quijote' (disponible) o 'Percy Jackson' (tejuelo: INF-456, en reserva). ¡Llenos de emoción! ¿Cuál te llama? 🎒"

User: "Resumen 1984"
You: " '1984' de Orwell: Distopía sobre vigilancia y verdad manipulada. Sin spoilers: Explora libertad vs. control. Cita: 'El Gran Hermano te está mirando.' ¡Impactante! ¿Lo lees?";

Mantén el tono positivo y educativo.`;

        // Función auxiliar para verificar si el mensaje es inapropiado
        function esMensajeInapropiado(mensaje) {
            const mensajeLower = mensaje.toLowerCase();
            return palabrasProhibidas.some(palabra => mensajeLower.includes(palabra));
        }

        // Función para loggear consultas útiles
        function logConsulta(query) {
            const hoy = new Date().toISOString().split('T')[0];
            const consulta = { query, email: emailSesion, fecha: new Date().toISOString(), dia: hoy };
            consultasChat.push(consulta);
            localStorage.setItem('consultasChat', JSON.stringify(consultasChat));
        }

        // Función para filtrar catálogo relevante (por query, para eficiencia en tokens)
        function filtrarCatalogoPorQuery(query) {
            if (!query) return catalogo.slice(0, 20); // Top 20 si no hay query
            const queryLower = query.toLowerCase();
            return catalogo.filter(libro => 
                libro.titulo.toLowerCase().includes(queryLower) ||
                libro.autor.toLowerCase().includes(queryLower) ||
                libro.categoria.toLowerCase().includes(queryLower)
            ).slice(0, 10); // Max 10 para Gemini
        }

        // Función para obtener perfil user como JSON
        function obtenerPerfilJSON() {
            const misReservas = reservas[emailSesion] || [];
            const misPrestamos = prestamos[emailSesion] || [];
            const retrasados = misPrestamos.filter(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto);
            return {
                reservas: misReservas.length,
                prestamos: misPrestamos.length,
                retrasados: retrasados.length,
                reservasLista: misReservas.map(r => r.titulo),
                prestamosLista: misPrestamos.map(p => ({titulo: p.titulo, fechaDevolucion: p.fechaDevolucion}))
            };
        }

        // Nueva: Enviar mensaje a Gemini
        async function enviarMensajeAGemini(mensajeUser) {
            const hoy = new Date().toDateString();
            const key = `geminiRequests_${emailSesion}_${hoy}`;
            let requests = parseInt(localStorage.getItem(key) || '0');
            if (requests >= LIMITE_IA_DIARIO) {
                return 'Límite diario alcanzado, regresa mañana. 😴 ¡Mañana más aventuras literarias!';
            }
            localStorage.setItem(key, (requests + 1).toString());

            // Filtrar catálogo relevante
            const catalogoRelevante = filtrarCatalogoPorQuery(mensajeUser).map(l => ({
                titulo: l.titulo,
                autor: l.autor,
                categoria: l.categoria,
                tejuelo: l.signatura.replace(/\s+/g, '-'),
                isbn: l.isbn,
                disponible: l.disponible ? 'Sí' : 'No'
            }));

            // Perfil user
            const perfilJSON = obtenerPerfilJSON();

            // History (últimos 5 turns para contexto)
            const recentHistory = chatHistory.slice(-10).map(msg => ({ role: msg.type === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] }));

            // Prompt completo
            const userPrompt = `Usuario: ${mensajeUser}

CATÁLOGO (usa solo esto para respuestas): ${JSON.stringify(catalogoRelevante, null, 2)}

USUARIO_PROFIL (reservas/préstamos actuales): ${JSON.stringify(perfilJSON, null, 2)}

${chequearEventoActual() ? `Evento actual: ${chequearEventoActual()}` : ''}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: 'model', parts: [{ text: SYSTEM_PROMPT }] }, // System prompt como primer "model"
                            ...recentHistory,
                            { role: 'user', parts: [{ text: userPrompt }] }
                        ]
                    })
                });
                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                const data = await response.json();
                const respuestaGemini = data.candidates[0].content.parts[0].text;

                // Actualizar history
                chatHistory.push({ type: 'user', text: mensajeUser });
                chatHistory.push({ type: 'bot', text: respuestaGemini });
                localStorage.setItem(`chatHistory_${emailSesion}`, JSON.stringify(chatHistory));

                return respuestaGemini;
            } catch (e) {
                console.error('Error en Gemini:', e);
                return `¡Ups! Hipat-IA está recargando su magia. 😅 Mientras, busca directamente en el catálogo. Si es sobre "${mensajeUser}", encontré ${catalogoRelevante.length} resultados. ¡Prueba de nuevo pronto!`;
            }
        }

        // Función principal del chat (reemplazada por Gemini)
        async function enviarMensaje() {
            if (!emailSesion) return;
            const input = document.getElementById('chatInput');
            const mensaje = input.value.trim();
            if (!mensaje) return;

            // Agregar mensaje user
            agregarMensaje(mensaje, 'user');
            input.value = '';

            // Cortafuegos: Bloquear antes de Gemini
            if (esMensajeInapropiado(mensaje)) {
                registrarAlertaBusqueda(mensaje);
                setTimeout(() => agregarMensaje('Lo siento, ese tema no es apropiado para nuestra biblioteca educativa. ¡Hablemos de libros! 📚', 'bot'), 800);
                return;
            }

            // Log si es consulta útil (cualquier msg no saludo/simple)
            if (mensaje.length > 3 && !mensaje.toLowerCase().includes('hola')) {
                logConsulta(mensaje);
            }

            // Proactivo para retrasados (local, antes de Gemini)
            if (chatHistory.length === 0 && emailSesion !== EMAIL_ADMIN) {
                const misPrestamos = prestamos[emailSesion] || [];
                const retrasados = misPrestamos.filter(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto);
                if (retrasados.length > 0) {
                    const proactivo = `¡Hola! Veo que tienes ${retrasados.length} libro(s) retrasado(s): ${retrasados.map(p => p.titulo).join(', ')}. Por favor, devuélvelos pronto. ¿En qué te ayudo con lecturas? 📖`;
                    agregarMensaje(proactivo, 'bot');
                    chatHistory.push({ type: 'bot', text: proactivo });
                    localStorage.setItem(`chatHistory_${emailSesion}`, JSON.stringify(chatHistory));
                    return;
                }
            }

            // Llamar a Gemini
            const respuesta = await enviarMensajeAGemini(mensaje);
            setTimeout(() => agregarMensaje(respuesta, 'bot'), 800); // Delay para "pensando"
        }

        function agregarMensaje(texto, tipo) {
            const div = document.getElementById('chatMensajes');
            const p = document.createElement('p');
            p.className = `mensaje ${tipo}`;
            p.textContent = texto;
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        }

        // Función para chequear eventos
        function chequearEventoActual() {
            const hoy = new Date();
            if (hoy.getMonth() === 3 && hoy.getDate() === 23) {
                return '¡Hoy es el Día del Libro! Te recomiendo clásicos como "Don Quijote" de Cervantes.';
            }
            return '';
        }

        // Cargar history al login
        function cargarChatHistory() {
            chatHistory = JSON.parse(localStorage.getItem(`chatHistory_${emailSesion}`) || '[]');
            // Recrear UI desde history
            document.getElementById('chatMensajes').innerHTML = '';
            chatHistory.forEach(msg => agregarMensaje(msg.text, msg.type));
        }

        // En logout: Limpiar history si quieres (o mantener para persistencia)
        function logout() {
            // ... (igual)
            chatHistory = [];
            localStorage.removeItem(`chatHistory_${emailSesion}`);
            // resto igual
        }

        // En login: Después de cargarPerfil, llamar cargarChatHistory();

        function login() {
            // ... (igual hasta cargarPerfil y cargarCatalogo)
            cargarPerfil();
            cargarCatalogo();
            if (emailSesion) cargarChatHistory(); // Nuevo
        }

        // ... (resto de funciones: cargarDatos incluye consultasChat y chatHistory; guardarDatos igual)
        function cargarDatos() {
            // ... (igual, más:)
            const consultasGuardadas = localStorage.getItem('consultasChat');
            if (consultasGuardadas) consultasChat = JSON.parse(consultasGuardadas);
            // chatHistory se carga en login
            // resto igual
        }

        function guardarDatos() {
            // ... (igual, más:)
            localStorage.setItem('consultasChat', JSON.stringify(consultasChat));
            // resto igual
        }

        // Admin tendencias (igual que antes)
        function getTendenciasBusqueda() {
            let html = '<h3>Tendencias de Búsqueda en Chat</h3>';
            const hoy = new Date().toISOString().split('T')[0];
            const consultasHoy = consultasChat.filter(c => c.dia === hoy);
            const conteo = {};
            consultasHoy.forEach(c => conteo[c.query] = (conteo[c.query] || 0) + 1);
            const sorted = Object.entries(conteo).sort((a, b) => b[1] - a[1]).slice(0, 10);

            html += `<table id="tendenciasTable">
                <thead><tr><th>Query</th><th>Veces</th><th>Usuarios</th></tr></thead>
                <tbody>${sorted.map(([query, count]) => {
                    const usuariosUnicos = [...new Set(consultasHoy.filter(c => c.query === query).map(c => c.email))].length;
                    return `<tr><td>${query}</td><td>${count}</td><td>${usuariosUnicos}</td></tr>`;
                }).join('') || '<tr><td colspan="3">No hay tendencias hoy.</td></tr>'}
                </tbody>
            </table>`;
            html += `<button class="btn-export" onclick="exportTendenciasCSV()">Exportar a CSV</button>`;
            return html;
        }

        function exportTendenciasCSV() {
            const hoy = new Date().toISOString().split('T')[0];
            const consultasHoy = consultasChat.filter(c => c.dia === hoy);
            const csv = 'Query,Veces,Usuarios\n' + Object.entries(consultasHoy.reduce((acc, c) => { acc[c.query] = (acc[c.query] || 0) + 1; return acc; }, {})).map(([q, v]) => `${q},${v},${[...new Set(consultasHoy.filter(c => c.query === q).map(c => c.email))].length}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tendencias_${hoy}.csv`;
            a.click();
        }

        function showAdminTab(tabId) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = Array.from(tabs).find(tab => tab.onclick.toString().includes(tabId));
            if (activeTab) activeTab.classList.add('active');

            const contentDiv = document.getElementById('adminTabContent');
            if (tabId === 'tareas') {
                contentDiv.innerHTML = getTareasPendientes();
            } else if (tabId === 'historial') {
                contentDiv.innerHTML = getHistorialCompleto();
            } else if (tabId === 'correos') {
                contentDiv.innerHTML = getGestionCorreos();
                cargarApprovedEmails();
            } else if (tabId === 'solicitudes') {
                contentDiv.innerHTML = getSolicitudesLibros();
            } else if (tabId === 'alertas') {
                contentDiv.innerHTML = getAlertasBusqueda();
            } else if (tabId === 'tendencias') {
                contentDiv.innerHTML = getTendenciasBusqueda();
            }
        }

        // ... (resto del código: getTareasPendientes, getHistorialCompleto, etc., permanecen iguales - omitidos por brevedad, pero inclúyelos del código anterior)

        cargarDatos();
        const emailSesionGuardada = sessionStorage.getItem('emailSesion');
        if (emailSesionGuardada) {
            emailSesion = emailSesionGuardada;
            // ... (igual)
            if (emailSesion) cargarChatHistory();
        }

        setTimeout(function() {
            const splash = document.getElementById('splash');
            splash.classList.add('hidden');
            setTimeout(function() { splash.remove(); }, 500);
        }, 3000);
    </script>
</body>
</html>