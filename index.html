<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Hipatia - IES CARPE DIEM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        (function(){
            emailjs.init("YOUR_USER_ID");
        })();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #loginSection {
            text-align: center;
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #app {
            display: none;
        }
        header {
            text-align: center;
            background-image: url('https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2024/03/carpediem-foto-inicio1920x1200c.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .admin-badge {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9em;
            margin-left: 10px;
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        .admin-badge:hover {
            background-color: #0056b3;
        }
        .notification-count {
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            font-size: 0.7em;
            padding: 2px 5px;
            min-width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -8px;
            right: -8px;
            font-weight: bold;
        }
        .email-section {
            margin-top: 10px;
            font-size: 0.9em;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            align-items: center;
        }
        .logout-btn, .web-ies-btn {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            color: white;
        }
        .logout-btn {
            background-color: #dc3545;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .web-ies-btn {
            background-color: #28a745;
        }
        .web-ies-btn:hover {
            background-color: #218838;
        }
        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .btn-reserva, .btn-recoger, .btn-devolver, .btn-anular {
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            border: none;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .btn-reserva {
            background-color: #28a745;
        }
        .btn-reserva:hover {
            background-color: #218838;
        }
        .btn-recoger {
            background-color: #ffc107;
            color: black;
        }
        .btn-recoger:hover {
            background-color: #e0a800;
        }
        .btn-devolver {
            background-color: #17a2b8;
        }
        .btn-devolver:hover {
            background-color: #138496;
        }
        .btn-anular {
            background-color: #dc3545;
        }
        .btn-anular:hover {
            background-color: #c82333;
        }
        .libro {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        #perfil {
            background: #f8f9fa;
        }
        .lista-libros {
            margin: 10px 0;
        }
        .libro-perfil {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: white;
        }
        .fecha {
            font-size: 0.8em;
            color: #666;
        }
        .retrasado {
            color: red;
            font-weight: bold;
            background: #ffebee;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .estadisticas {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .estadisticas input {
            width: 50px;
            text-align: center;
        }
        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .mensaje {
            margin: 5px 0;
            padding: 5px;
        }
        .mensaje.user {
            background-color: #e3f2fd;
            text-align: right;
        }
        .mensaje.bot {
            background-color: #f1f8e9;
        }
        .estado-reservado {
            color: orange;
            font-weight: bold;
        }
        .estado-no-disponible {
            color: red;
            font-weight: bold;
        }
        .tejuelo {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 2px;
        }
        #conteoResultados {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #e9f5ff;
            border-radius: 4px;
        }
        #adminHistorial table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        #adminHistorial th, #adminHistorial td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #adminHistorial th {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        #adminHistorial th:hover {
            background-color: #0056b3;
        }
        #adminHistorial tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #adminHistorial tr:hover {
            background-color: #f1f1f1;
        }
        .sort-arrow::after {
            content: '';
            display: inline-block;
            margin-left: 5px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }
        .sort-arrow.asc::after {
            border-bottom: 5px solid white;
        }
        .sort-arrow.desc::after {
            border-top: 5px solid white;
        }
        #adminTabs {
            margin-bottom: 20px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .tab-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .tab-btn.active {
            background-color: #007bff;
            color: white;
            border-bottom: none;
        }
        .tab-btn.volver {
            background-color: #f0f0f0;
            color: black;
        }
        .tab-btn.volver:hover {
            background-color: #e0e0e0;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #adminApprovedEmails {
            margin-top: 20px;
        }
        #approvedEmailList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
        .email-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        .email-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .email-item button {
            margin-left: auto;
            padding: 2px 5px;
            font-size: 0.8em;
        }
        #emailSearch {
            width: 200px;
        }
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff25c8ff 0%, #1eff6d 50%, #f0ff22 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: rgb(0, 0, 0);
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
        }
        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-container {
            animation: fadeInContainer 1.5s ease-out;
        }
        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
            transition: transform 0.3s ease;
        }
        #splash img:hover {
            transform: scale(1.05);
        }
        #splash h2 {
            font-size: 2.8em;
            margin: 15px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.8s ease-out 1s both;
            letter-spacing: 1px;
        }
        #splash p {
            font-size: 1.3em;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }
        @keyframes fadeInContainer {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 768px) {
            #splash h2 { font-size: 2em; }
            #splash p { font-size: 1.1em; }
            #splash img { max-width: 180px; }
            #adminHistorial table { font-size: 0.9em; }
            #emailSearch { width: 100%; }
            .email-item { flex-direction: column; align-items: flex-start; }
            .email-item button { margin-left: 0; margin-top: 5px; }
            #adminTabs { flex-direction: column; gap: 2px; }
            .tab-btn { width: 100%; text-align: center; }
            .email-section { flex-direction: column; align-items: flex-end; gap: 5px; }
        }
        @media (prefers-reduced-motion: reduce) {
            #splash img, #splash h2, #splash p, .loader {
                animation: none !important;
                transition: none !important;
            }
        }
        .pagination {
            text-align: center;
            margin: 10px 0;
        }
        .pagination button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        .pagination span {
            font-weight: bold;
        }
        #solicitudTextarea {
            width: 100%;
            height: 150px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div id="splash">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png" 
                 alt="Logo de la Biblioteca Hipatia" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvZ28gTm8gQ2FycmVnYWRvPC90ZXh0Pjwvc3ZnPg=='">
            <h2>¡Bienvenidos a la Biblioteca Hipatia!</h2>
            <p>Cargando el catálogo de libros y aventuras...</p>
            <div class="loader"></div>
        </div>
    </div>
    <div id="loginSection">
        <h2>Acceso a la Biblioteca</h2>
        <p>Solo usuarios @educa.madrid.org aprobados</p>
        <input type="email" id="loginEmail" placeholder="Introduce tu email @educa.madrid.org">
        <br>
        <button onclick="login()">Acceder</button>
        <p id="loginError" style="color: red; display: none;">Email inválido o no aprobado.</p>
    </div>
    <div id="app">
        <header>
            <h1>Catálogo de la Biblioteca Hipatia</h1>
            <p>IES Carpe Diem, Fuenlabrada</p>
            <div class="email-section">
                <span id="adminBadge" class="admin-badge" style="display: none;" onclick="mostrarHistorialAdmin()">
                    ADMIN
                    <span id="notificationCount" class="notification-count" style="display: none;"></span>
                </span>
                <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
                <button class="web-ies-btn" onclick="window.open('https://site.educa.madrid.org/ies.carpediem.fuenlabrada/', '_blank')">Web del IES</button>
            </div>
        </header>
        <main>
            <section id="perfil">
                <h2>Mi Perfil</h2>
                <div id="misReservas"></div>
                <div id="misPrestamos"></div>
                <div id="solicitudesLibros">
                    <h3>Solicitudes de Libros</h3>
                    <p>Indica qué libros te gustaría que se compraran para la biblioteca (máximo 500 palabras).</p>
                    <textarea id="solicitudTextarea" maxlength="500"></textarea>
                    <button onclick="enviarSolicitud()">Enviar Solicitud</button>
                </div>
            </section>
            <section id="busqueda">
                <h2>Buscar Libros</h2>
                <input type="text" id="buscarInput" placeholder="Busca por título, autor, tejuelo, categoría" onkeypress="if(event.key === 'Enter') buscarLibros()">
                <button onclick="buscarLibros()">Buscar</button>
                <div id="conteoResultados" style="display: none;"></div>
                <div id="resultados"></div>
            </section>
            <section id="chatbot">
                <h2>Hipat-IA: Tu Asistente Bibliotecario</h2>
                <p>Pregúntame por libros, recomendaciones, tu perfil o trivia. ¡Estoy aquí para ayudarte! 📖</p>
                <div id="chatMensajes"></div>
                <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." onkeypress="if(event.key === 'Enter') enviarMensaje()">
                <button onclick="enviarMensaje()">Enviar</button>
            </section>
            <section id="adminHistorial" style="display: none;">
                <h2>Administración</h2>
                <div id="adminTabs">
                    <button class="tab-btn active" onclick="showAdminTab('tareas')">Tareas Pendientes</button>
                    <button class="tab-btn" onclick="showAdminTab('historial')">Historial Completo</button>
                    <button class="tab-btn" onclick="showAdminTab('correos')">Gestión de Correos</button>
                    <button class="tab-btn" onclick="showAdminTab('solicitudes')">Solicitudes de Libros</button>
                    <button class="tab-btn" onclick="showAdminTab('alertas')">Alertas de Búsqueda</button>
                    <button class="tab-btn volver" onclick="volverCatalogo()">Volver al Catálogo</button>
                </div>
                <div id="adminTabContent"></div>
            </section>
        </main>
    </div>
    <script type="text/javascript">
        var gk_isXlsx = true;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error('Error al procesar archivo:', e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
    <script>
        let catalogo = [];
        let reservas = {};
        let prestamos = {};
        let solicitudes = [];
        let approvedEmails = [];
        let alertasBusqueda = [];
        let infracciones = {};
        let emailSesion = null;
        const EMAIL_ADMIN = 'rafael.casais@educa.madrid.org';
        const ANNO_ACTUAL = '2025';
        let sortColumn = 'fechaReserva';
        let sortDirection = 'desc';
        let sortColumnEmails = 'email';
        let sortDirectionEmails = 'asc';
        let sortColumnAlertas = 'fecha';
        let sortDirectionAlertas = 'desc';
        let currentPageHistorial = 1;
        let currentPageEmails = 1;
        let currentPageSolicitudes = 1;
        let currentPageAlertas = 1;
        let chatIniciado = false;

        // Configuración para Gemini API (Free Tier)
        const GEMINI_API_KEY = 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg';
        const LIMITE_IA_DIARIO = 10;

        // Lista de palabras clave prohibidas (expandida para cortafuegos educativo: contenido adulto + malsonantes en español)
        const palabrasProhibidas = [
            'porno', 'pornografía', 'adulto', 'sexo', 'erótico', 'xxx', 
            'actriz porno', 'contenido para adultos', 'desnudo', 'explícito',
            'mierda', 'joder', 'puta', 'coño', 'polla', 'cabrón', 'hostia', 'follar', 'cagar',
            'maricón', 'lesbiana', 'trans', 'viado', 'puto', 'zorra', 'imbécil', 'idiota',
            'gilipollas', 'cabrón', 'hijo de puta', 'me cago en', 'vete a la mierda'
        ];

        // Lista de palabras clave válidas relacionadas con libros y la biblioteca
        const palabrasClaveValidas = [
            'libro', 'autor', 'título', 'reserva', 'préstamo', 'busca', 'recomienda', 
            'trivia', 'resumen', 'meta', 'secuencia', 'vota', 'encuesta', 'flash', 
            'historia', 'huella', 'multimedia', 'perfil', 'categoría', 'tejuelo', 'isbn'
        ];

        // Función auxiliar para verificar si el mensaje es inapropiado (cortafuegos)
        function esMensajeInapropiado(mensaje) {
            const mensajeLower = mensaje.toLowerCase();
            return palabrasProhibidas.some(palabra => mensajeLower.includes(palabra));
        }

        // Función auxiliar para verificar si el mensaje está relacionado con libros
        function esMensajeRelacionadoConLibros(mensaje) {
            const mensajeLower = mensaje.toLowerCase();
            return palabrasClaveValidas.some(palabra => mensajeLower.includes(palabra)) ||
                   catalogo.some(libro => 
                       mensajeLower.includes(libro.titulo.toLowerCase()) ||
                       mensajeLower.includes(libro.autor.toLowerCase()) ||
                       mensajeLower.includes(libro.categoria.toLowerCase()));
        }

        // Función para registrar alertas de búsqueda
        function registrarAlertaBusqueda(mensaje) {
            const palabraBloqueada = palabrasProhibidas.find(palabra => mensaje.toLowerCase().includes(palabra)) || 'No relacionada';
            const alerta = {
                email: emailSesion,
                mensaje,
                palabraBloqueada,
                fecha: new Date().toISOString()
            };
            alertasBusqueda.push(alerta);
            localStorage.setItem('alertasBusqueda', JSON.stringify(alertasBusqueda));

            // Contar infracciones
            if (!infracciones[emailSesion]) infracciones[emailSesion] = 0;
            infracciones[emailSesion]++;
            localStorage.setItem('infracciones', JSON.stringify(infracciones));

            // Expulsar al usuario tras 3 infracciones
            if (infracciones[emailSesion] >= 3) {
                approvedEmails = approvedEmails.filter(e => e !== emailSesion);
                localStorage.setItem('approvedEmails', JSON.stringify(approvedEmails));
                emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                    to_email: emailSesion,
                    subject: 'Expulsión del Sistema de Biblioteca',
                    message: 'Has sido expulsado del sistema de la Biblioteca Hipatia por realizar consultas inapropiadas. Contacta al administrador para ser readmitido.'
                }).catch(() => {
                    const subject = encodeURIComponent('Expulsión del Sistema de Biblioteca');
                    const body = encodeURIComponent('Has sido expulsado del sistema de la Biblioteca Hipatia por realizar consultas inapropiadas. Contacta al administrador para ser readmitido.');
                    window.location.href = `mailto:${emailSesion}?subject=${subject}&body=${body}`;
                });
                logout();
            }

            // Notificar al administrador
            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                to_email: EMAIL_ADMIN,
                subject: 'Alerta: Consulta Inapropiada Detectada',
                message: `Usuario ${emailSesion} intentó: "${mensaje}" (Palabra bloqueada: ${palabraBloqueada})`
            }).catch(() => {
                console.error('Error al enviar alerta al administrador');
            });

            updateNotificationBadge();
        }

        // Función para obtener curso de email
        function obtenerCursoDeEmail(email) {
            const partes = email.split('@')[0].split('.');
            return partes.length > 1 ? partes[partes.length - 1].toUpperCase() : 'DESCONOCIDO';
        }

        // Función para obtener libros populares
        function obtenerLibrosPopulares(topN = 3) {
            let historial = [];
            Object.keys(prestamos).forEach(email => {
                (prestamos[email] || []).forEach(p => {
                    if (p.fechaPrestamo) historial.push(p.titulo);
                });
            });
            const conteo = {};
            historial.forEach(titulo => conteo[titulo] = (conteo[titulo] || 0) + 1);
            return Object.entries(conteo)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([titulo]) => titulo);
        }

        // Función para buscar en catálogo
        function buscarEnCatalogo(query) {
            const resultados = catalogo.filter(libro => 
                libro.titulo.toLowerCase().includes(query.toLowerCase()) ||
                libro.autor.toLowerCase().includes(query.toLowerCase())
            );
            if (resultados.length > 0) {
                return resultados.slice(0, 3).map(l => `${l.titulo} de ${l.autor} (${l.disponible ? 'Disponible' : 'No disponible'})`).join('\n');
            }
            return 'No encontré nada con ese término en el catálogo. ¡Prueba con otro título o autor!';
        }

        // Función para recomendaciones por mood/interés
        function recomendacionesPorInteres(interes) {
            const mappings = {
                'alegre': ['aventura', 'humor', 'infantil'],
                'historia': ['histórica', 'biografía'],
                'misterio': ['policiaca', 'suspense'],
                'romance': ['romántica'],
                'ciencia': ['ciencia ficción']
            };
            const categorias = mappings[interes.toLowerCase()] || ['general'];
            const matches = catalogo.filter(libro => categorias.some(cat => libro.categoria.toLowerCase().includes(cat)));
            if (matches.length > 0) {
                return matches.slice(0, 3).map(l => `${l.titulo} de ${l.autor}`).join('\n');
            }
            return 'No tengo recomendaciones específicas para eso, pero prueba con "populares" para tendencias.';
        }

        // Función para recomendaciones por curso
        function recomendacionesPorCurso(cursoUsuario) {
            let prestamosPorCurso = {};
            Object.keys(prestamos).forEach(email => {
                const curso = obtenerCursoDeEmail(email);
                if (curso === cursoUsuario) {
                    (prestamos[email] || []).forEach(p => {
                        if (p.titulo) {
                            prestamosPorCurso[p.titulo] = (prestamosPorCurso[p.titulo] || 0) + 1;
                        }
                    });
                }
            });
            const populares = Object.entries(prestamosPorCurso)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([titulo]) => titulo);
            return populares.length > 0 ? populares.join('\n') : 'No hay tendencias en tu curso aún. ¡Sé el primero en prestar!';
        }

        // Función para trivia
        function generarTrivia() {
            if (catalogo.length === 0) return 'El catálogo no está cargado aún. ¡Inténtalo más tarde!';
            const libroAleatorio = catalogo[Math.floor(Math.random() * catalogo.length)];
            const preguntas = [
                `¿Quién escribió "${libroAleatorio.titulo}"?`,
                `¿En qué categoría está "${libroAleatorio.titulo}"?`,
                `¿Cuál es el autor de un libro con título como "${libroAleatorio.titulo.substring(0, 10)}..."?`
            ];
            const pregunta = preguntas[Math.floor(Math.random() * preguntas.length)];
            return `${pregunta} (Respuesta: ${libroAleatorio.autor})`;
        }

        // Función para chequear eventos
        function chequearEventoActual() {
            const hoy = new Date();
            if (hoy.getMonth() === 3 && hoy.getDate() === 23) {
                return '¡Hoy es el Día del Libro! Te recomiendo clásicos como "Don Quijote" de Cervantes o algo de tu catálogo favorito.';
            }
            return '';
        }

        // Resúmenes estáticos
        const resúmenesEstaticos = {
            'El Quijote': { resumen: 'Aventura épica de un hidalgo soñador que lucha contra molinos de viento, explorando temas de realidad e ilusión.', cita: '"La libertad, Sancho, es uno de los más preciosos dones que los cielos han dado a los hombres." - Cervantes' },
            '1984': { resumen: 'Distopía totalitaria donde el Gran Hermano vigila todo, advirtiendo sobre el control y la verdad manipulada.', cita: '"El Gran Hermano te está mirando." - Orwell' },
            'El Principito': { resumen: 'Fábula poética sobre un niño de otro planeta que enseña lecciones de vida, amistad y lo esencial invisible.', cita: '"Lo esencial es invisible a los ojos." - Saint-Exupéry' }
        };

        async function generarResumenConIA(libro) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg') {
                return 'IA no configurada. Usa resúmenes estáticos por ahora.';
            }
            const hoy = new Date().toDateString();
            const key = `geminiRequests_${emailSesion}_${hoy}`;
            let requests = parseInt(localStorage.getItem(key) || '0');
            if (requests >= LIMITE_IA_DIARIO) {
                return 'límite diario alcanzado, regrese mañana.';
            }
            localStorage.setItem(key, (requests + 1).toString());
            const prompt = `Resume "${libro.titulo}" de ${libro.autor} en 100 palabras máximo, sin spoilers, en español. Incluye una cita inspiradora al final.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('Error en API');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error('Error en Gemini:', e);
                return resúmenesEstaticos[libro.titulo]?.resumen + '\n' + resúmenesEstaticos[libro.titulo]?.cita || 'No tengo resumen disponible ahora. ¡Busca en el catálogo!';
            }
        }

        function manejarMetaLectura(meta) {
            const metas = JSON.parse(localStorage.getItem(`metasLectura_${emailSesion}`) || '{}');
            if (meta) {
                metas.objetivo = parseInt(meta) || 5;
                metas.progreso = 0;
                metas.fechaInicio = new Date().toISOString();
                localStorage.setItem(`metasLectura_${emailSesion}`, JSON.stringify(metas));
                return `¡Meta establecida: ${metas.objetivo} libros este mes! Actualizaré tu progreso con cada préstamo. ¡Vamos! 📈`;
            }
            const progreso = metas.progreso || 0;
            return `Tu meta: ${metas.objetivo || 'Ninguna'} libros. Progreso: ${progreso}/${metas.objetivo || 0}. ${progreso >= (metas.objetivo || 0) ? '¡Felicidades, meta alcanzada! 🎉' : 'Sigue así.'}`;
        }

        const secuenciasLectura = {
            'Harry Potter': ['Percy Jackson', 'Crónicas de Narnia', 'El Nombre del Viento'],
            'El Quijote': ['Don Juan Tenorio', 'La Celestina', 'Cien años de soledad']
        };
        function obtenerSecuencia(libro) {
            const sugerencias = secuenciasLectura[libro] || ['Otro clásico similar'];
            return `Secuencia recomendada tras "${libro}":\n${sugerencias.join('\n- ')}\nRazones: Temas de aventura y crecimiento.`;
        }

        function manejarEncuesta(pregunta, opcion) {
            const encuestas = JSON.parse(localStorage.getItem('encuestasBiblioteca') || '{}');
            if (!encuestas[pregunta]) encuestas[pregunta] = {};
            encuestas[pregunta][opcion] = (encuestas[pregunta][opcion] || 0) + 1;
            localStorage.setItem('encuestasBiblioteca', JSON.stringify(encuestas));
            const total = Object.values(encuestas[pregunta]).reduce((a, b) => a + b, 0);
            return `¡Voto registrado para "${opcion}" en "${pregunta}"! Resultados: ${opcion} tiene ${encuestas[pregunta][opcion]} votos (${Math.round((encuestas[pregunta][opcion] / total) * 100)}%). Total votos: ${total}.`;
        }

        function generarFlashcard(libro) {
            const flashcards = [
                { q: `¿Tema principal de "${libro.titulo}"?`, r: 'Exploración de realidad vs. ilusión.' },
                { q: `¿Autor de "${libro.titulo}"?`, r: libro.autor }
            ];
            const random = flashcards[Math.floor(Math.random() * flashcards.length)];
            return `${random.q}\n(Respuesta: ${random.r})\n¿Quieres más? Di "flash [libro]".`;
        }

        let historiaActual = {};
        function continuarHistoria(continuacion) {
            const key = `historia_${emailSesion}`;
            if (!historiaActual[key]) historiaActual[key] = { historia: '', turno: 'user' };
            if (historiaActual[key].turno === 'user') {
                historiaActual[key].historia += ` Tú: ${continuacion}. `;
                historiaActual[key].turno = 'bot';
                return '¡Genial continuación! Ahora yo: El dragón aterrizó en la biblioteca, revelando un mapa antiguo. ¿Qué haces?';
            } else {
                historiaActual[key].historia += 'Hipat-IA: El dragón susurró un secreto literario. ';
                historiaActual[key].turno = 'user';
                return `Historia hasta ahora: ${historiaActual[key].historia}\nTu turno: ¿Qué pasa después?`;
            }
        }

        function analizarHuellaLectora() {
            const historial = [];
            (prestamos[emailSesion] || []).forEach(p => { if (p.titulo) historial.push(p.titulo); });
            if (historial.length === 0) return 'Aún no tienes huella lectora. ¡Empieza a prestar!';
            const categorias = historial.map(t => catalogo.find(l => l.titulo === t)?.categoria || 'General');
            const conteoCat = {};
            categorias.forEach(cat => conteoCat[cat] = (conteoCat[cat] || 0) + 1);
            const topCat = Object.entries(conteoCat).sort((a, b) => b[1] - a[1])[0];
            return `Tu huella: ${topCat[0]} domina (${topCat[1]} lecturas, ${Math.round((topCat[1] / historial.length) * 100)}%). ¡Prueba algo nuevo como ${topCat[0] === 'Fantasía' ? 'Historia' : 'Fantasía'}!`;
        }

        function obtenerMultimedia(libro) {
            const isbn = libro.isbn !== 'No disponible' ? libro.isbn : '';
            return isbn ? 
                `Recursos para "${libro.titulo}":\n- Audiolibro: https://open.spotify.com/search/${isbn}\n- Reseñas: https://www.goodreads.com/search?q=${encodeURIComponent(libro.titulo)}` :
                'No tengo ISBN para multimedia. Busca en YouTube o Spotify manualmente.';
        }

        function cargarDatos() {
            const reservasGuardadas = localStorage.getItem('reservasBiblioteca');
            if (reservasGuardadas) reservas = JSON.parse(reservasGuardadas);
            const prestamosGuardados = localStorage.getItem('prestamosBiblioteca');
            if (prestamosGuardados) prestamos = JSON.parse(prestamosGuardados);
            const solicitudesGuardadas = localStorage.getItem('solicitudesBiblioteca');
            if (solicitudesGuardadas) solicitudes = JSON.parse(solicitudesGuardadas);
            const approvedGuardados = localStorage.getItem('approvedEmails');
            if (approvedGuardados) approvedEmails = JSON.parse(approvedGuardados);
            const alertasGuardadas = localStorage.getItem('alertasBusqueda');
            if (alertasGuardadas) alertasBusqueda = JSON.parse(alertasGuardadas);
            const infraccionesGuardadas = localStorage.getItem('infracciones');
            if (infraccionesGuardadas) infracciones = JSON.parse(infraccionesGuardadas);
        }

        function guardarDatos() {
            localStorage.setItem('reservasBiblioteca', JSON.stringify(reservas));
            localStorage.setItem('prestamosBiblioteca', JSON.stringify(prestamos));
            localStorage.setItem('solicitudesBiblioteca', JSON.stringify(solicitudes));
            localStorage.setItem('approvedEmails', JSON.stringify(approvedEmails));
            localStorage.setItem('alertasBusqueda', JSON.stringify(alertasBusqueda));
            localStorage.setItem('infracciones', JSON.stringify(infracciones));
        }

        function getPendingTasksCount() {
            let countReservas = 0;
            Object.keys(reservas).forEach(email => {
                countReservas += (reservas[email] || []).length;
            });
            let todosPrestamos = [];
            Object.keys(prestamos).forEach(email => {
                (prestamos[email] || []).forEach(p => todosPrestamos.push({email, ...p}));
            });
            let countRetrasados = todosPrestamos.filter(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto).length;
            let countAlertas = alertasBusqueda.length;
            return countReservas + countRetrasados + countAlertas;
        }

        function updateNotificationBadge() {
            if (emailSesion !== EMAIL_ADMIN) return;
            const count = getPendingTasksCount();
            const countElement = document.getElementById('notificationCount');
            if (count > 0) {
                countElement.textContent = count;
                countElement.style.display = 'inline-flex';
            } else {
                countElement.style.display = 'none';
            }
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email || !email.endsWith('@educa.madrid.org')) {
                document.getElementById('loginError').textContent = 'Email inválido. Debe terminar en @educa.madrid.org';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            if (email !== EMAIL_ADMIN && !approvedEmails.includes(email)) {
                document.getElementById('loginError').textContent = 'Email no aprobado por el administrador o has sido expulsado.';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            emailSesion = email;
            sessionStorage.setItem('emailSesion', email);
            document.getElementById('adminBadge').style.display = email === EMAIL_ADMIN ? 'inline-block' : 'none';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('perfil').style.display = email === EMAIL_ADMIN ? 'none' : 'block';
            document.getElementById('busqueda').style.display = 'block';
            document.getElementById('chatbot').style.display = 'block';
            document.getElementById('adminHistorial').style.display = 'none';
            if (email === EMAIL_ADMIN) {
                updateNotificationBadge();
            }
            cargarPerfil();
            cargarCatalogo();
        }

        function logout() {
            emailSesion = null;
            sessionStorage.clear(); // Limpiar todo el sessionStorage para mayor seguridad
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('adminBadge').style.display = 'none';
            document.getElementById('adminHistorial').style.display = 'none';
            document.getElementById('perfil').style.display = 'none';
            document.getElementById('busqueda').style.display = 'none';
            document.getElementById('chatbot').style.display = 'none';
            document.getElementById('adminTabContent').innerHTML = '';
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            chatIniciado = false;
            document.getElementById('chatMensajes').innerHTML = '';
        }

        function cargarPerfil() {
            if (!emailSesion) return;
            const esAdmin = emailSesion === EMAIL_ADMIN;
            const misReservasDiv = document.getElementById('misReservas');
            const misPrestamosDiv = document.getElementById('misPrestamos');

            if (esAdmin) {
                misReservasDiv.innerHTML = '';
                misPrestamosDiv.innerHTML = '';
                document.getElementById('solicitudesLibros').style.display = 'none';
                return;
            } else {
                document.getElementById('solicitudesLibros').style.display = 'block';
            }

            const misReservas = reservas[emailSesion] || [];
            misReservasDiv.innerHTML = `<h3>Mis Reservas (${misReservas.length}/3)</h3><div class="lista-libros">${misReservas.map(r => `
                <div class="libro-perfil">
                    <strong>${r.titulo}</strong> (ID: ${r.idRegistro})<br>
                    <span class="fecha">Reservado el: ${new Date(r.fechaReserva).toLocaleDateString('es-ES')}</span>
                    <button class="btn-anular" onclick="anularReserva('${emailSesion}', '${r.idRegistro}', '${r.titulo.replace(/'/g, "\\'")}')">Anular reserva</button>
                </div>
            `).join('') || '<p>No tienes reservas.</p>'}</div>`;

            const misPrestamos = prestamos[emailSesion] || [];
            let retrasados = misPrestamos.filter(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto);
            misPrestamosDiv.innerHTML = `<h3>Mis Préstamos</h3><div class="lista-libros">${misPrestamos.map(p => {
                const retrasado = new Date() > new Date(p.fechaDevolucion) && !p.devuelto;
                return `
                    <div class="libro-perfil">
                        <strong>${p.titulo}</strong> (ID: ${p.idRegistro})<br>
                        <span class="fecha">Prestado el: ${new Date(p.fechaPrestamo).toLocaleDateString('es-ES')}</span><br>
                        <span class="fecha">Devolver antes de: ${new Date(p.fechaDevolucion).toLocaleDateString('es-ES')}</span>
                        ${retrasado ? '<span class="retrasado">Retrasado</span>' : ''}
                    </div>
                `;
            }).join('') || '<p>No tienes préstamos.</p>'}</div>`;

            if (retrasados.length > 0) {
                setTimeout(() => enviarRecordatorioRetraso(retrasados), 1000);
            }
        }

        function enviarSolicitud() {
            const texto = document.getElementById('solicitudTextarea').value.trim();
            if (!texto) {
                alert('Por favor, escribe tu solicitud antes de enviar.');
                return;
            }
            if (texto.length > 500) {
                alert('La solicitud no puede exceder 500 palabras.');
                return;
            }
            const fecha = new Date().toISOString();
            solicitudes.push({email: emailSesion, texto, fecha});
            guardarDatos();
            document.getElementById('solicitudTextarea').value = '';
            alert('Solicitud enviada correctamente.');
            updateNotificationBadge();
        }

        function mostrarHistorialAdmin() {
            if (emailSesion !== EMAIL_ADMIN) return;
            document.getElementById('perfil').style.display = 'none';
            document.getElementById('busqueda').style.display = 'none';
            document.getElementById('chatbot').style.display = 'none';
            document.getElementById('adminHistorial').style.display = 'block';
            showAdminTab('tareas');
        }

        function volverCatalogo() {
            document.getElementById('adminHistorial').style.display = 'none';
            document.getElementById('busqueda').style.display = 'block';
            document.getElementById('chatbot').style.display = 'block';
            if (emailSesion !== EMAIL_ADMIN) {
                document.getElementById('perfil').style.display = 'block';
            }
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            updateNotificationBadge();
        }

        function showAdminTab(tabId) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = Array.from(tabs).find(tab => tab.onclick.toString().includes(tabId));
            if (activeTab) activeTab.classList.add('active');

            const contentDiv = document.getElementById('adminTabContent');
            if (tabId === 'tareas') {
                contentDiv.innerHTML = getTareasPendientes();
            } else if (tabId === 'historial') {
                contentDiv.innerHTML = getHistorialCompleto();
            } else if (tabId === 'correos') {
                contentDiv.innerHTML = getGestionCorreos();
                cargarApprovedEmails();
            } else if (tabId === 'solicitudes') {
                contentDiv.innerHTML = getSolicitudesLibros();
            } else if (tabId === 'alertas') {
                contentDiv.innerHTML = getAlertasBusqueda();
            }
        }

        function getTareasPendientes() {
            let tareas = '<h3>Tareas Pendientes</h3>';
            let todasReservas = [];
            Object.keys(reservas).forEach(email => {
                (reservas[email] || []).forEach(r => todasReservas.push({email, ...r}));
            });
            let todosPrestamos = [];
            Object.keys(prestamos).forEach(email => {
                (prestamos[email] || []).forEach(p => todosPrestamos.push({email, ...p}));
            });
            let retrasados = todosPrestamos.filter(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto);

            tareas += '<h4>Libros Reservados Pendientes de Recoger</h4>';
            tareas += `<div class="lista-libros">${todasReservas.map(r => `
                <div class="libro-perfil">
                    <strong>${r.titulo}</strong> por ${r.email} (ID: ${r.idRegistro})<br>
                    <span class="fecha">Reservado el: ${new Date(r.fechaReserva).toLocaleDateString('es-ES')}</span>
                    <button class="btn-recoger" onclick="adminRecogerLibro('${r.email}', '${r.idRegistro}', '${r.titulo.replace(/'/g, "\\'")}')">Recoger</button>
                    <button class="btn-anular" onclick="anularReserva('${r.email}', '${r.idRegistro}', '${r.titulo.replace(/'/g, "\\'")}')">Anular</button>
                </div>
            `).join('') || '<p>No hay reservas pendientes.</p>'}</div>`;

            tareas += '<h4>Libros Retrasados</h4>';
            tareas += `<div class="lista-libros">${retrasados.map(p => `
                <div class="libro-perfil">
                    <strong>${p.titulo}</strong> por ${p.email} (ID: ${p.idRegistro})<br>
                    <span class="fecha">Prestado el: ${new Date(p.fechaPrestamo).toLocaleDateString('es-ES')}</span><br>
                    <span class="fecha">Debería devolverse antes de: ${new Date(p.fechaDevolucion).toLocaleDateString('es-ES')}</span>
                    <span class="retrasado">Retrasado</span>
                    <button class="btn-devolver" onclick="adminDevolverLibro('${p.email}', '${p.idRegistro}', '${p.titulo.replace(/'/g, "\\'")}')">Marcar Devuelto</button>
                </div>
            `).join('') || '<p>No hay libros retrasados.</p>'}</div>`;

            return tareas;
        }

        function getHistorialCompleto() {
            let historialHtml = '<h3>Historial Completo</h3>';
            let historial = [];

            Object.keys(reservas).forEach(email => {
                (reservas[email] || []).forEach(r => {
                    historial.push({
                        email,
                        titulo: r.titulo,
                        idRegistro: r.idRegistro,
                        fechaReserva: r.fechaReserva || '',
                        fechaPrestamo: '',
                        fechaDevolucion: '',
                        estado: 'Reservado'
                    });
                });
            });
            Object.keys(prestamos).forEach(email => {
                (prestamos[email] || []).forEach(p => {
                    historial.push({
                        email,
                        titulo: p.titulo,
                        idRegistro: p.idRegistro,
                        fechaReserva: p.fechaReserva || '',
                        fechaPrestamo: p.fechaPrestamo || '',
                        fechaDevolucion: p.fechaDevolucion || '',
                        estado: p.devuelto ? 'Devuelto' : 'Prestado'
                    });
                });
            });

            historial.sort((a, b) => {
                let valueA, valueB;
                switch (sortColumn) {
                    case 'titulo':
                        valueA = a.titulo.toLowerCase();
                        valueB = b.titulo.toLowerCase();
                        break;
                    case 'email':
                        valueA = a.email.toLowerCase();
                        valueB = b.email.toLowerCase();
                        break;
                    case 'fechaReserva':
                        valueA = a.fechaReserva || '9999-12-31';
                        valueB = b.fechaReserva || '9999-12-31';
                        break;
                    case 'fechaPrestamo':
                        valueA = a.fechaPrestamo || '9999-12-31';
                        valueB = b.fechaPrestamo || '9999-12-31';
                        break;
                    case 'fechaDevolucion':
                        valueA = a.fechaDevolucion || '9999-12-31';
                        valueB = b.fechaDevolucion || '9999-12-31';
                        break;
                    case 'estado':
                        valueA = a.estado.toLowerCase();
                        valueB = b.estado.toLowerCase();
                        break;
                    default:
                        valueA = a.idRegistro.toLowerCase();
                        valueB = b.idRegistro.toLowerCase();
                }
                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            const pageSize = 25;
            const totalPages = Math.ceil(historial.length / pageSize) || 1;
            const start = (currentPageHistorial - 1) * pageSize;
            const end = start + pageSize;
            const paginatedHistorial = historial.slice(start, end);

            const paginationHtml = `
                <div class="pagination">
                    <button ${currentPageHistorial === 1 ? 'disabled' : ''} onclick="changePageHistorial(${currentPageHistorial - 1})">&lt;</button>
                    <span>Página ${currentPageHistorial}/${totalPages}</span>
                    <button ${currentPageHistorial === totalPages ? 'disabled' : ''} onclick="changePageHistorial(${currentPageHistorial + 1})">&gt;</button>
                </div>
            `;

            historialHtml += paginationHtml;

            historialHtml += `<table>
                <thead>
                    <tr>
                        <th onclick="ordenarHistorial('email')" class="sort-arrow ${sortColumn === 'email' ? sortDirection : ''}">Usuario</th>
                        <th onclick="ordenarHistorial('titulo')" class="sort-arrow ${sortColumn === 'titulo' ? sortDirection : ''}">Título</th>
                        <th onclick="ordenarHistorial('idRegistro')" class="sort-arrow ${sortColumn === 'idRegistro' ? sortDirection : ''}">ID Registro</th>
                        <th onclick="ordenarHistorial('fechaReserva')" class="sort-arrow ${sortColumn === 'fechaReserva' ? sortDirection : ''}">Fecha Reserva</th>
                        <th onclick="ordenarHistorial('fechaPrestamo')" class="sort-arrow ${sortColumn === 'fechaPrestamo' ? sortDirection : ''}">Fecha Préstamo</th>
                        <th onclick="ordenarHistorial('fechaDevolucion')" class="sort-arrow ${sortColumn === 'fechaDevolucion' ? sortDirection : ''}">Fecha Devolución</th>
                        <th onclick="ordenarHistorial('estado')" class="sort-arrow ${sortColumn === 'estado' ? sortDirection : ''}">Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${paginatedHistorial.length > 0 ? paginatedHistorial.map(item => {
                        const retrasado = item.estado === 'Prestado' && item.fechaDevolucion && new Date() > new Date(item.fechaDevolucion);
                        return `
                            <tr>
                                <td>${item.email}</td>
                                <td>${item.titulo}</td>
                                <td>${item.idRegistro}</td>
                                <td>${item.fechaReserva ? new Date(item.fechaReserva).toLocaleDateString('es-ES') : '-'}</td>
                                <td>${item.fechaPrestamo ? new Date(item.fechaPrestamo).toLocaleDateString('es-ES') : '-'}</td>
                                <td>${item.fechaDevolucion ? new Date(item.fechaDevolucion).toLocaleDateString('es-ES') : '-'}</td>
                                <td>${retrasado ? '<span class="retrasado">Retrasado</span>' : item.estado}</td>
                                <td>
                                    ${item.estado === 'Reservado' ? `
                                        <button class="btn-recoger" onclick="adminRecogerLibro('${item.email}', '${item.idRegistro}', '${item.titulo.replace(/'/g, "\\'")}')">Prestado</button>
                                        <button class="btn-anular" onclick="anularReserva('${item.email}', '${item.idRegistro}', '${item.titulo.replace(/'/g, "\\'")}')">Anular</button>
                                    ` : ''}
                                    ${item.estado === 'Prestado' ? `
                                        <button class="btn-devolver" onclick="adminDevolverLibro('${item.email}', '${item.idRegistro}', '${item.titulo.replace(/'/g, "\\'")}')">Devolver</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('') : '<tr><td colspan="8">No hay registros.</td></tr>'}
                </tbody>
            </table>`;

            historialHtml += paginationHtml;

            const prestamosPorAnno = {};
            historial.forEach(item => {
                if (item.fechaPrestamo) {
                    const date = new Date(item.fechaPrestamo);
                    const anno = date.getFullYear();
                    prestamosPorAnno[anno] = (prestamosPorAnno[anno] || 0) + 1;
                }
            });
            const sortedAnnos = Object.entries(prestamosPorAnno).sort((a, b) => b[1] - a[1]);
            historialHtml += '<h4>Estadísticas de Préstamos por Año</h4><ul>';
            sortedAnnos.forEach(([anno, count]) => {
                historialHtml += `<li>${anno}: ${count} préstamos</li>`;
            });
            historialHtml += '</ul>';

            const prestamosPorMes = {};
            historial.forEach(item => {
                if (item.fechaPrestamo) {
                    const date = new Date(item.fechaPrestamo);
                    const mes = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                    prestamosPorMes[mes] = (prestamosPorMes[mes] || 0) + 1;
                }
            });
            const sortedMeses = Object.entries(prestamosPorMes).sort((a, b) => b[1] - a[1]);
            historialHtml += '<h4>Estadísticas de Préstamos por Mes</h4><ul>';
            sortedMeses.forEach(([mes, count]) => {
                historialHtml += `<li>${mes}: ${count} préstamos</li>`;
            });
            historialHtml += '</ul>';

            historialHtml += getLibrosMasPrestados(historial);
            return historialHtml;
        }

        function getLibrosMasPrestados(historial) {
            const conteo = {};
            historial.forEach(item => {
                if (item.fechaPrestamo) {
                    conteo[item.titulo] = (conteo[item.titulo] || 0) + 1;
                }
            });
            const sorted = Object.entries(conteo).sort((a, b) => b[1] - a[1]).slice(0, 5);
            let html = '<h4>Libros Más Prestados</h4><ul>';
            sorted.forEach(([titulo, count]) => {
                html += `<li>${titulo}: ${count} veces</li>`;
            });
            html += '</ul>';
            return html;
        }

        function changePageHistorial(newPage) {
            currentPageHistorial = newPage;
            showAdminTab('historial');
        }

        function getGestionCorreos() {
            return `
                <h3>Gestión de Correos Aprobados</h3>
                <input type="email" id="newEmail" placeholder="Agregar correo manualmente">
                <button onclick="addEmail()">Agregar</button>
                <input type="file" id="emailFile" accept=".csv,.xlsx">
                <button onclick="importEmails()">Importar desde archivo</button>
                <input type="text" id="emailSearch" placeholder="Buscar correo" oninput="filterEmails()">
                <button onclick="selectAllEmails()">Seleccionar todos</button>
                <button onclick="deselectAllEmails()">Deseleccionar todos</button>
                <button onclick="deleteSelectedEmails()">Eliminar Correos seleccionados</button>
                <div id="approvedEmailPaginationTop" class="pagination"></div>
                <table id="approvedEmailTable">
                    <thead>
                        <tr>
                            <th onclick="ordenarCorreos('email')" class="sort-arrow ${sortColumnEmails === 'email' ? sortDirectionEmails : ''}">Correo</th>
                            <th onclick="ordenarCorreos('prestados')" class="sort-arrow ${sortColumnEmails === 'prestados' ? sortDirectionEmails : ''}">Libros Prestados</th>
                            <th onclick="ordenarCorreos('reservas')" class="sort-arrow ${sortColumnEmails === 'reservas' ? sortDirectionEmails : ''}">En Reserva</th>
                            <th onclick="ordenarCorreos('porDevolver')" class="sort-arrow ${sortColumnEmails === 'porDevolver' ? sortDirectionEmails : ''}">Por Devolver</th>
                            <th onclick="ordenarCorreos('retrasados')" class="sort-arrow ${sortColumnEmails === 'retrasados' ? sortDirectionEmails : ''}">Retrasados</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="approvedEmailList"></tbody>
                </table>
                <div id="approvedEmailPaginationBottom" class="pagination"></div>
            `;
        }

        function getSolicitudesLibros() {
            let solicitudesHtml = '<h3>Solicitudes de Libros</h3>';

            const pageSize = 25;
            const totalPages = Math.ceil(solicitudes.length / pageSize) || 1;
            const start = (currentPageSolicitudes - 1) * pageSize;
            const end = start + pageSize;
            const paginatedSolicitudes = solicitudes.slice(start, end);

            const paginationHtml = `
                <div class="pagination">
                    <button ${currentPageSolicitudes === 1 ? 'disabled' : ''} onclick="changePageSolicitudes(${currentPageSolicitudes - 1})">&lt;</button>
                    <span>Página ${currentPageSolicitudes}/${totalPages}</span>
                    <button ${currentPageSolicitudes === totalPages ? 'disabled' : ''} onclick="changePageSolicitudes(${currentPageSolicitudes + 1})">&gt;</button>
                </div>
            `;

            solicitudesHtml += paginationHtml;

            solicitudesHtml += `<table>
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Fecha</th>
                        <th>Solicitud</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${paginatedSolicitudes.map((s, index) => `
                        <tr>
                            <td>${s.email}</td>
                            <td>${new Date(s.fecha).toLocaleDateString('es-ES')}</td>
                            <td>${s.texto}</td>
                            <td><button class="btn-anular" onclick="eliminarSolicitud(${start + index})">Eliminar</button></td>
                        </tr>
                    `).join('') || '<tr><td colspan="4">No hay solicitudes.</td></tr>'}
                </tbody>
            </table>`;

            solicitudesHtml += paginationHtml;

            return solicitudesHtml;
        }

        function getAlertasBusqueda() {
            let alertasHtml = '<h3>Alertas de Búsqueda</h3>';

            const pageSize = 25;
            const totalPages = Math.ceil(alertasBusqueda.length / pageSize) || 1;
            const start = (currentPageAlertas - 1) * pageSize;
            const end = start + pageSize;
            const paginatedAlertas = alertasBusqueda.slice(start, end);

            const paginationHtml = `
                <div class="pagination">
                    <button ${currentPageAlertas === 1 ? 'disabled' : ''} onclick="changePageAlertas(${currentPageAlertas - 1})">&lt;</button>
                    <span>Página ${currentPageAlertas}/${totalPages}</span>
                    <button ${currentPageAlertas === totalPages ? 'disabled' : ''} onclick="changePageAlertas(${currentPageAlertas + 1})">&gt;</button>
                </div>
            `;

            alertasHtml += paginationHtml;

            alertasHtml += `<table>
                <thead>
                    <tr>
                        <th onclick="ordenarAlertas('email')" class="sort-arrow ${sortColumnAlertas === 'email' ? sortDirectionAlertas : ''}">Usuario</th>
                        <th onclick="ordenarAlertas('mensaje')" class="sort-arrow ${sortColumnAlertas === 'mensaje' ? sortDirectionAlertas : ''}">Mensaje</th>
                        <th onclick="ordenarAlertas('palabraBloqueada')" class="sort-arrow ${sortColumnAlertas === 'palabraBloqueada' ? sortDirectionAlertas : ''}">Palabra Bloqueada</th>
                        <th onclick="ordenarAlertas('fecha')" class="sort-arrow ${sortColumnAlertas === 'fecha' ? sortDirectionAlertas : ''}">Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${paginatedAlertas.map((alerta, index) => `
                        <tr>
                            <td>${alerta.email}</td>
                            <td>${alerta.mensaje}</td>
                            <td>${alerta.palabraBloqueada}</td>
                            <td>${new Date(alerta.fecha).toLocaleDateString('es-ES')}</td>
                            <td>
                                ${!approvedEmails.includes(alerta.email) ? `
                                    <button class="btn-reserva" onclick="readmitirUsuario('${alerta.email}')">Readmitir</button>
                                ` : ''}
                                <button class="btn-anular" onclick="eliminarAlerta(${start + index})">Eliminar</button>
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="5">No hay alertas de búsqueda.</td></tr>'}
                </tbody>
            </table>`;

            alertasHtml += paginationHtml;

            return alertasHtml;
        }

        function readmitirUsuario(email) {
            if (confirm(`¿Estás seguro de readmitir a ${email}?`)) {
                if (!approvedEmails.includes(email)) {
                    approvedEmails.push(email);
                    infracciones[email] = 0;
                    localStorage.setItem('approvedEmails', JSON.stringify(approvedEmails));
                    localStorage.setItem('infracciones', JSON.stringify(infracciones));
                    emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                        to_email: email,
                        subject: 'Readmisión en el Sistema de Biblioteca',
                        message: 'Has sido readmitido en el sistema de la Biblioteca Hipatia. Por favor, respeta las normas de uso.'
                    }).catch(() => {
                        const subject = encodeURIComponent('Readmisión en el Sistema de Biblioteca');
                        const body = encodeURIComponent('Has sido readmitido en el sistema de la Biblioteca Hipatia. Por favor, respeta las normas de uso.');
                        window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                    });
                    showAdminTab('alertas');
                    updateNotificationBadge();
                }
            }
        }

        function eliminarAlerta(index) {
            if (confirm('¿Estás seguro de eliminar esta alerta?')) {
                alertasBusqueda.splice(index, 1);
                guardarDatos();
                showAdminTab('alertas');
                updateNotificationBadge();
            }
        }

        function changePageAlertas(newPage) {
            currentPageAlertas = newPage;
            showAdminTab('alertas');
        }

        function ordenarAlertas(column) {
            if (sortColumnAlertas === column) {
                sortDirectionAlertas = sortDirectionAlertas === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumnAlertas = column;
                sortDirectionAlertas = 'asc';
            }
            currentPageAlertas = 1;
            showAdminTab('alertas');
        }

        function eliminarSolicitud(index) {
            if (confirm('¿Estás seguro de eliminar esta solicitud?')) {
                solicitudes.splice(index, 1);
                guardarDatos();
                showAdminTab('solicitudes');
                updateNotificationBadge();
            }
        }

        function changePageSolicitudes(newPage) {
            currentPageSolicitudes = newPage;
            showAdminTab('solicitudes');
        }

        function changePageEmails(newPage) {
            currentPageEmails = newPage;
            showAdminTab('correos');
        }

          function enviarRecordatorioRetraso(retrasados) {
            const mensajes = retrasados.map(p => `El libro "${p.titulo}" está retrasado. Por favor, devuélvelo cuanto antes.`).join('\n');
            const params = {
                to_email: emailSesion,
                subject: 'Recordatorio: Libros retrasados en devolución',
                message: `Hola,\n\n${mensajes}\n\nGracias por tu colaboración.\n\nBiblioteca Carpe Diem`
            };
            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', params)
                .then(() => {
                    console.log('Recordatorio de retraso enviado al estudiante.');
                }, (error) => {
                    console.error('Error al enviar recordatorio:', error);
                    alert('Error al enviar correo con EmailJS. Abriendo cliente de correo como alternativa.');
                    const subject = encodeURIComponent('Recordatorio: Libros retrasados en devolución');
                    const body = encodeURIComponent(`Hola,\n\n${mensajes}\n\nGracias por tu colaboración.\n\nBiblioteca Carpe Diem`);
                    window.location.href = `mailto:${emailSesion}?subject=${subject}&body=${body}`;
                });
        }

        function adminRecogerLibro(emailEstudiante, idRegistro, titulo) {
            const reservaIndex = (reservas[emailEstudiante] || []).findIndex(r => r.idRegistro === idRegistro);
            if (reservaIndex === -1) return;

            const reserva = reservas[emailEstudiante][reservaIndex];
            const fechaPrestamo = new Date().toISOString();
            const fechaDevolucion = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
            if (!prestamos[emailEstudiante]) prestamos[emailEstudiante] = [];
            prestamos[emailEstudiante].push({idRegistro, fechaReserva: reserva.fechaReserva, fechaPrestamo, fechaDevolucion, titulo, devuelto: false});

            reservas[emailEstudiante].splice(reservaIndex, 1);
            guardarDatos();

            const libro = catalogo.find(l => l.idRegistro === idRegistro);
            if (libro) libro.disponible = false;

            alert(`Libro recogido para ${emailEstudiante}.`);
            updateNotificationBadge();
            showAdminTab('tareas');
            const inputValue = document.getElementById('buscarInput').value;
            if (inputValue) buscarLibros();
        }

        function adminDevolverLibro(emailEstudiante, idRegistro, titulo) {
            const prestamoIndex = (prestamos[emailEstudiante] || []).findIndex(p => p.idRegistro === idRegistro);
            if (prestamoIndex === -1) return;

            prestamos[emailEstudiante][prestamoIndex].devuelto = true;
            guardarDatos();

            const libro = catalogo.find(l => l.idRegistro === idRegistro);
            if (libro) libro.disponible = true;

            alert(`Libro marcado como devuelto para ${emailEstudiante}.`);
            updateNotificationBadge();
            showAdminTab('tareas');
            const inputValue = document.getElementById('buscarInput').value;
            if (inputValue) buscarLibros();
        }

        function anularReserva(emailEstudiante, idRegistro, titulo) {
            const reservaIndex = (reservas[emailEstudiante] || []).findIndex(r => r.idRegistro === idRegistro);
            if (reservaIndex === -1) return;

            reservas[emailEstudiante].splice(reservaIndex, 1);
            guardarDatos();

            const libro = catalogo.find(l => l.idRegistro === idRegistro);
            if (libro) libro.disponible = true;

            alert(`Reserva anulada para ${titulo}.`);
            updateNotificationBadge();

            if (emailSesion === EMAIL_ADMIN) {
                showAdminTab('tareas');
            } else {
                cargarPerfil();
            }
            const inputValue = document.getElementById('buscarInput').value;
            if (inputValue) buscarLibros();
        }

        function cargarApprovedEmails() {
            let emailsData = approvedEmails.map(email => {
                const totalPrestados = (prestamos[email] || []).length;
                const reservasCount = (reservas[email] || []).length;
                const porDevolver = (prestamos[email] || []).filter(p => !p.devuelto).length;
                const retrasados = (prestamos[email] || []).filter(p => !p.devuelto && new Date() > new Date(p.fechaDevolucion)).length;
                return {email, prestados: totalPrestados, reservas: reservasCount, porDevolver, retrasados};
            });

            const search = document.getElementById('emailSearch').value.toLowerCase().trim();
            if (search) {
                emailsData = emailsData.filter(data => data.email.toLowerCase().includes(search));
            }

            emailsData.sort((a, b) => {
                let valueA = a[sortColumnEmails];
                let valueB = b[sortColumnEmails];
                if (typeof valueA === 'string') valueA = valueA.toLowerCase();
                if (typeof valueB === 'string') valueB = valueB.toLowerCase();
                if (valueA < valueB) return sortDirectionEmails === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirectionEmails === 'asc' ? 1 : -1;
                return 0;
            });

            const pageSize = 25;
            const totalPages = Math.ceil(emailsData.length / pageSize) || 1;
            const start = (currentPageEmails - 1) * pageSize;
            const end = start + pageSize;
            const paginatedEmails = emailsData.slice(start, end);

            const paginationHtml = `
                <button ${currentPageEmails === 1 ? 'disabled' : ''} onclick="changePageEmails(${currentPageEmails - 1})">&lt;</button>
                <span>Página ${currentPageEmails}/${totalPages}</span>
                <button ${currentPageEmails === totalPages ? 'disabled' : ''} onclick="changePageEmails(${currentPageEmails + 1})">&gt;</button>
            `;

            document.getElementById('approvedEmailPaginationTop').innerHTML = paginationHtml;
            document.getElementById('approvedEmailPaginationBottom').innerHTML = paginationHtml;

            const listTbody = document.getElementById('approvedEmailList');
            listTbody.innerHTML = paginatedEmails.length > 0 ? paginatedEmails.map(data => `
                <tr>
                    <td><input type="checkbox" value="${data.email}"> ${data.email}</td>
                    <td>${data.prestados}</td>
                    <td>${data.reservas}</td>
                    <td>${data.porDevolver}</td>
                    <td>${data.retrasados}</td>
                    <td><button onclick="deleteEmail('${data.email}')">Eliminar</button></td>
                </tr>
            `).join('') : '<tr><td colspan="6">No hay correos aprobados.</td></tr>';

            document.querySelectorAll('#approvedEmailTable th').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.getAttribute('onclick').includes(sortColumnEmails)) {
                    th.classList.add(sortDirectionEmails);
                }
            });
        }

        function addEmail() {
            const newEmail = document.getElementById('newEmail').value.trim();
            if (newEmail && newEmail.endsWith('@educa.madrid.org') && !approvedEmails.includes(newEmail)) {
                approvedEmails.push(newEmail);
                guardarDatos();
                cargarApprovedEmails();
                document.getElementById('newEmail').value = '';
            } else {
                alert('Email inválido, ya agregado o no termina en @educa.madrid.org.');
            }
        }

        function importEmails() {
            const fileInput = document.getElementById('emailFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecciona un archivo.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const extension = file.name.split('.').pop().toLowerCase();
                let emails = [];
                if (extension === 'csv') {
                    const data = e.target.result;
                    emails = data.split('\n').map(line => line.trim()).filter(line => line && line.endsWith('@educa.madrid.org'));
                } else if (extension === 'xlsx') {
                    gk_fileData[file.name] = e.target.result.split(',')[1];
                    gk_xlsxFileLookup[file.name] = true;
                    const csv = loadFileData(file.name);
                    emails = csv.split('\n').slice(1).map(line => line.split(',')[0].trim()).filter(line => line && line.endsWith('@educa.madrid.org'));
                }
                const nuevos = emails.filter(email => !approvedEmails.includes(email));
                if (nuevos.length === 0) {
                    alert('No se encontraron correos válidos o nuevos para agregar.');
                    return;
                }
                approvedEmails.push(...nuevos);
                guardarDatos();
                cargarApprovedEmails();
                fileInput.value = '';
                alert(`${nuevos.length} correos agregados correctamente.`);
            };
            reader.onerror = function() {
                alert('Error al leer el archivo.');
            };
            reader.readAsDataURL(file);
        }

        function deleteEmail(email) {
            if (confirm('¿Está seguro que desea eliminar el correo seleccionado?')) {
                approvedEmails = approvedEmails.filter(e => e !== email);
                guardarDatos();
                cargarApprovedEmails();
            }
        }

        function deleteSelectedEmails() {
            const checkboxes = document.querySelectorAll('#approvedEmailList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('No hay correos seleccionados.');
                return;
            }
            if (confirm(`¿Está seguro que desea eliminar TODOS los correos seleccionados? (${checkboxes.length} correos)`)) {
                checkboxes.forEach(checkbox => {
                    const email = checkbox.value;
                    approvedEmails = approvedEmails.filter(e => e !== email);
                });
                guardarDatos();
                cargarApprovedEmails();
            }
        }

        function selectAllEmails() {
            const checkboxes = document.querySelectorAll('#approvedEmailList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function deselectAllEmails() {
            const checkboxes = document.querySelectorAll('#approvedEmailList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function filterEmails() {
            currentPageEmails = 1;
            cargarApprovedEmails();
        }

        function ordenarCorreos(column) {
            if (sortColumnEmails === column) {
                sortDirectionEmails = sortDirectionEmails === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumnEmails = column;
                sortDirectionEmails = 'asc';
            }
            currentPageEmails = 1;
            cargarApprovedEmails();
        }

        function reservarLibro(idRegistro, titulo) {
            if (!emailSesion || emailSesion === EMAIL_ADMIN) return;
            cargarDatos();
            if (!reservas[emailSesion]) reservas[emailSesion] = [];
            if (!prestamos[emailSesion]) prestamos[emailSesion] = [];

            const tieneRetrasados = prestamos[emailSesion].some(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto);
            if (tieneRetrasados) {
                alert('No puedes reservar más libros hasta que devuelvas los libros retrasados.');
                return;
            }

            if (reservas[emailSesion].length >= 3) {
                alert('Solo puedes reservar un máximo de 3 libros.');
                return;
            }
            const libro = catalogo.find(l => l.idRegistro === idRegistro);
            if (!libro || !libro.disponible) return;
            const fechaReserva = new Date().toISOString();
            reservas[emailSesion].push({idRegistro, fechaReserva, titulo});
            libro.disponible = false;
            guardarDatos();

            alert(`Reservado! Te quedan ${3 - reservas[emailSesion].length} reservas.`);
            updateNotificationBadge();
            cargarPerfil();
            const inputValue = document.getElementById('buscarInput').value;
            if (inputValue) buscarLibros();
        }

        async function cargarCatalogo() {
            try {
                const response = await fetch('Ejemplares.xml');
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('Error al parsear XML.');
                }

                const libros = {};
                Array.from(xmlDoc.getElementsByTagName('Libro')).forEach(libro => {
                    const idDocumento = libro.getAttribute('id_documento');
                    if (!libros[idDocumento]) { // Evitar sobrescritura por duplicados
                        libros[idDocumento] = {
                            titulo: libro.getElementsByTagName('Titulo')[0]?.textContent || 'Sin título',
                            autor: libro.getElementsByTagName('Autor')[0]?.textContent || 'Desconocido',
                            categoria: libro.getElementsByTagName('Descriptor')[0]?.textContent || 'No disponible',
                            fechaEdicion: libro.getElementsByTagName('FechaEdicion')[0]?.textContent || 'No disponible'
                        };
                    }
                });

                catalogo = Array.from(xmlDoc.getElementsByTagName('Ejemplar')).map(ejemplar => {
                    const idRegistro = ejemplar.getAttribute('IdRegistro') || '';
                    const libro = libros[idRegistro] || {};
                    return {
                        titulo: libro.titulo || 'Sin título',
                        autor: libro.autor || 'Desconocido',
                        categoria: libro.categoria || 'No disponible',
                        fechaEdicion: libro.fechaEdicion || 'No disponible',
                        signatura: `${ejemplar.getAttribute('Signatura1') || ''} ${ejemplar.getAttribute('Signatura2') || ''} ${ejemplar.getAttribute('Signatura3') || ''}`.trim(),
                        isbn: ejemplar.getAttribute('ISBN') || 'No disponible',
                        fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                        disponible: ejemplar.getAttribute('Estado') === '0',
                        idRegistro: idRegistro
                    };
                });

                Object.values(reservas).flat().forEach(r => {
                    const libro = catalogo.find(l => l.idRegistro === r.idRegistro);
                    if (libro) libro.disponible = false;
                });
                Object.values(prestamos).flat().filter(p => !p.devuelto).forEach(p => {
                    const libro = catalogo.find(l => l.idRegistro === p.idRegistro);
                    if (libro) libro.disponible = false;
                });

                if (!catalogo.length) document.getElementById('resultados').innerHTML = '<p>No se encontraron libros.</p>';
            } catch (error) {
                console.error('Error al cargar:', error);
                document.getElementById('resultados').innerHTML = '<p>Catálogo en mantenimiento.</p>';
                catalogo = [];
            }
        }

        function buscarLibros() {
            if (!emailSesion) return;
            if (!catalogo.length) {
                document.getElementById('resultados').innerHTML = '<p>Catálogo en mantenimiento.</p>';
                return;
            }
            const query = document.getElementById('buscarInput').value.toLowerCase().trim();
            const resultados = catalogo.filter(libro => 
                libro.titulo.toLowerCase().includes(query) ||
                libro.autor.toLowerCase().includes(query) ||
                libro.categoria.toLowerCase().includes(query) ||
                libro.signatura.toLowerCase().includes(query) ||
                libro.isbn.toLowerCase().includes(query)
            );
            mostrarResultados(resultados, query);
        }

        function mostrarResultados(libros, query) {
            const div = document.getElementById('resultados');
            const conteoDiv = document.getElementById('conteoResultados');
            const esAdmin = emailSesion === EMAIL_ADMIN;
            
            if (libros.length === 0) {
                div.innerHTML = '<p>No se encontraron libros.</p>';
                conteoDiv.style.display = 'none';
                return;
            }

            const textoConteo = query ? `${libros.length} resultados para "${query}"` : `${libros.length} libros en el catálogo`;
            conteoDiv.innerHTML = `<p>${textoConteo}</p>`;
            conteoDiv.style.display = 'block';

            div.innerHTML = libros.map(libro => {
                const tejuelo = libro.signatura.replace(/\s+/g, '-');
                let estadoHtml = '';
                if (libro.disponible) {
                    if (!esAdmin) {
                        estadoHtml = `<button class="btn-reserva" onclick="reservarLibro('${libro.idRegistro}', '${libro.titulo.replace(/'/g, "\\'")}')">Reservar</button>`;
                    } else {
                        estadoHtml = 'Sí';
                    }
                } else {
                    let esReserva = false;
                    let emailReserva = null;
                    let emailPrestamo = null;
                    Object.keys(reservas).some(email => {
                        const r = reservas[email].find(rr => rr.idRegistro === libro.idRegistro);
                        if (r) {
                            esReserva = true;
                            emailReserva = email;
                            return true;
                        }
                    });
                    if (!esReserva) {
                        Object.keys(prestamos).some(email => {
                            const p = prestamos[email].find(pp => pp.idRegistro === libro.idRegistro && !pp.devuelto);
                            if (p) {
                                emailPrestamo = email;
                                return true;
                            }
                        });
                    }
                    if (esAdmin) {
                        if (esReserva) {
                            estadoHtml = `<span class="estado-reservado">Reservado por ${emailReserva}</span> <button class="btn-recoger" onclick="adminRecogerLibro('${emailReserva}', '${libro.idRegistro}', '${libro.titulo.replace(/'/g, "\\'")}')">Recoger</button> <button class="btn-anular" onclick="anularReserva('${emailReserva}', '${libro.idRegistro}', '${libro.titulo.replace(/'/g, "\\'")}')">Anular</button>`;
                        } else if (emailPrestamo) {
                            estadoHtml = `<span class="estado-no-disponible">Prestado a ${emailPrestamo}</span> <button class="btn-devolver" onclick="adminDevolverLibro('${emailPrestamo}', '${libro.idRegistro}', '${libro.titulo.replace(/'/g, "\\'")}')">Devolver</button>`;
                        } else {
                            estadoHtml = '<span class="estado-no-disponible">No disponible</span>';
                        }
                    } else {
                        estadoHtml = `<span class="estado-reservado">No disponible</span>`;
                    }
                }
                return `
                    <div class="libro">
                        <p><strong>Título:</strong> ${libro.titulo}</p>
                        <p><strong>Autor:</strong> ${libro.autor}</p>
                        <p><strong>Categoría:</strong> ${libro.categoria}</p>
                        <p><strong>Tejuelo:</strong> <span class="tejuelo">${tejuelo}</span></p>
                        <p><strong>Disponible:</strong> ${estadoHtml}</p>
                    </div>
                `;
            }).join('');
        }

        // Función expandida para Hipat-IA con las 8 ideas
        async function enviarMensaje() {
            if (!emailSesion) return;
            const input = document.getElementById('chatInput');
            const mensaje = input.value.trim();
            if (!mensaje) return;
            agregarMensaje(mensaje, 'user');
            input.value = '';
            chatIniciado = true;

            // Cortafuegos: Verificar palabras malsonantes o inapropiadas ANTES de procesar
            if (esMensajeInapropiado(mensaje)) {
                registrarAlertaBusqueda(mensaje);
                setTimeout(() => agregarMensaje('Lo siento, ese tema no es apropiado para nuestra biblioteca educativa. ¡Hablemos de libros! 📚', 'bot'), 800);
                return;
            }

            // Notificación proactiva si no se ha iniciado chat y hay retrasados
            if (!chatIniciado && emailSesion !== EMAIL_ADMIN) {
                const misPrestamos = prestamos[emailSesion] || [];
                const retrasados = misPrestamos.filter(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto);
                if (retrasados.length > 0) {
                    setTimeout(() => agregarMensaje(`¡Hola! Veo que tienes ${retrasados.length} libro(s) retrasado(s): ${retrasados.map(p => p.titulo).join(', ')}. Por favor, devuélvelos pronto para evitar recordatorios. ¿En qué más te ayudo?`, 'bot'), 500);
                    return;
                }
            }

            let respuesta = '';
            const esAdmin = emailSesion === EMAIL_ADMIN;
            const mensajeLower = mensaje.toLowerCase();
            const evento = chequearEventoActual();

            // Intents principales + 8 ideas
            if (mensajeLower.includes('hola') || mensajeLower.includes('ayuda') || mensajeLower.includes('guía')) {
                respuesta = `¡Hola! Soy Hipat-IA, tu asistente en la Biblioteca Hipatia. 
Para nuevos usuarios: 
1. Busca libros en el catálogo y reserva hasta 3 (máx. 30 días de préstamo).
2. Ve a "Mi Perfil" para ver reservas/préstamos.
3. Envía solicitudes de compra si quieres un libro nuevo.
Nuevas features: "resumen [libro]", "meta [número]", "secuencia [libro]", "vota [pregunta] [opción]", "flash [libro]", "historia [continuación]", "huella", "multimedia [libro]".
Prueba: "busca [autor/libro]", "recomienda populares", "mi perfil", "trivia". ${evento}`;
            } else if (mensajeLower.includes('perfil') || mensajeLower.includes('mis reservas') || mensajeLower.includes('mis préstamos')) {
                const misReservas = reservas[emailSesion] || [];
                const misPrestamos = prestamos[emailSesion] || [];
                const retrasados = misPrestamos.filter(p => new Date() > new Date(p.fechaDevolucion) && !p.devuelto);
                respuesta = esAdmin ? 'Como admin, usa el panel ADMIN para el historial completo.' : 
                    `Tus reservas: ${misReservas.length}/3 (${misReservas.map(r => r.titulo).join(', ') || 'Ninguna'}).
Tus préstamos: ${misPrestamos.length} (${retrasados.length > 0 ? `¡${retrasados.length} retrasado(s)!` : 'Todo OK'}). 
Ve a "Mi Perfil" para detalles.`;
            } else if (mensajeLower.includes('busca') || mensajeLower.includes('libro') || mensajeLower.includes('autor')) {
                const query = mensaje.replace(/busca|libro|autor/gi, '').trim();
                if (query) {
                    respuesta = `Búsqueda para "${query}":\n${buscarEnCatalogo(query)}`;
                } else {
                    respuesta = '¿Qué buscas? Ej: "busca García Márquez" o "libro 1984".';
                }
            } else if (mensajeLower.includes('recomienda') || mensajeLower.includes('sugiere')) {
                const interes = mensajeLower.match(/alegre|historia|misterio|romance|ciencia|populares|curso/)?.[0] || 'populares';
                if (interes === 'populares') {
                    const populares = obtenerLibrosPopulares();
                    respuesta = `Tendencias de la biblioteca:\n${populares.join('\n') || 'Aún no hay préstamos populares.'}`;
                } else if (interes === 'curso') {
                    const curso = obtenerCursoDeEmail(emailSesion);
                    const porCurso = recomendacionesPorCurso(curso);
                    respuesta = `Recomendaciones de tu curso (${curso}):\n${porCurso}`;
                } else {
                    respuesta = `Recomendaciones para "${interes}":\n${recomendacionesPorInteres(interes)}`;
                }
                if (evento) respuesta += `\n\n${evento}`;
            } else if (mensajeLower.includes('trivia') || mensajeLower.includes('pregunta')) {
                respuesta = `¡Trivia literaria!\n${generarTrivia()}\n\n¿Quieres otra? Di "trivia".`;
            } else if (mensajeLower.includes('reserva')) {
                const tituloBuscado = mensaje.replace(/reserva|resérvame/gi, '').trim();
                if (tituloBuscado) {
                    const libro = catalogo.find(l => l.titulo.toLowerCase().includes(tituloBuscado.toLowerCase()) && l.disponible);
                    if (libro) {
                        reservarLibro(libro.idRegistro, libro.titulo);
                        respuesta = `¡Reservado "${libro.titulo}" desde el chat! Te quedan ${3 - (reservas[emailSesion] || []).length} reservas. Confirma en "Mi Perfil".`;
                    } else {
                        respuesta = `No encontré "${tituloBuscado}" disponible. Busca en el catálogo y reserva desde allí.`;
                    }
                } else {
                    respuesta = '¿Qué libro quieres reservar? Ej: "reserva Harry Potter". Máx. 3 reservas.';
                }
            } else if (mensajeLower.includes('resumen') || mensajeLower.includes('cita')) { // IDEA 1
                const query = mensaje.replace(/resumen|cita/gi, '').trim();
                const libro = catalogo.find(l => l.titulo.toLowerCase().includes(query.toLowerCase()));
                if (libro) {
                    respuesta = await generarResumenConIA(libro);
                } else {
                    respuesta = 'No encontré el libro. Ej: "resumen El Quijote".';
                }
            } else if (mensajeLower.includes('meta')) { // IDEA 2
                const num = mensaje.match(/\d+/)?.[0];
                respuesta = manejarMetaLectura(num);
            } else if (mensajeLower.includes('secuencia')) { // IDEA 3
                const libro = mensaje.replace(/secuencia/gi, '').trim();
                const match = catalogo.find(l => l.titulo.toLowerCase().includes(libro.toLowerCase()));
                if (match) {
                    respuesta = obtenerSecuencia(match.titulo);
                } else {
                    respuesta = 'Ej: "secuencia Harry Potter".';
                }
            } else if (mensajeLower.includes('vota') || mensajeLower.includes('encuesta')) { // IDEA 4
                const partes = mensaje.split(' ');
                const pregunta = partes[1] || 'Género favorito';
                const opcion = partes[2] || 'Misterio';
                respuesta = manejarEncuesta(pregunta, opcion);
            } else if (mensajeLower.includes('flash')) { // IDEA 5
                const query = mensaje.replace(/flash/gi, '').trim();
                const libro = catalogo.find(l => l.titulo.toLowerCase().includes(query.toLowerCase()));
                if (libro) {
                    respuesta = generarFlashcard(libro);
                } else {
                    respuesta = 'Ej: "flash 1984".';
                }
            } else if (mensajeLower.includes('historia')) { // IDEA 6
                const continuacion = mensaje.replace(/historia/gi, '').trim();
                if (continuacion) {
                    respuesta = continuarHistoria(continuacion);
                } else {
                    respuesta = '¡Empecemos una historia! Di "historia El dragón voló sobre la biblioteca" para tu turno.';
                }
            } else if (mensajeLower.includes('huella')) { // IDEA 7
                respuesta = analizarHuellaLectora();
            } else if (mensajeLower.includes('multimedia')) { // IDEA 8
                const query = mensaje.replace(/multimedia/gi, '').trim();
                const libro = catalogo.find(l => l.titulo.toLowerCase().includes(query.toLowerCase()));
                if (libro) {
                    respuesta = obtenerMultimedia(libro);
                } else {
                    respuesta = 'Ej: "multimedia El Principito".';
                }
            } else {
                respuesta = `¡Interesante! Prueba con "ayuda" para guías, "busca [libro]" para consultas, "recomienda [mood]" para sugerencias o "mi perfil" para tu estado. Nuevas: "resumen [libro]", "meta 5", "secuencia [libro]", etc. ${evento}`;
            }

            setTimeout(() => agregarMensaje(respuesta, 'bot'), 800); // Delay para simular "pensando"
        }

        function agregarMensaje(texto, tipo) {
            const div = document.getElementById('chatMensajes');
            const p = document.createElement('p');
            p.className = `mensaje ${tipo}`;
            p.textContent = texto;
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        }

        function ordenarHistorial(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            currentPageHistorial = 1;
            showAdminTab('historial');
        }

        cargarDatos();
        const emailSesionGuardada = sessionStorage.getItem('emailSesion');
        if (emailSesionGuardada) {
            emailSesion = emailSesionGuardada;
            document.getElementById('adminBadge').style.display = emailSesion === EMAIL_ADMIN ? 'inline-block' : 'none';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('perfil').style.display = emailSesion === EMAIL_ADMIN ? 'none' : 'block';
            document.getElementById('busqueda').style.display = 'block';
            document.getElementById('chatbot').style.display = 'block';
            document.getElementById('adminHistorial').style.display = 'none';
            if (emailSesion === EMAIL_ADMIN) {
                updateNotificationBadge();
            }
            cargarPerfil();
            cargarCatalogo();
        }

        setTimeout(function() {
            const splash = document.getElementById('splash');
            splash.classList.add('hidden');
            setTimeout(function() { splash.remove(); }, 500);
        }, 3000);
    </script>
</body>
</html>