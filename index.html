<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HipatIA, la bibliotecaria virtual del IES Carpe Diem, te ayuda a encontrar libros, consultar sinopsis, hacer reservas y m√°s.">
    <meta name="keywords" content="biblioteca, libros, IES Carpe Diem, HipatIA, chatbot, reservas, sinopsis, recomendaciones">
    <meta name="author" content="IES Carpe Diem">
    <title>HipatIA - Bibliotecaria Virtual</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <style>
        :root {
            --primary: #5c6bc0;
            --primary-hover: #3f51b5;
            --text-primary: #333;
            --background: #f5f5f5;
            --card-background: #fff;
            --toast-success: #4caf50;
            --toast-error: #f44336;
            --toast-warning: #ff9800;
        }

        [data-theme="dark"] {
            --primary: #8c9eff;
            --primary-hover: #6b7280;
            --text-primary: #e0e0e0;
            --background: #121212;
            --card-background: #1e1e1e;
            --toast-success: #66bb6a;
            --toast-error: #ef5350;
            --toast-warning: #ffa726;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .splash.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash img {
            max-width: 150px;
            margin-bottom: 20px;
        }

        .splash h1 {
            color: white;
            font-size: 2.5rem;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        #seccionIzquierda,
        #seccionDerecha {
            flex: 1;
            min-width: 300px;
        }

        #seccionIzquierda {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background-color: var(--card-background);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-controls,
        .chat-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 10px;
            background-color: var(--card-background);
        }

        .mensaje {
            margin: 5px 0;
            padding: 5px;
            color: var(--text-primary);
            border-radius: 4px;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInMessage 0.3s ease-out forwards;
        }

        @keyframes fadeInMessage {
            to { opacity: 1; transform: translateY(0); }
        }

        .mensaje.user {
            text-align: right;
            background-color: var(--primary);
            color: white;
            margin-left: 20%;
            padding: 8px;
        }

        .mensaje.bot {
            text-align: left;
            background-color: #e0e0e0;
            margin-right: 20%;
            padding: 8px;
        }

        [data-theme="dark"] .mensaje.bot {
            background-color: #2e2e2e;
        }

        .mensaje.temporal {
            font-style: italic;
            color: #888;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .proseguir-btn,
        .buscar-btn,
        .reserva-btn,
        .solicitud-btn {
            margin-top: 5px;
            margin-right: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .libro-modal {
            margin: 10px 0;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .contenido-modal p {
            margin: 5px 0;
        }

        #searchPagination {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }

        #searchPagination button {
            padding: 5px 10px;
        }

        .tejuelo {
            padding: 2px 5px;
            border-radius: 3px;
            color: white;
        }

        .tejuelo[data-categoria="narrativa"] { background-color: #4caf50; }
        .tejuelo[data-categoria="poes√≠a"] { background-color: #ff9800; }
        .tejuelo[data-categoria="teatro"] { background-color: #2196f3; }
        .tejuelo[data-categoria="literatura inglesa"] { background-color: #9c27b0; }
        .tejuelo[data-categoria="enciclopedias"] { background-color: #607d8b; }
        .tejuelo[data-categoria="c√≥mic"] { background-color: #e91e63; }
        .tejuelo[data-categoria="deportes"] { background-color: #ff5722; }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            transition: all 0.3s;
        }

        .toast.success { background-color: var(--toast-success); }
        .toast.error { background-color: var(--toast-error); }
        .toast.warning { background-color: var(--toast-warning); }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .mensaje.user,
            .mensaje.bot {
                margin-left: 5%;
                margin-right: 5%;
            }
        }
    </style>
</head>
<body>
    <div id="splash" class="splash">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Hypatia_portrait.svg/1200px-Hypatia_portrait.svg.png" alt="Logo de HipatIA">
        <h1>HipatIA</h1>
    </div>
    <div id="app" style="display: none;">
        <header>
            <nav>
                <ul>
                    <li><strong>HipatIA - Bibliotecaria Virtual</strong></li>
                </ul>
                <ul>
                    <li><button class="btn" onclick="toggleTheme()">Cambiar Tema üåô</button></li>
                </ul>
            </nav>
        </header>
        <main class="container">
            <section id="seccionIzquierda">
                <div class="card">
                    <h2>Busca un libro</h2>
                    <div class="search-controls">
                        <input type="text" id="buscarInput" placeholder="T√≠tulo, autor, categor√≠a..." list="sugerenciasBusqueda" aria-label="Busca libros por t√≠tulo, autor o categor√≠a">
                        <datalist id="sugerenciasBusqueda"></datalist>
                        <button class="btn" onclick="mostrarResultadosBusqueda()">Buscar üîç</button>
                    </div>
                </div>
                <div class="card">
                    <h2>Acciones</h2>
                    <button class="btn" onclick="window.open('ENLACE_POR_DETERMINAR', '_blank')">Reserva de Libros üìö</button>
                    <button class="btn" onclick="window.open('ENLACE_POR_DETERMINAR', '_blank')">Solicitud de Libros Nuevos ‚ûï</button>
                </div>
            </section>
            <section id="seccionDerecha" style="display: none;">
                <div class="card">
                    <h2>Habla con HipatIA</h2>
                    <div class="chat-container" id="chatMensajes" role="log" aria-live="polite"></div>
                    <div class="chat-controls">
                        <input type="text" id="chatInput" placeholder="Libros, sinopsis, recomendaciones..." aria-label="Env√≠a un mensaje a la bibliotecaria virtual" onkeypress="if(event.key === 'Enter') enviarMensaje()" list="sugerenciasChat">
                        <datalist id="sugerenciasChat"></datalist>
                        <button class="btn" onclick="enviarMensaje()">Enviar üí¨</button>
                    </div>
                </div>
            </section>
        </main>
        <div id="searchModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal()" aria-label="Cerrar ventana de b√∫squeda">&times;</span>
                <h2>Resultados de B√∫squeda</h2>
                <div class="search-controls">
                    <input type="text" id="modalSearchInput" placeholder="T√≠tulo, autor, categor√≠a..." list="sugerenciasBusqueda" aria-label="Busca libros por t√≠tulo, autor o categor√≠a">
                    <button class="btn" onclick="buscarEnModal()">Buscar üîç</button>
                </div>
                <div id="conteoResultadosModal"></div>
                <div id="resultadosModal"></div>
                <div id="searchPagination"></div>
            </div>
        </div>
    </div>
    <script>
        let catalogo = [];
        let searchResults = [];
        let searchQuery = '';
        let currentPageSearch = 1;
        let toastCount = 0;
        let respuestasPendientes = {};
        let mensajeActualId = 0;
        let historialMensajes = [];
        let cacheRespuestas = {};
        let isFirstChatInteraction = true; // Bandera para la primera interacci√≥n del chatbot

        const API_KEY = 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg';
        const BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODELOS_A_PROBAR = [
            'gemini-2.5-flash',         // R√°pido y estable (2025)
            'gemini-2.5-pro',           // Potente
            'gemini-2.0-flash',         // Estable y multimodal
            'gemini-1.5-flash-latest',  // Legacy r√°pido
            'gemini-1.5-pro-latest'     // Legacy potente
        ];
        let MODELO_FUNCIONAL = null;

        function sanitizeHTML(str) {
            return DOMPurify.sanitize(str);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.bottom = `${20 + (toastCount * 60)}px`;
            toast.style.zIndex = 10000 + toastCount;
            toast.textContent = message;
            document.body.appendChild(toast);
            toastCount++;
            setTimeout(() => {
                toast.remove();
                toastCount--;
            }, 3000);
        }

        function toggleTheme() {
            const body = document.body;
            const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.body.setAttribute('data-theme', savedTheme);
        }

        function cerrarModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('buscarInput').focus();
            document.getElementById('modalSearchInput').value = '';
        }

        async function probarModelos() {
            const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas
            const cachedModel = localStorage.getItem('gemini_modelo_funcional');
            const lastTestTime = localStorage.getItem('gemini_modelo_test_time');
            const now = Date.now();

            // Probar modelo cacheado si existe y no ha expirado
            if (cachedModel && lastTestTime && now - lastTestTime < CACHE_DURATION) {
                try {
                    const response = await fetch(`${BASE_URL}${cachedModel}:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: 'Test' }], role: 'user' }] }),
                        signal: AbortController.signal
                    });
                    if (response.ok) {
                        MODELO_FUNCIONAL = cachedModel;
                        return true;
                    }
                } catch (error) {
                    console.warn(`Modelo almacenado ${cachedModel} no disponible: ${error.message}`);
                }
            }

            // Probar la lista de modelos
            for (const modelo of MODELOS_A_PROBAR) {
                try {
                    const response = await fetch(`${BASE_URL}${modelo}:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: 'Test' }], role: 'user' }] }),
                        signal: AbortController.signal
                    });
                    if (response.ok) {
                        MODELO_FUNCIONAL = modelo;
                        localStorage.setItem('gemini_modelo_funcional', modelo);
                        localStorage.setItem('gemini_modelo_test_time', now);
                        return true;
                    }
                } catch (error) {
                    console.warn(`Modelo ${modelo} no disponible: ${error.message}`);
                }
            }

            MODELO_FUNCIONAL = null;
            localStorage.removeItem('gemini_modelo_funcional');
            localStorage.removeItem('gemini_modelo_test_time');
            return false;
        }

        async function cargarCatalogo() {
            const MAX_RETRIES = 3;
            const RETRY_DELAY = 1000; // 1 segundo entre reintentos
            const cacheVersion = 'catalog-v1';
            const cachedCatalogo = localStorage.getItem('catalogo');
            const cachedVersion = localStorage.getItem('catalogoVersion');

            // Usar cat√°logo cacheado si est√° disponible y es v√°lido
            if (cachedCatalogo && cachedVersion === cacheVersion) {
                try {
                    catalogo = JSON.parse(cachedCatalogo);
                    actualizarSugerenciasBusqueda();
                    actualizarSugerenciasChat();
                    return;
                } catch (error) {
                    console.error('Error al parsear cat√°logo cacheado:', error);
                }
            }

            // Intentar cargar Ejemplares.xml con reintentos
            for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch('./Ejemplares.xml', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) throw new Error('Error al parsear XML.');

                    const libros = {};
                    Array.from(xmlDoc.getElementsByTagName('Libro')).forEach(libro => {
                        const idDocumento = libro.getAttribute('id_documento') || '';
                        const descriptor = libro.getElementsByTagName('Descriptor')[0];
                        const rawCategoria = descriptor ? descriptor.textContent : 'No disponible';
                        const categoriaMap = {
                            'narrativa': 'Narrativa',
                            'poesia': 'Poes√≠a',
                            'poes√≠a': 'Poes√≠a',
                            'teatro': 'Teatro',
                            'literatura inglesa': 'Literatura inglesa',
                            'enciclopedias': 'Enciclopedias',
                            'comic': 'C√≥mic',
                            'c√≥mic': 'C√≥mic',
                            'deportes': 'Deportes'
                        };
                        libros[idDocumento] = {
                            titulo: libro.getElementsByTagName('Titulo')[0]?.textContent || 'Sin t√≠tulo',
                            autor: libro.getElementsByTagName('Autor')[0]?.textContent || 'Desconocido',
                            categoria: categoriaMap[rawCategoria.toLowerCase()] || rawCategoria,
                            fechaEdicion: libro.getElementsByTagName('FechaEdicion')[0]?.textContent || 'No disponible'
                        };
                    });

                    const librosAgrupados = {};
                    Array.from(xmlDoc.getElementsByTagName('Ejemplar')).forEach(ejemplar => {
                        const idRegistro = ejemplar.getAttribute('IdRegistro') || '';
                        const libro = libros[idRegistro] || {};
                        let signatura1 = ejemplar.getAttribute('Signatura1') || '';
                        const signaturaMap = {
                            'Narrativa': 'N',
                            'Poes√≠a': 'P',
                            'Teatro': 'T',
                            'Literatura inglesa': 'LI',
                            'Enciclopedias': 'E',
                            'C√≥mic': 'C',
                            'Deportes': 'D'
                        };
                        signatura1 = signaturaMap[libro.categoria] || signatura1 || '';
                        const signatura = `${signatura1}-${ejemplar.getAttribute('Signatura2') || ''}-${ejemplar.getAttribute('Signatura3') || ''}`.trim();
                        if (!librosAgrupados[idRegistro]) {
                            librosAgrupados[idRegistro] = {
                                titulo: libro.titulo || 'Sin t√≠tulo',
                                autor: libro.autor || 'Desconocido',
                                categoria: libro.categoria || 'No disponible',
                                fechaEdicion: libro.fechaEdicion || 'No disponible',
                                signatura: signatura || 'No disponible',
                                isbn: ejemplar.getAttribute('ISBN') || 'No disponible',
                                fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                                copiasTotales: 0,
                                copiasDisponibles: 0,
                                idRegistro: idRegistro
                            };
                        }
                        librosAgrupados[idRegistro].copiasTotales += 1;
                        if (ejemplar.getAttribute('Estado') === '0') {
                            librosAgrupados[idRegistro].copiasDisponibles += 1;
                        }
                    });

                    catalogo = Object.values(librosAgrupados);
                    localStorage.setItem('catalogo', JSON.stringify(catalogo));
                    localStorage.setItem('catalogoVersion', cacheVersion);
                    actualizarSugerenciasBusqueda();
                    actualizarSugerenciasChat();
                    return;
                } catch (error) {
                    console.error(`Intento ${attempt} fallido al cargar cat√°logo:`, error);
                    if (attempt < MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                    } else {
                        console.error('Error al cargar cat√°logo tras reintentos:', error);
                        catalogo = [];
                        showToast('No se pudo cargar el cat√°logo. Puedes usar el chatbot, pero las respuestas ser√°n limitadas.', 'error');
                    }
                }
            }
        }

        function actualizarSugerenciasBusqueda() {
            document.getElementById('sugerenciasBusqueda').innerHTML = catalogo.map(libro => `
                <option value="${libro.titulo}">${libro.autor} - ${libro.categoria} (${libro.copiasDisponibles} disponibles)</option>
            `).join('');
        }

        function actualizarSugerenciasChat() {
            const sugerencias = [
                ...catalogo.map(libro => libro.titulo),
                'Sinopsis de un libro', 'Resumen de un libro', 'Rese√±a de un libro',
                'Recomendaciones de fantas√≠a', 'Recomendaciones de poes√≠a', 'C√≥mo reservar un libro',
                'Proponer un libro nuevo'
            ];
            document.getElementById('sugerenciasChat').innerHTML = sugerencias.map(sug => `<option value="${sug}">`).join('');
        }

        function normalizarTexto(texto) {
            if (!texto) return '';
            const acentos = { '√°': 'a', '√©': 'e', '√≠': 'i', '√≥': 'o', '√∫': 'u', '√Å': 'A', '√â': 'E', '√ç': 'I', '√ì': 'O', '√ö': 'U' };
            return texto
                .replace(/[√°√©√≠√≥√∫√Å√â√ç√ì√ö]/g, match => acentos[match] || match)
                .toLowerCase()
                .replace(/\s+/g, ' ')
                .trim();
        }

        function buscarLibros(query, exactMatch = false) {
            if (!catalogo.length || !query) return [];
            const lowerQuery = normalizarTexto(query);
            if (exactMatch) return catalogo.filter(libro => normalizarTexto(libro.titulo) === lowerQuery);
            return catalogo
                .filter(libro =>
                    normalizarTexto(libro.titulo).includes(lowerQuery) ||
                    normalizarTexto(libro.autor).includes(lowerQuery) ||
                    normalizarTexto(libro.categoria).includes(lowerQuery) ||
                    normalizarTexto(libro.signatura).includes(lowerQuery) ||
                    normalizarTexto(libro.isbn).includes(lowerQuery)
                )
                .sort((a, b) => b.copiasDisponibles - a.copiasDisponibles);
        }

        function realizarBusqueda(query, inputId) {
            if (!catalogo.length) {
                showToast('Cat√°logo en Mantenimiento, discupe las molestias.', 'warning');
                return;
            }
            if (!query) {
                showToast('Por favor, introduce un t√©rmino de b√∫squeda.', 'warning');
                return;
            }
            searchQuery = query;
            searchResults = buscarLibros(query);
            currentPageSearch = 1;
            abrirModal();
            mostrarResultadosModal();
            document.getElementById(inputId).value = query;
        }

        function mostrarResultadosBusqueda() {
            realizarBusqueda(document.getElementById('buscarInput').value.trim(), 'modalSearchInput');
        }

        function buscarEnModal() {
            realizarBusqueda(document.getElementById('modalSearchInput').value.trim(), 'modalSearchInput');
        }

        function abrirModal() {
            const modal = document.getElementById('searchModal');
            modal.style.display = 'block';
            document.getElementById('modalSearchInput').focus();
        }

        function mostrarResultadosModal() {
            const pageSize = 5;
            const totalPages = Math.ceil(searchResults.length / pageSize);
            const start = (currentPageSearch - 1) * pageSize;
            const end = start + pageSize;
            const paginatedResults = searchResults.slice(start, end);
            const conteoDiv = document.getElementById('conteoResultadosModal');
            const resultadosDiv = document.getElementById('resultadosModal');
            const paginationDiv = document.getElementById('searchPagination');
            const textoConteo = searchResults.length > 0
                ? `${searchResults.length} resultados para "${sanitizeHTML(searchQuery)}". El color del Tejuelo indica su estanter√≠a`
                : `No se encontraron resultados para "${sanitizeHTML(searchQuery)}".`;
            conteoDiv.innerHTML = `<p>${textoConteo}</p>`;
            resultadosDiv.innerHTML = paginatedResults.map(libro => `
                <div class="libro-modal" role="region" aria-label="Resultado de b√∫squeda para ${libro.titulo}">
                    <div class="contenido-modal">
                        <p><strong>T√≠tulo:</strong> ${libro.titulo}</p>
                        <p><strong>Autor:</strong> ${libro.autor}</p>
                        <p><strong>Categor√≠a:</strong> ${libro.categoria}</p>
                        <p><strong>Tejuelo:</strong> <span class="tejuelo" data-categoria="${libro.categoria.toLowerCase()}">${libro.signatura}</span></p>
                        <p><strong>Ejemplares Disponibles:</strong> ${libro.copiasDisponibles}</p>
                    </div>
                </div>
            `).join('') || '<p>No se encontraron libros en esta p√°gina.</p>';
            paginationDiv.innerHTML = `
                <button ${currentPageSearch === 1 ? 'disabled' : ''} onclick="changePageSearch(${currentPageSearch - 1})" aria-label="P√°gina anterior">&lt;</button>
                ${Array.from({ length: totalPages }, (_, i) => `
                    <button ${currentPageSearch === i + 1 ? 'disabled aria-current="page"' : ''} onclick="changePageSearch(${i + 1})" aria-label="Ir a p√°gina ${i + 1}">${i + 1}</button>
                `).join('')}
                <button ${currentPageSearch === totalPages ? 'disabled' : ''} onclick="changePageSearch(${currentPageSearch + 1})" aria-label="P√°gina siguiente">&gt;</button>
            `;
        }

        function changePageSearch(newPage) {
            currentPageSearch = newPage;
            mostrarResultadosModal();
        }

        async function consultarAPI(mensaje, intencion, contexto) {
            if (!MODELO_FUNCIONAL) {
                showToast('Ning√∫n modelo de IA disponible. Respuesta local generada.', 'warning');
                return { texto: 'No pude conectar con la IA. Intenta buscar en el cat√°logo o usa **Solicitud de Libros Nuevos**. ¬øOtro libro? üìñ', mostrarSolicitudBtn: true };
            }
            const systemPrompt = `Eres Hipat-IA, bibliotecaria virtual del IES Carpe Diem. Responde en espa√±ol, tono c√°lido y profesional, con emojis (üìñ, ‚ú®). Usa el cat√°logo para respuestas precisas.

**Cat√°logo** (m√°x. 5 resultados):
${contexto}

**Instrucciones**:
- **Sinopsis/Resumen/Rese√±a**: 400-700 palabras, usa el cat√°logo o conocimiento general. Termina con punto.
- **Reservas**: Menciona el bot√≥n **Reserva de Libros** y a√±ade [RESERVA].
- **Solicitar libro**: Menciona el bot√≥n **Solicitud de Libros Nuevos** y a√±ade [SOLICITUD].
- **General**: Responde en 400-700 palabras, clara y completa. Termina con punto.
- Termina con "¬øOtro libro?" o similar.`;
            const contents = [
                { parts: [{ text: systemPrompt }], role: 'model' },
                { parts: [{ text: mensaje }], role: 'user' }
            ];
            try {
                const response = await fetch(`${BASE_URL}${MODELO_FUNCIONAL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                const contenido = data.candidates[0].content.parts.map(part => part.text).join(' ');
                return {
                    texto: contenido,
                    mostrarReservaBtn: contenido.includes('[RESERVA]'),
                    mostrarSolicitudBtn: contenido.includes('[SOLICITUD]')
                };
            } catch (error) {
                showToast('No pude conectar con la API. Intenta de nuevo m√°s tarde.', 'error');
                return { texto: 'No pude conectar, int√©ntalo m√°s tarde. ¬øOtro libro? üìñ' };
            }
        }

        function extraerLibroDeConsulta(query) {
            const lowerQuery = normalizarTexto(query);
            const match = lowerQuery.match(/(?:de|sobre)\s+(.+)$/i);
            return match ? match[1].trim() : lowerQuery.replace(/(cuantos|ejemplares|copias|disponibles|libros)/gi, '').trim();
        }

        function abrirBuscadorLibro(libro) {
            searchQuery = libro;
            searchResults = buscarLibros(libro);
            currentPageSearch = 1;
            abrirModal();
            mostrarResultadosModal();
        }

        function dividirTexto(texto, tipo) {
            if (texto.length < 300) return [{ tipo, texto }];
            const maxLength = 500;
            const partes = [];
            let parteActual = '';
            let contadorPalabras = 0;
            const palabras = texto.split(' ');
            for (const palabra of palabras) {
                if (contadorPalabras + palabra.length > maxLength) {
                    partes.push({ tipo, texto: parteActual.trim() });
                    parteActual = palabra + ' ';
                    contadorPalabras = palabra.length + 1;
                } else {
                    parteActual += palabra + ' ';
                    contadorPalabras += palabra.length + 1;
                }
            }
            if (parteActual.trim()) partes.push({ tipo, texto: parteActual.trim() });
            return partes;
        }

        function mostrarSiguienteParte(mensajeId, parteActual) {
            const partes = respuestasPendientes[mensajeId];
            if (partes && parteActual <= partes.length) {
                const libroBuscado = partes[0].libroBuscado || null;
                const mostrarReservaBtn = partes[0].texto.includes('[RESERVA]');
                const mostrarSolicitudBtn = partes[0].texto.includes('[SOLICITUD]');
                agregarMensaje('', false, false, partes, mensajeId, parteActual, partes.length, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn);
            }
        }

        function agregarMensaje(texto, esUsuario = false, esTemporal = false, partes = null, mensajeId = null, parteActual = 1, totalPartes = 1, libroBuscado = null, mostrarReservaBtn = false, mostrarSolicitudBtn = false) {
            if (chatMensajes.children.length > 50) chatMensajes.removeChild(chatMensajes.firstChild);
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = `mensaje ${esUsuario ? 'user' : 'bot'}${esTemporal ? ' temporal' : ''}`;
            let mensajeTexto = esUsuario ? texto : texto;
            if (!esUsuario && !esTemporal && partes) {
                mensajeTexto = totalPartes > 1 
                    ? `**${partes[parteActual - 1].tipo.charAt(0).toUpperCase() + partes[parteActual - 1].tipo.slice(1)} (Parte ${parteActual}/${totalPartes})**:\n${partes[parteActual - 1].texto}`
                    : partes[0].texto;
            }
            mensajeDiv.innerHTML = esUsuario ? sanitizeHTML(mensajeTexto) : marked.parse(sanitizeHTML(mensajeTexto));
            if (!esUsuario && !esTemporal && totalPartes > 1 && parteActual < totalPartes) {
                const proseguirBtn = document.createElement('button');
                proseguirBtn.className = 'btn proseguir-btn';
                proseguirBtn.textContent = 'Proseguir';
                proseguirBtn.setAttribute('aria-label', `Mostrar parte ${parteActual + 1}`);
                proseguirBtn.onclick = () => mostrarSiguienteParte(mensajeId, parteActual + 1);
                mensajeDiv.appendChild(proseguirBtn);
                respuestasPendientes[mensajeId] = partes;
            }
            if (!esUsuario && !esTemporal) {
                if (libroBuscado) {
                    const buscarBtn = document.createElement('button');
                    buscarBtn.className = 'btn buscar-btn';
                    buscarBtn.textContent = 'Buscar';
                    buscarBtn.setAttribute('aria-label', `Buscar ${libroBuscado}`);
                    buscarBtn.onclick = () => abrirBuscadorLibro(libroBuscado);
                    mensajeDiv.appendChild(buscarBtn);
                }
                if (mostrarReservaBtn) {
                    const reservaBtn = document.createElement('button');
                    reservaBtn.className = 'btn reserva-btn';
                    reservaBtn.textContent = 'Reserva';
                    reservaBtn.setAttribute('aria-label', `Reservar libro`);
                    reservaBtn.onclick = () => window.open('ENLACE_POR_DETERMINAR', '_blank');
                    mensajeDiv.appendChild(reservaBtn);
                }
                if (mostrarSolicitudBtn) {
                    const solicitudBtn = document.createElement('button');
                    solicitudBtn.className = 'btn solicitud-btn';
                    solicitudBtn.textContent = 'Solicitar';
                    solicitudBtn.setAttribute('aria-label', `Solicitar libro nuevo`);
                    solicitudBtn.onclick = () => window.open('ENLACE_POR_DETERMINAR', '_blank');
                    mensajeDiv.appendChild(solicitudBtn);
                }
            }
            chatMensajes.appendChild(mensajeDiv);
            chatMensajes.scrollTop = chatMensajes.scrollHeight;
            if (!esTemporal) {
                historialMensajes.push({ role: esUsuario ? 'user' : 'assistant', content: texto });
                if (historialMensajes.length > 10) historialMensajes = historialMensajes.slice(-10);
            }
        }

        function formatearResultados(resultados, libroBuscado) {
            if (!resultados.length) {
                return {
                    texto: `No encontr√© "${libroBuscado}" en el cat√°logo. Usa el bot√≥n **Solicitud de Libros Nuevos** para proponerlo. ¬øQuieres abrir la ventana de b√∫squeda para ver otras opciones? üìñ`,
                    mostrarSolicitudBtn: true,
                    libroBuscado
                };
            }
            const libro = resultados[0];
            return {
                texto: `Hay ${libro.copiasTotales} ejemplares totales de "${libro.titulo}", de los cuales ${libro.copiasDisponibles} est√°n disponibles. Usa el bot√≥n **Reserva de Libros** para reservarlo. ¬øQuieres abrir la ventana de b√∫squeda para ver m√°s detalles? üìñ`,
                mostrarReservaBtn: true,
                libroBuscado
            };
        }

        function generarRecomendacion(intencion) {
            if (!catalogo.length) {
                return {
                    texto: 'El cat√°logo no est√° disponible ahora mismo. Usa el bot√≥n **Solicitud de Libros Nuevos** para proponer un libro. ¬øOtro g√©nero? üìñ',
                    libroBuscado: null,
                    mostrarSolicitudBtn: true
                };
            }
            let librosFiltrados = catalogo;
            let descripcion = '';
            const categoriaMap = {
                recomendacion_fantasia: { categoria: 'narrativa', desc: 'una emocionante obra de narrativa, ideal para amantes de la fantas√≠a y la aventura.' },
                recomendacion_poesia: { categoria: 'poesia', desc: 'un hermoso poemario que captura emociones profundas.' },
                recomendacion_narrativa: { categoria: 'narrativa', desc: 'una novela cautivadora que te sumergir√° en una gran historia.' },
                recomendacion_teatro: { categoria: 'teatro', desc: 'una obra teatral fascinante, llena de di√°logos y emociones.' },
                recomendacion_comic: { categoria: 'c√≥mic', desc: 'un c√≥mic vibrante con historias visuales emocionantes.' },
                recomendacion_literatura_inglesa: { categoria: 'literatura inglesa', desc: 'una obra en ingl√©s que destaca por su riqueza literaria.' },
                recomendacion_deportes: { categoria: 'deportes', desc: 'un libro apasionante sobre deportes, perfecto para entusiastas.' }
            };
            if (categoriaMap[intencion]) {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === categoriaMap[intencion].categoria);
                descripcion = categoriaMap[intencion].desc;
            } else {
                const categorias = ['Narrativa', 'Poes√≠a', 'Teatro', 'Literatura inglesa', 'Enciclopedias', 'C√≥mic', 'Deportes'];
                const categoriaAleatoria = categorias[Math.floor(Math.random() * categorias.length)];
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === normalizarTexto(categoriaAleatoria));
                descripcion = `una obra destacada de ${categoriaAleatoria.toLowerCase()}, perfecta para explorar algo nuevo.`;
            }
            if (librosFiltrados.length === 0) {
                return {
                    texto: `No encontr√© libros en esa categor√≠a en el cat√°logo. Usa el bot√≥n **Solicitud de Libros Nuevos** para proponer uno. ¬øOtro tipo de libro? üìñ`,
                    libroBuscado: null,
                    mostrarSolicitudBtn: true
                };
            }
            const libro = librosFiltrados[Math.floor(Math.random() * librosFiltrados.length)];
            const texto = `Te recomiendo *${libro.titulo}* de ${libro.autor} (${libro.categoria}). Es ${descripcion} Hay ${libro.copiasTotales} ejemplares totales, de los cuales ${libro.copiasDisponibles} est√°n disponibles. Usa el bot√≥n **Reserva de Libros** para reservarlo. ¬øQuieres abrir la ventana de b√∫squeda para ver m√°s detalles? üìñ`;
            return {
                texto,
                libroBuscado: libro.titulo,
                mostrarReservaBtn: true
            };
        }

        const intenciones = {
            ejemplares: ['cuantos', 'ejemplares', 'copias', 'disponibles', 'libros'],
            sinopsis: ['sinopsis'],
            resumen: ['resumen'],
            rese√±a: ['rese√±a', 'critica', 'opinion'],
            recomendaciones: ['recomendaciones', 'recomiendame', 'recomi√©ndame', 'sugerencias'],
            recomendacion_fantasia: ['fantasia', 'aventura'],
            recomendacion_poesia: ['poesia', 'poema'],
            recomendacion_narrativa: ['narrativa', 'novela'],
            recomendacion_teatro: ['teatro'],
            recomendacion_comic: ['comic', 'c√≥mic'],
            recomendacion_literatura_inglesa: ['literatura inglesa', 'libros en ingles', 'libros en ingl√©s'],
            recomendacion_deportes: ['deportes'],
            reservas: ['reservar', 'reserva'],
            solicitar: ['solicitar', 'proponer', 'nuevo libro']
        };

        const respuestasPredefinidas = {
            reservas: {
                texto: `Puedes reservar un libro usando el bot√≥n **Reserva de Libros**. ¬øQuieres buscar un libro espec√≠fico? üìñ`,
                mostrarReservaBtn: true
            },
            solicitar: {
                texto: `Puedes proponer un libro nuevo usando el bot√≥n **Solicitud de Libros Nuevos**. ¬øQu√© libro te gustar√≠a sugerir? üìñ`,
                mostrarSolicitudBtn: true
            }
        };

        function detectarIntencion(query) {
            const lowerQuery = normalizarTexto(query);
            for (const [intencion, palabras] of Object.entries(intenciones)) {
                if (palabras.some(palabra => lowerQuery.includes(palabra))) return intencion;
            }
            return 'general';
        }

        async function manejarIntencion(mensaje, intencion, mensajeId, cacheKey) {
            const escribiendoDiv = agregarMensaje('Hipat-IA est√° buscando en la estanter√≠a... üìö', false, true);
            
            if (respuestasPredefinidas[intencion]) {
                escribiendoDiv.remove();
                const { texto, mostrarReservaBtn = false, mostrarSolicitudBtn = false } = respuestasPredefinidas[intencion];
                cacheRespuestas[cacheKey] = { texto, timestamp: Date.now() };
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                const partes = dividirTexto(texto, intencion);
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, mostrarReservaBtn, mostrarSolicitudBtn);
                return;
            }

            if (intencion === 'ejemplares') {
                const libroBuscado = extraerLibroDeConsulta(mensaje);
                if (!libroBuscado) {
                    escribiendoDiv.remove();
                    const respuesta = 'No entend√≠ el t√≠tulo del libro. ¬øPuedes especificarlo, por ejemplo, "cu√°ntos ejemplares hay de La Colmena"? üìñ';
                    agregarMensaje(respuesta);
                    return;
                }
                const resultados = buscarLibros(libroBuscado, true);
                escribiendoDiv.remove();
                const { texto, mostrarReservaBtn, mostrarSolicitudBtn, libroBuscado: libro } = formatearResultados(resultados, libroBuscado);
                cacheRespuestas[cacheKey] = { texto, timestamp: Date.now() };
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                const partes = dividirTexto(texto, 'respuesta');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, libro, mostrarReservaBtn, mostrarSolicitudBtn);
                return;
            }

            if (intenciones[intencion] && intencion.startsWith('recomendacion')) {
                escribiendoDiv.remove();
                const { texto, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn } = generarRecomendacion(intencion);
                cacheRespuestas[cacheKey] = { texto, timestamp: Date.now() };
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                const partes = dividirTexto(texto, 'recomendacion');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn);
                return;
            }

            if (cacheRespuestas[cacheKey]) {
                escribiendoDiv.remove();
                const partes = dividirTexto(cacheRespuestas[cacheKey].texto, intencion);
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, cacheRespuestas[cacheKey].texto.includes('[RESERVA]'), cacheRespuestas[cacheKey].texto.includes('[SOLICITUD]'));
                return;
            }

            const resultadosCatalogo = buscarLibros(mensaje).slice(0, 5);
            const contexto = resultadosCatalogo.length > 0
                ? resultadosCatalogo.map(libro => `- **${libro.titulo}** (${libro.autor}, ${libro.categoria}, ${libro.copiasDisponibles} disponibles)`).join('\n')
                : 'Cat√°logo no disponible. Usa **Solicitud de Libros Nuevos**.';
            const { texto, mostrarReservaBtn, mostrarSolicitudBtn } = await consultarAPI(mensaje, intencion, contexto);
            escribiendoDiv.remove();
            cacheRespuestas[cacheKey] = { texto, timestamp: Date.now() };
            localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
            const partes = dividirTexto(texto, intencion);
            respuestasPendientes[mensajeId] = partes;
            agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, mostrarReservaBtn, mostrarSolicitudBtn);
        }

        async function enviarMensaje() {
            // Probar modelos en la primera interacci√≥n del chatbot
            if (isFirstChatInteraction) {
                showToast('Buscando un modelo de IA funcional...', 'warning');
                await probarModelos();
                isFirstChatInteraction = false;
                if (!MODELO_FUNCIONAL) {
                    showToast('No se encontr√≥ un modelo de IA funcional. Las respuestas ser√°n limitadas.', 'error');
                }
            }

            if (!catalogo.length) {
                showToast('El cat√°logo a√∫n est√° cargando o no est√° disponible. Intenta de nuevo en un momento.', 'warning');
                return;
            }

            const mensaje = sanitizeHTML(document.getElementById('chatInput').value.trim());
            if (!mensaje) {
                showToast('Por favor, escribe un mensaje.', 'warning');
                return;
            }

            agregarMensaje(mensaje, true);
            document.getElementById('chatInput').value = '';
            const intencion = detectarIntencion(mensaje);
            const cacheKey = `${intencion}_${normalizarTexto(mensaje)}`;
            const mensajeId = mensajeActualId++;
            await manejarIntencion(mensaje, intencion, mensajeId, cacheKey);
        }

        async function initApp() {
            const MIN_SPLASH_DURATION = 2000;
            const startTime = Date.now();
            // Limpiar solo el cach√© de respuestas, no el cat√°logo
            cacheRespuestas = {};
            localStorage.removeItem('hipatia_cache');
            loadTheme();
            await Promise.all([
                cargarCatalogo()
            ]);
            const elapsedTime = Date.now() - startTime;
            const remainingTime = MIN_SPLASH_DURATION - elapsedTime;
            if (remainingTime > 0) await new Promise(resolve => setTimeout(resolve, remainingTime));
            const splash = document.getElementById('splash');
            splash.classList.add('hidden');
            document.getElementById('app').style.display = 'block';
            document.getElementById('seccionDerecha').style.display = 'block';
            setTimeout(() => splash.remove(), 500);
            agregarMensaje('Libros, autores, sinopsis, res√∫menes... Mi magia es poderosa, pregunta. üìñ');
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('searchModal').style.display === 'block') {
                    cerrarModal();
                }
            });
        }

        initApp();
    </script>
</body>
</html>