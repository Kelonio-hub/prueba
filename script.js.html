<DOCUMENT filename="script.js.html">
// Cargar datos del catálogo (solo desde Catalogo.xml, con mejoras en parsing y manejo de errores)
let catalogo = [];
let paginaActual = 1;
const librosPorPagina = 10; // Para paginación en resultados

async function cargarCatalogo() {
    const resultadosDiv = document.getElementById('resultados');
    resultadosDiv.innerHTML = '<p>Cargando catálogo...</p>'; // Indicador de carga

    try {
        const response = await fetch('Catalogo.xml');
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} - No se pudo cargar Catalogo.xml`);
        }
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        // Verificar si hay errores de parseo
        if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
            throw new Error('Error al parsear el XML. Verifica el formato del archivo.');
        }

        // Extraer libros (usando child elements; robusto contra elementos faltantes)
        const libros = xmlDoc.getElementsByTagName('Libro');
        if (libros.length === 0) {
            throw new Error('No se encontraron elementos <Libro> en el XML.');
        }

        catalogo = Array.from(libros).map((libro, index) => {
            const titulo = libro.getElementsByTagName('Titulo')[0]?.textContent?.trim() || `Libro sin título ${index + 1}`;
            const autor = libro.getElementsByTagName('Autor')[0]?.textContent?.trim() || 'Desconocido';
            const categoria = libro.getElementsByTagName('Descriptor')[0]?.textContent?.trim() || 'No disponible';
            const registro = libro.getElementsByTagName('Registro')[0]?.textContent?.trim() || 'No disponible';
            const isbn = libro.getElementsByTagName('ISBN')[0]?.textContent?.trim() || 'No disponible';
            const fechaEdicion = libro.getElementsByTagName('FechaEdicion')[0]?.textContent?.trim() || 'No disponible';
            
            return {
                titulo,
                autor,
                categoria,
                registro,
                isbn,
                fechaEdicion,
                disponible: true // Asumimos disponible; para real, parsea <Estado> si lo agregas al XML
            };
        }).filter(libro => libro.titulo !== 'Sin título'); // Filtrar entradas inválidas
        
        console.log(`Catálogo cargado exitosamente: ${catalogo.length} libros.`); // Log mejorado
        
        if (catalogo.length === 0) {
            resultadosDiv.innerHTML = '<p>No se encontraron libros en el catálogo.</p>';
            return;
        }
        
        resultadosDiv.innerHTML = `<p>Catálogo cargado: ${catalogo.length} libros disponibles.</p>`;
    } catch (error) {
        console.error('Error al cargar catálogo:', error);
        resultadosDiv.innerHTML = `<p>Error al cargar el catálogo: ${error.message}. Intenta recargar la página.</p>`;
    }
}

// Búsqueda de libros (con debounce para performance y paginación)
function buscarLibros() {
    paginaActual = 1; // Resetear paginación
    if (!catalogo.length) {
        document.getElementById('resultados').innerHTML = '<p>El catálogo aún no se ha cargado. Intenta de nuevo en unos segundos.</p>';
        return;
    }
    const query = document.getElementById('buscarInput').value.toLowerCase().trim();
    if (!query) {
        mostrarResultados(catalogo.slice(0, librosPorPagina)); // Mostrar primeros si query vacío
        return;
    }
    const resultados = catalogo.filter(libro => 
        libro.titulo.toLowerCase().includes(query) ||
        libro.autor.toLowerCase().includes(query) ||
        libro.categoria.toLowerCase().includes(query) ||
        libro.isbn.toLowerCase().includes(query) ||
        libro.registro.toLowerCase().includes(query)
    );
    mostrarResultados(resultados);
}

// Mostrar resultados con paginación (mejorado con botones y sanitización básica)
function mostrarResultados(librosTotales) {
    const div = document.getElementById('resultados');
    const inicio = (paginaActual - 1) * librosPorPagina;
    const fin = inicio + librosPorPagina;
    const librosPagina = librosTotales.slice(inicio, fin);
    const totalPaginas = Math.ceil(librosTotales.length / librosPorPagina);

    if (librosTotales.length === 0) {
        div.innerHTML = '<p>No se encontraron libros.</p>';
        return;
    }

    let html = `<p>Mostrando ${inicio + 1}-${Math.min(fin, librosTotales.length)} de ${librosTotales.length} resultados.</p>`;
    html += librosPagina.map(libro => {
        // Sanitización básica: escapar HTML en campos (evita XSS)
        const esc = (str) => str.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[m]);
        return `
            <div class="libro">
                <h3>${esc(libro.titulo)}</h3>
                <p><strong>Autor:</strong> ${esc(libro.autor)}</p>
                <p><strong>Categoría:</strong> ${esc(libro.categoria)}</p>
                <p><strong>Registro:</strong> ${esc(libro.registro)}</p>
                <p><strong>ISBN:</strong> ${esc(libro.isbn)}</p>
                <p><strong>Fecha de Edición:</strong> ${esc(libro.fechaEdicion)}</p>
                <p><strong>Disponible:</strong> <span class="${libro.disponible ? 'estado-disponible' : 'estado-no-disponible'}">${libro.disponible ? 'Sí' : 'No'}</span></p>
            </div>
        `;
    }).join('');

    // Controles de paginación
    if (totalPaginas > 1) {
        html += '<div class="paginacion">';
        if (paginaActual > 1) html += `<button onclick="cambiarPagina(${paginaActual - 1})">Anterior</button>`;
        html += `<span>Página ${paginaActual} de ${totalPaginas}</span>`;
        if (paginaActual < totalPaginas) html += `<button onclick="cambiarPagina(${paginaActual + 1})">Siguiente</button>`;
        html += '</div>';
    }

    div.innerHTML = html;
}

function cambiarPagina(nuevaPagina) {
    paginaActual = nuevaPagina;
    // Re-ejecutar búsqueda para refrescar resultados paginados
    const query = document.getElementById('buscarInput').value.toLowerCase();
    if (query) {
        // Simular re-filtrado (puedes optimizar guardando resultados)
        buscarLibros();
    } else {
        mostrarResultados(catalogo);
    }
}

// Chatbot SIMULADO (mejorado: más keywords, conteo por categoría, conversaciones básicas)
async function enviarMensaje() {
    const input = document.getElementById('chatInput');
    const mensaje = input.value.trim();
    if (!mensaje) return;

    // Mostrar mensaje del usuario
    agregarMensaje(mensaje, 'user');
    input.value = '';

    // Simulación de respuesta con uso avanzado de catálogo
    let respuesta = '';
    const mensajeLower = mensaje.toLowerCase();

    // Búsqueda dinámica
    if (mensajeLower.includes('buscar') || mensajeLower.includes('libro') || mensajeLower.includes('encuentra')) {
        const query = mensajeLower.replace(/buscar|libro|encuentra/gi, '').trim();
        const resultadosChat = catalogo.filter(libro => 
            libro.titulo.toLowerCase().includes(query) || 
            libro.autor.toLowerCase().includes(query) ||
            libro.categoria.toLowerCase().includes(query)
        );
        if (resultadosChat.length > 0) {
            respuesta = `¡Encontré ${resultadosChat.length} resultado(s):\n`;
            resultadosChat.slice(0, 3).forEach(libro => {
                respuesta += `- "${libro.titulo}" de ${libro.autor} (${libro.categoria})\n`;
            });
            if (resultadosChat.length > 3) respuesta += '... Usa el buscador para más detalles.';
        } else {
            respuesta = 'No encontré nada con esa búsqueda. Prueba con "narrativa", "Harry Potter" o un autor como "Rowling".';
        }
    } 
    // Conteo por categoría
    else if (mensajeLower.includes('cuánt') || mensajeLower.includes('cuantos') || mensajeLower.includes('total')) {
        const total = catalogo.length;
        const narrativa = catalogo.filter(l => l.categoria.toLowerCase().includes('narrativa')).length;
        const comic = catalogo.filter(l => l.categoria.toLowerCase().includes('cómic')).length;
        respuesta = `En la Biblioteca Carpe Diem hay ${total} libros en total.\n- Narrativa: ${narrativa}\n- Cómics: ${comic}\n¿Qué más quieres saber?`;
    }
    // Recomendación mejorada
    else if (mensajeLower.includes('recomendación') || mensajeLower.includes('recomendar') || mensajeLower.includes('sugiere')) {
        let categoriaPref = 'narrativa'; // Default
        if (mensajeLower.includes('cómic') || mensajeLower.includes('comic')) categoriaPref = 'cómic';
        else if (mensajeLower.includes('poesía') || mensajeLower.includes('poesia')) categoriaPref = 'poesía';
        
        const recomendaciones = catalogo.filter(libro => 
            libro.categoria.toLowerCase().includes(categoriaPref)
        ).slice(0, 3);
        respuesta = `Te recomiendo estos de ${categoriaPref}:\n`;
        if (recomendaciones.length > 0) {
            recomendaciones.forEach(libro => {
                respuesta += `- "${libro.titulo}" de ${libro.autor}\n`;
            });
        } else {
            respuesta += 'No hay en esa categoría aún. Prueba "narrativa" o "cómic".';
        }
        respuesta += '\n¿Te gusta? ¿Otro género?';
    } 
    // Disponibilidad
    else if (mensajeLower.includes('disponible') || mensajeLower.includes('prestado')) {
        const disponibles = catalogo.filter(l => l.disponible).length;
        respuesta = `Actualmente, ${disponibles} de ${catalogo.length} libros están disponibles. Busca por título para detalles específicos.`;
    } 
    // Bienvenida o genérico
    else if (mensajeLower.includes('biblioteca') || mensajeLower.includes('hola')) {
        respuesta = '¡Hola! Soy el asistente de la Biblioteca Escolar Carpe Diem, Fuenlabrada. ¿Quieres buscar un libro, una recomendación o info del catálogo?';
    } 
    else {
        respuesta = `Entendido: "${mensaje}". Prueba "buscar Rowling", "recomendar cómic", "cuántos narrativa" o "disponible". ¿Qué buscas?`;
    }

    // Delay para simular procesamiento
    setTimeout(() => {
        agregarMensaje(respuesta, 'bot');
    }, 1000);
}

function agregarMensaje(texto, tipo) {
    const div = document.getElementById('chatMensajes');
    const p = document.createElement('p');
    p.className = `mensaje ${tipo}`;
    p.textContent = texto; // Sanitizado por textContent
    div.appendChild(p);
    div.scrollTop = div.scrollHeight;
}

// Inicializar al cargar la página
cargarCatalogo();

// Soporte para Enter y debounce en búsqueda (evita llamadas excesivas)
document.addEventListener('DOMContentLoaded', () => {
    const buscarInput = document.getElementById('buscarInput');
    const chatInput = document.getElementById('chatInput');
    
    buscarInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') buscarLibros();
    });
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') enviarMensaje();
    });
    
    // Debounce para búsqueda en tiempo real (opcional: activa si quieres live search)
    let timeout;
    buscarInput.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(buscarLibros, 300); // Espera 300ms tras tipear
    });
});
</DOCUMENT>